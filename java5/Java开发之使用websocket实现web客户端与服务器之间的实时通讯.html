<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Java开发之使用websocket实现web客户端与服务器之间的实时通讯' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Java开发之使用websocket实现web客户端与服务器之间的实时通讯</center></div><div class='banquan'>原文出处:本文由博客园博主zsq_fengchen提供。<br/>
原文连接:https://www.cnblogs.com/zhaosq/p/11804154.html</div><br>
    <p>使用websocket实现web客户端与服务器之间的实时通讯。以下是个简单的demo。</p>
<p>前端页面</p>
<src class="cnblogs_code">
<pre><code><span style="color: #008080;">  1</span> <span style="background-color: #ffff00; color: #000000;">&lt;%</span><span style="background-color: #f5f5f5; color: #000000;">@ page language</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">java</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #000000;"> contentType</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">text/html; charset=UTF-8</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #000000;"> pageEncoding</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">UTF-8</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #ffff00; color: #000000;">%&gt;</span>
<span style="color: #008080;">  2</span> <span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">  3</span> <span style="background-color: #ffff00; color: #000000;">&lt;%</span><span style="background-color: #f5f5f5; color: #000000;">@ taglib uri</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">http://java.sun.com/jsp/jstl/core</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #000000;">  prefix</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">c</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #ffff00; color: #000000;">%&gt;</span>
<span style="color: #008080;">  4</span> <span style="background-color: #ffff00; color: #000000;">&lt;%</span><span style="background-color: #f5f5f5; color: #000000;">@ taglib uri</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">http://java.sun.com/jsp/jstl/fmt</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #000000;">  prefix</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">fmt</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #ffff00; color: #000000;">%&gt;</span>
<span style="color: #008080;">  5</span> <span style="background-color: #ffff00; color: #000000;">&lt;%</span><span style="background-color: #f5f5f5; color: #000000;">@taglib uri</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">http://java.sun.com/jsp/jstl/functions</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #000000;"> prefix</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">fun</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #ffff00; color: #000000;">%&gt;</span>
<span style="color: #008080;">  6</span> <span style="background-color: #ffff00; color: #000000;">&lt;%</span><span style="background-color: #f5f5f5; color: #000000;">@ taglib prefix</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">fn</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #000000;"> uri</span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #f5f5f5; color: #800000;">http://java.sun.com/jsp/jstl/functions</span><span style="background-color: #f5f5f5; color: #800000;">"</span><span style="background-color: #ffff00; color: #000000;">%&gt;</span> 
<span style="color: #008080;">  7</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">c:set </span><span style="color: #ff0000;">var</span><span style="color: #0000ff;">="baseurl"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="${pageContext.request.contextPath}/"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">c:set</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">  8</span> 
<span style="color: #008080;">  9</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 10</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 11</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">meta </span><span style="color: #ff0000;">http-equiv</span><span style="color: #0000ff;">="Content-Type"</span><span style="color: #ff0000;"> content</span><span style="color: #0000ff;">="text/html; charset=UTF-8"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 12</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>web_socket<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 13</span> 
<span style="color: #008080;"> 14</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script </span><span style="color: #ff0000;">type</span><span style="color: #0000ff;">="text/javascript"</span><span style="color: #ff0000;"> src</span><span style="color: #0000ff;">="${baseurl}static/js/jquery-2.1.1.js"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 15</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">style </span><span style="color: #ff0000;">type</span><span style="color: #0000ff;">="text/css"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 16</span> <span style="background-color: #f5f5f5; color: #800000;">    .connector </span><span style="background-color: #f5f5f5; color: #000000;">{</span><span style="background-color: #f5f5f5; color: #ff0000;">width</span><span style="background-color: #f5f5f5; color: #000000;">:</span><span style="background-color: #f5f5f5; color: #0000ff;"> 500px</span><span style="background-color: #f5f5f5; color: #000000;">;</span><span style="background-color: #f5f5f5; color: #000000;">}</span>
<span style="color: #008080;"> 17</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">style</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 18</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 19</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 20</span> <span style="color: #000000;">    Welcome
</span><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">br</span><span style="color: #0000ff;">/&gt;</span>
<span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">input </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="text"</span><span style="color: #ff0000;"> type</span><span style="color: #0000ff;">="text"</span><span style="color: #0000ff;">/&gt;</span>
<span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">button </span><span style="color: #ff0000;">onclick</span><span style="color: #0000ff;">="sendToOne(10008)"</span><span style="color: #0000ff;">&gt;</span>发消息给个人<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">button</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">button </span><span style="color: #ff0000;">onclick</span><span style="color: #0000ff;">="sendToAll(0)"</span><span style="color: #0000ff;">&gt;</span>发消息给所有人<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">button</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">hr</span><span style="color: #0000ff;">/&gt;</span>
<span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">button </span><span style="color: #ff0000;">onclick</span><span style="color: #0000ff;">="closeWebSocket()"</span><span style="color: #0000ff;">&gt;</span>关闭WebSocket连接<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">button</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">hr</span><span style="color: #0000ff;">/&gt;</span>
<span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="message"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 29</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 30</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script </span><span style="color: #ff0000;">type</span><span style="color: #0000ff;">="text/javascript"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;"> 31</span>     <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> websocket </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">null</span><span style="background-color: #f5f5f5; color: #000000;">;
</span><span style="color: #008080;"> 32</span>     <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> host </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> document.location.host;
</span><span style="color: #008080;"> 33</span>     
<span style="color: #008080;"> 34</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">判断当前浏览器是否支持WebSocket</span>
<span style="color: #008080;"> 35</span>     <span style="background-color: #f5f5f5; color: #0000ff;">if</span><span style="background-color: #f5f5f5; color: #000000;"> (</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">WebSocket</span><span style="background-color: #f5f5f5; color: #000000;">'</span> <span style="background-color: #f5f5f5; color: #0000ff;">in</span><span style="background-color: #f5f5f5; color: #000000;"> window) {
</span><span style="color: #008080;"> 36</span> <span style="background-color: #f5f5f5; color: #000000;">        console.info(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">浏览器支持Websocket</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 37</span> <span style="background-color: #f5f5f5; color: #000000;">        websocket </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">new</span><span style="background-color: #f5f5f5; color: #000000;"> WebSocket(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">ws://</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">+</span><span style="background-color: #f5f5f5; color: #000000;">host</span><span style="background-color: #f5f5f5; color: #000000;">+</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">/${baseurl}/webSocketServer/${userID}</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 38</span> <span style="background-color: #f5f5f5; color: #000000;">    } </span><span style="background-color: #f5f5f5; color: #0000ff;">else</span><span style="background-color: #f5f5f5; color: #000000;"> {
</span><span style="color: #008080;"> 39</span> <span style="background-color: #f5f5f5; color: #000000;">        console.info(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">当前浏览器 Not support websocket</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 40</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 41</span>     
<span style="color: #008080;"> 42</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">连接发生错误的回调方法</span>
<span style="color: #008080;"> 43</span> <span style="background-color: #f5f5f5; color: #000000;">    websocket.onerror </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;">() {
</span><span style="color: #008080;"> 44</span> <span style="background-color: #f5f5f5; color: #000000;">        console.info(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">WebSocket连接发生错误</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 45</span> <span style="background-color: #f5f5f5; color: #000000;">        setMessageInnerHTML(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">WebSocket连接发生错误</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">); 
</span><span style="color: #008080;"> 46</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 47</span>     
<span style="color: #008080;"> 48</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">连接成功建立的回调方法</span>
<span style="color: #008080;"> 49</span> <span style="background-color: #f5f5f5; color: #000000;">    websocket.onopen </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;">() {
</span><span style="color: #008080;"> 50</span> <span style="background-color: #f5f5f5; color: #000000;">        console.info(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">WebSocket连接成功</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 51</span> <span style="background-color: #f5f5f5; color: #000000;">        setMessageInnerHTML(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">WebSocket连接成功</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">); 
</span><span style="color: #008080;"> 52</span> <span style="background-color: #f5f5f5; color: #000000;">    } 
</span><span style="color: #008080;"> 53</span>     
<span style="color: #008080;"> 54</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">接收到消息的回调方法 </span>
<span style="color: #008080;"> 55</span> <span style="background-color: #f5f5f5; color: #000000;">    websocket.onmessage </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;">(event) {
</span><span style="color: #008080;"> 56</span> <span style="background-color: #f5f5f5; color: #000000;">        console.info(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">接收到消息的回调方法</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 57</span> <span style="background-color: #f5f5f5; color: #000000;">        console.info(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">这是后台推送的消息：</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">+</span><span style="background-color: #f5f5f5; color: #000000;">event.data);
</span><span style="color: #008080;"> 58</span> <span style="background-color: #f5f5f5; color: #000000;">        setMessageInnerHTML(event.data); 
</span><span style="color: #008080;"> 59</span> <span style="background-color: #f5f5f5; color: #000000;">        console.info(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">webSocket已关闭！</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 60</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 61</span>     
<span style="color: #008080;"> 62</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">连接关闭的回调方法 </span>
<span style="color: #008080;"> 63</span> <span style="background-color: #f5f5f5; color: #000000;">    websocket.onclose </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;">() {
</span><span style="color: #008080;"> 64</span> <span style="background-color: #f5f5f5; color: #000000;">        setMessageInnerHTML(</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">WebSocket连接关闭</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">);
</span><span style="color: #008080;"> 65</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 66</span>     
<span style="color: #008080;"> 67</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span>
<span style="color: #008080;"> 68</span> <span style="background-color: #f5f5f5; color: #000000;">    window.onbeforeunload </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;">() {
</span><span style="color: #008080;"> 69</span> <span style="background-color: #f5f5f5; color: #000000;">        closeWebSocket();
</span><span style="color: #008080;"> 70</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 71</span>     
<span style="color: #008080;"> 72</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">关闭WebSocket连接 </span>
<span style="color: #008080;"> 73</span>     <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> closeWebSocket() {
</span><span style="color: #008080;"> 74</span> <span style="background-color: #f5f5f5; color: #000000;">        websocket.close();
</span><span style="color: #008080;"> 75</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 76</span>     
<span style="color: #008080;"> 77</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">将消息显示在网页上</span>
<span style="color: #008080;"> 78</span>     <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> setMessageInnerHTML(innerHTML) {
</span><span style="color: #008080;"> 79</span> <span style="background-color: #f5f5f5; color: #000000;">        document.getElementById(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">message</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">).innerHTML </span><span style="background-color: #f5f5f5; color: #000000;">+=</span><span style="background-color: #f5f5f5; color: #000000;"> innerHTML </span><span style="background-color: #f5f5f5; color: #000000;">+</span> <span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">&lt;br/&gt;</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">;
</span><span style="color: #008080;"> 80</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 81</span>     
<span style="color: #008080;"> 82</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">发送消息给其他客户端</span>
<span style="color: #008080;"> 83</span>     <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> sendToOne(receiverId) {
</span><span style="color: #008080;"> 84</span>         <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> messageContent </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> document.getElementById(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">text</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">).value;
</span><span style="color: #008080;"> 85</span>         <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> message </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> {};
</span><span style="color: #008080;"> 86</span> <span style="background-color: #f5f5f5; color: #000000;">        message.senderId </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">${userID}</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">;
</span><span style="color: #008080;"> 87</span> <span style="background-color: #f5f5f5; color: #000000;">        message.receiverId </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> receiverId;
</span><span style="color: #008080;"> 88</span> <span style="background-color: #f5f5f5; color: #000000;">        message.messageContent </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> messageContent;
</span><span style="color: #008080;"> 89</span> <span style="background-color: #f5f5f5; color: #000000;">        websocket.send(JSON.stringify(message));
</span><span style="color: #008080;"> 90</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;"> 91</span>     
<span style="color: #008080;"> 92</span>     <span style="background-color: #f5f5f5; color: #008000;">//</span><span style="background-color: #f5f5f5; color: #008000;">发送消息给所有人</span>
<span style="color: #008080;"> 93</span>     <span style="background-color: #f5f5f5; color: #0000ff;">function</span><span style="background-color: #f5f5f5; color: #000000;"> sendToAll() {
</span><span style="color: #008080;"> 94</span>         <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> messageContent </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> document.getElementById(</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">text</span><span style="background-color: #f5f5f5; color: #000000;">'</span><span style="background-color: #f5f5f5; color: #000000;">).value;
</span><span style="color: #008080;"> 95</span>         <span style="background-color: #f5f5f5; color: #0000ff;">var</span><span style="background-color: #f5f5f5; color: #000000;"> message </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> {};
</span><span style="color: #008080;"> 96</span> <span style="background-color: #f5f5f5; color: #000000;">        message.senderId </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">${userID}</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">;
</span><span style="color: #008080;"> 97</span> <span style="background-color: #f5f5f5; color: #000000;">        message.receiverId </span><span style="background-color: #f5f5f5; color: #000000;">=</span> <span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">0</span><span style="background-color: #f5f5f5; color: #000000;">"</span><span style="background-color: #f5f5f5; color: #000000;">;
</span><span style="color: #008080;"> 98</span> <span style="background-color: #f5f5f5; color: #000000;">        message.messageContent </span><span style="background-color: #f5f5f5; color: #000000;">=</span><span style="background-color: #f5f5f5; color: #000000;"> messageContent;
</span><span style="color: #008080;"> 99</span> <span style="background-color: #f5f5f5; color: #000000;">        websocket.send(JSON.stringify(message));
</span><span style="color: #008080;">100</span> <span style="background-color: #f5f5f5; color: #000000;">    }
</span><span style="color: #008080;">101</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">102</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>后台代码</p>
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Date;
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> WebSocketMessage {
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 6</span> <span style="color: #008000;">     * 发送者ID
</span><span style="color: #008080;"> 7</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String senderId;
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;">11</span> <span style="color: #008000;">     * 接受者ID, 如果为0, 则发送给所有人
</span><span style="color: #008080;">12</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String receiverId;
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;">16</span> <span style="color: #008000;">     * 会话内容
</span><span style="color: #008080;">17</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String messageContent;
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;">21</span> <span style="color: #008000;">     * 发送时间
</span><span style="color: #008080;">22</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;">23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Date sendTime;
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getSenderId() {
</span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> senderId;
</span><span style="color: #008080;">27</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">28</span> 
<span style="color: #008080;">29</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setSenderId(String senderId) {
</span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">this</span>.senderId =<span style="color: #000000;"> senderId;
</span><span style="color: #008080;">31</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">32</span> 
<span style="color: #008080;">33</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getReceiverId() {
</span><span style="color: #008080;">34</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> receiverId;
</span><span style="color: #008080;">35</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setReceiverId(String receiverId) {
</span><span style="color: #008080;">38</span>         <span style="color: #0000ff;">this</span>.receiverId =<span style="color: #000000;"> receiverId;
</span><span style="color: #008080;">39</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">40</span> 
<span style="color: #008080;">41</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getMessageContent() {
</span><span style="color: #008080;">42</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> messageContent;
</span><span style="color: #008080;">43</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setMessageContent(String messageContent) {
</span><span style="color: #008080;">46</span>         <span style="color: #0000ff;">this</span>.messageContent =<span style="color: #000000;"> messageContent;
</span><span style="color: #008080;">47</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">48</span> 
<span style="color: #008080;">49</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Date getSendTime() {
</span><span style="color: #008080;">50</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> sendTime;
</span><span style="color: #008080;">51</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setSendTime(Date sendTime) {
</span><span style="color: #008080;">54</span>         <span style="color: #0000ff;">this</span>.sendTime =<span style="color: #000000;"> sendTime;
</span><span style="color: #008080;">55</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">56</span> 
<span style="color: #008080;">57</span> }</code></pre>

<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.http.HttpServletResponse;
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.stereotype.Controller;
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.PathVariable;
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.RequestMapping;
</span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.servlet.ModelAndView;
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span> <span style="color: #000000;">@Controller
</span><span style="color: #008080;"> 9</span> @RequestMapping("webSocket"<span style="color: #000000;">)
</span><span style="color: #008080;">10</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> WebSocketController {
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span>     @RequestMapping(value = "messagePage/{userID}"<span style="color: #000000;">)
</span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ModelAndView messagePage(@PathVariable String userID, HttpServletResponse response) {
</span><span style="color: #008080;">14</span>         ModelAndView mav = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ModelAndView();
</span><span style="color: #008080;">15</span>         mav.addObject("userID"<span style="color: #000000;">, userID);
</span><span style="color: #008080;">16</span>         mav.setViewName("web_socket"<span style="color: #000000;">);
</span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mav;
</span><span style="color: #008080;">18</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">19</span> }</code></pre>

<src class="cnblogs_code">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;
</span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;
</span><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ConcurrentHashMap;
</span><span style="color: #008080;">  4</span> 
<span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.websocket.OnClose;
</span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.websocket.OnError;
</span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.websocket.OnMessage;
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.websocket.OnOpen;
</span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.websocket.Session;
</span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.websocket.server.PathParam;
</span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.websocket.server.ServerEndpoint;
</span><span style="color: #008080;"> 12</span> 
<span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.alibaba.fastjson.JSON;
</span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.utime.facade.model.systemplate.WebSocketMessage;
</span><span style="color: #008080;"> 15</span> 
<span style="color: #008080;"> 16</span> @ServerEndpoint("/webSocketServer/{userID}"<span style="color: #000000;">)
</span><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> WebSocketServer {
</span><span style="color: #008080;"> 18</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 连接客户端数量</span>
<span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> onlineCount = 0<span style="color: #000000;">;
</span><span style="color: #008080;"> 20</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 所有的连接客户端</span>
<span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Map&lt;String, WebSocketServer&gt; clients = <span style="color: #0000ff;">new</span> ConcurrentHashMap&lt;String, WebSocketServer&gt;<span style="color: #000000;">();
</span><span style="color: #008080;"> 22</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 当前客户端连接的唯一标示</span>
<span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Session session;
</span><span style="color: #008080;"> 24</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 当前客户端连接的用户ID</span>
<span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String userID;
</span><span style="color: #008080;"> 26</span> 
<span style="color: #008080;"> 27</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 28</span> <span style="color: #008000;">     * 客户端连接服务端回调函数
</span><span style="color: #008080;"> 29</span> <span style="color: #008000;">     * 
</span><span style="color: #008080;"> 30</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> userID 用户ID
</span><span style="color: #008080;"> 31</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> session 会话
</span><span style="color: #008080;"> 32</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IOException
</span><span style="color: #008080;"> 33</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 34</span> <span style="color: #000000;">    @OnOpen
</span><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onOpen(@PathParam("userID") String userID, Session session) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">this</span>.userID =<span style="color: #000000;"> userID;
</span><span style="color: #008080;"> 37</span>         <span style="color: #0000ff;">this</span>.session =<span style="color: #000000;"> session;
</span><span style="color: #008080;"> 38</span> 
<span style="color: #008080;"> 39</span> <span style="color: #000000;">        addOnlineCount();
</span><span style="color: #008080;"> 40</span>         clients.put(userID, <span style="color: #0000ff;">this</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 41</span>         System.out.println("WebSocket日志: 有新连接加入！当前在线人数为" +<span style="color: #000000;"> getOnlineCount());
</span><span style="color: #008080;"> 42</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 43</span> 
<span style="color: #008080;"> 44</span> <span style="color: #000000;">    @OnClose
</span><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClose() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;"> 46</span> <span style="color: #000000;">        clients.remove(userID);
</span><span style="color: #008080;"> 47</span> <span style="color: #000000;">        subOnlineCount();
</span><span style="color: #008080;"> 48</span>         System.out.println("WebSocket日志: 有一连接关闭！当前在线人数为" +<span style="color: #000000;"> getOnlineCount());
</span><span style="color: #008080;"> 49</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 50</span> 
<span style="color: #008080;"> 51</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 52</span> <span style="color: #008000;">     * 接受到来自客户端的消息
</span><span style="color: #008080;"> 53</span> <span style="color: #008000;">     * 
</span><span style="color: #008080;"> 54</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> message
</span><span style="color: #008080;"> 55</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IOException
</span><span style="color: #008080;"> 56</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 57</span> <span style="color: #000000;">    @OnMessage
</span><span style="color: #008080;"> 58</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onMessage(String message) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;"> 59</span>         System.out.println("WebSocket日志: 来自客户端的消息:" +<span style="color: #000000;"> message);
</span><span style="color: #008080;"> 60</span>         WebSocketMessage webSocketMessage = JSON.parseObject(message, WebSocketMessage.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 61</span> 
<span style="color: #008080;"> 62</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 发送消息给所有客户端</span>
<span style="color: #008080;"> 63</span>         <span style="color: #0000ff;">if</span> ("0"<span style="color: #000000;">.equals(webSocketMessage.getReceiverId())) {
</span><span style="color: #008080;"> 64</span>             <span style="color: #0000ff;">for</span><span style="color: #000000;"> (WebSocketServer item : clients.values()) {
</span><span style="color: #008080;"> 65</span> <span style="color: #000000;">                item.session.getAsyncRemote().sendText(webSocketMessage.getMessageContent());
</span><span style="color: #008080;"> 66</span>                 System.out.println("WebSocket日志: ID为"+ webSocketMessage.getSenderId() +"的用户给ID为"+ item.userID +"的客户端发送:" +<span style="color: #000000;"> webSocketMessage.getMessageContent());
</span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 68</span>         } <span style="color: #0000ff;">else</span> {    <span style="color: #008000;">//</span><span style="color: #008000;"> 发送消息给指定ID的客户端</span>
<span style="color: #008080;"> 69</span>             <span style="color: #0000ff;">for</span><span style="color: #000000;"> (WebSocketServer item : clients.values()) {
</span><span style="color: #008080;"> 70</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (item.userID.equals(webSocketMessage.getReceiverId())){
</span><span style="color: #008080;"> 71</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 发消息给指定客户端</span>
<span style="color: #008080;"> 72</span> <span style="color: #000000;">                    item.session.getAsyncRemote().sendText(webSocketMessage.getMessageContent());
</span><span style="color: #008080;"> 73</span>                     System.out.println("WebSocket日志: ID为"+ webSocketMessage.getSenderId() +"的用户给ID为"+ item.userID +"的客户端发送:" +<span style="color: #000000;"> webSocketMessage.getMessageContent());
</span><span style="color: #008080;"> 74</span>                     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">webSocketMessage.getSenderId().equals(webSocketMessage.getReceiverId())) {
</span><span style="color: #008080;"> 75</span>                         <span style="color: #008000;">//</span><span style="color: #008000;"> 发消息给自己</span>
<span style="color: #008080;"> 76</span>                         <span style="color: #0000ff;">this</span><span style="color: #000000;">.session.getAsyncRemote().sendText(webSocketMessage.getMessageContent());
</span><span style="color: #008080;"> 77</span>                         System.out.println("WebSocket日志: ID为"+ webSocketMessage.getSenderId() +"的用户给ID为"+ <span style="color: #0000ff;">this</span>.userID +"的客户端发送:" +<span style="color: #000000;"> webSocketMessage.getMessageContent());
</span><span style="color: #008080;"> 78</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;"> 79</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 80</span> <span style="color: #000000;">                }
</span><span style="color: #008080;"> 81</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 83</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 84</span>     
<span style="color: #008080;"> 85</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 86</span> <span style="color: #008000;">     * 服务端报错了
</span><span style="color: #008080;"> 87</span> <span style="color: #008000;">     * 
</span><span style="color: #008080;"> 88</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> session
</span><span style="color: #008080;"> 89</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> error
</span><span style="color: #008080;"> 90</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 91</span> <span style="color: #000000;">    @OnError
</span><span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onError(Session session, Throwable error) {
</span><span style="color: #008080;"> 93</span>         System.out.println("WebSocket日志: 发生错误"<span style="color: #000000;">);
</span><span style="color: #008080;"> 94</span> <span style="color: #000000;">        error.printStackTrace();
</span><span style="color: #008080;"> 95</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 96</span>     
<span style="color: #008080;"> 97</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 98</span> <span style="color: #008000;">     * 客户端连接数+1
</span><span style="color: #008080;"> 99</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;">100</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addOnlineCount() {
</span><span style="color: #008080;">101</span>         WebSocketServer.onlineCount++<span style="color: #000000;">;
</span><span style="color: #008080;">102</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">103</span>     
<span style="color: #008080;">104</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;">105</span> <span style="color: #008000;">     * 客户端连接数-1
</span><span style="color: #008080;">106</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;">107</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> subOnlineCount() {
</span><span style="color: #008080;">108</span>         WebSocketServer.onlineCount--<span style="color: #000000;">;
</span><span style="color: #008080;">109</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">110</span> 
<span style="color: #008080;">111</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getOnlineCount() {
</span><span style="color: #008080;">112</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> onlineCount;
</span><span style="color: #008080;">113</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">114</span> 
<span style="color: #008080;">115</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">synchronized</span> Map&lt;String, WebSocketServer&gt;<span style="color: #000000;"> getClients() {
</span><span style="color: #008080;">116</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> clients;
</span><span style="color: #008080;">117</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">118</span> }</code></pre>

<p>写这个的目的只是为了自己做个记录。</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>