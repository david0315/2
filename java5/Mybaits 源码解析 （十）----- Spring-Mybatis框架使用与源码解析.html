<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Mybaits 源码解析 （十）----- Spring-Mybatis框架使用与源码解析' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Mybaits 源码解析 （十）----- Spring-Mybatis框架使用与源码解析</center></div><div class='banquan'>原文出处:本文由博客园博主chen_hao提供。<br/>
原文连接:https://www.cnblogs.com/java-chen-hao/p/11833780.html</div><br>
    <p>在前面几篇文章中我们主要分析了Mybatis的单独使用，在实际在常规项目开发中，大部分都会使用mybatis与Spring结合起来使用，毕竟现在不用Spring开发的项目实在太少了。本篇文章便来介绍下Mybatis如何与Spring结合起来使用，并介绍下其源码是如何实现的。</p>
<h2>Spring-Mybatis使用</h2>
<h3>添加maven依赖</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-jdbc<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>4.3.8.RELEASE<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> https://mvnrepository.com/artifact/org.mybatis/mybatis-spring </span><span style="color: #008000;">--&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.mybatis<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>mybatis-spring<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.3.2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>在src/main/resources下添加mybatis-config.xml文件</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">configuration</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">typeAliases</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">typeAlias </span><span style="color: #ff0000;">alias</span><span style="color: #0000ff;">="User"</span><span style="color: #ff0000;"> type</span><span style="color: #0000ff;">="com.chenhao.bean.User"</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">typeAliases</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">plugins</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">plugin </span><span style="color: #ff0000;">interceptor</span><span style="color: #0000ff;">="com.github.pagehelper.PageInterceptor"</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="helperDialect"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="mysql"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">plugin</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">plugins</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">configuration</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>在src/main/resources/mapper路径下添加User.xml</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span style="color: #0000ff;">&gt;</span>
    
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">mapper </span><span style="color: #ff0000;">namespace</span><span style="color: #0000ff;">="com.chenhao.mapper.UserMapper"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">select </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="getUser"</span><span style="color: #ff0000;"> parameterType</span><span style="color: #0000ff;">="int"</span><span style="color: #ff0000;">
        resultType</span><span style="color: #0000ff;">="com.chenhao.bean.User"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
        SELECT *
        FROM USER
        WHERE id = #{id}
    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">select</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">mapper</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>在src/main/resources/路径下添加beans.xml</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">beans </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://www.springframework.org/schema/beans"</span><span style="color: #ff0000;">
    xmlns:xsi</span><span style="color: #0000ff;">="http://www.w3.org/2001/XMLSchema-instance"</span><span style="color: #ff0000;">
    xsi:schemaLocation</span><span style="color: #0000ff;">="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span style="color: #0000ff;">&gt;</span>
 
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.springframework.jdbc.datasource.DriverManagerDataSource"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="driverClassName"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="com.mysql.jdbc.Driver"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="url"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="jdbc:mysql://127.0.0.1:3306/test"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="username"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="root"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="password"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="root"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>
 
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="sqlSessionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.mybatis.spring.SqlSessionFactoryBean"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="configLocation"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mybatis-config.xml"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="dataSource"</span> <span style="color: #0000ff;">/&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="mapperLocations"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mapper/*.xml"</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>
    
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="basePackage"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="com.chenhao.mapper"</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>
 
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">beans</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>注解的方式</h3>
<ul>
<li>以上分析都是在spring的XML配置文件applicationContext.xml进行配置的，mybatis-spring也提供了基于注解的方式来配置sqlSessionFactory和Mapper接口。</li>
<li>sqlSessionFactory主要是在@Configuration注解的配置类中使用@Bean注解的名为sqlSessionFactory的方法来配置；</li>
<li>Mapper接口主要是通过在@Configuration注解的配置类中结合@MapperScan注解来指定需要扫描获取mapper接口的包。</li>
</ul>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@Configuration
@MapperScan(</span>"com.chenhao.mapper"<span style="color: #000000;">)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> AppConfig {

  @Bean
  </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> DataSource dataSource() {
     </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> EmbeddedDatabaseBuilder()
            .addScript(</span>"schema.sql"<span style="color: #000000;">)
            .build();
  }
 
  @Bean
  </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> DataSourceTransactionManager transactionManager() {
    </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> DataSourceTransactionManager(dataSource());
  }
 
  @Bean
  </span><span style="color: #0000ff;">public</span> SqlSessionFactory sqlSessionFactory() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
    </span><strong><span style="color: #008000;">//</span><span style="color: #008000;">创建SqlSessionFactoryBean对象</span>
    SqlSessionFactoryBean sessionFactory = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlSessionFactoryBean();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">设置数据源</span>
<span style="color: #000000;">    sessionFactory.setDataSource(dataSource());
    </span><span style="color: #008000;">//</span><span style="color: #008000;">设置Mapper.xml路径</span>
    sessionFactory.setMapperLocations(<span style="color: #0000ff;">new</span> PathMatchingResourcePatternResolver().getResources("classpath:mapper/*.xml"<span style="color: #000000;">));
    </span></strong><span style="color: #008000;">//</span><span style="color: #008000;"> 设置MyBatis分页插件</span>
    PageInterceptor pageInterceptor = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PageInterceptor();
    Properties properties </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Properties();
    properties.setProperty(</span>"helperDialect", "mysql"<span style="color: #000000;">);
    pageInterceptor.setProperties(properties);
    sessionFactory.setPlugins(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Interceptor[]{pageInterceptor});
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> sessionFactory.getObject();
  }
}</span></code></pre>

<h2>对照Spring-Mybatis的方式，也就是对照beans.xml文件来看</h2>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="sqlSessionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.mybatis.spring.SqlSessionFactoryBean"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="configLocation"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mybatis-config.xml"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="dataSource"</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="mapperLocations"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mapper/*.xml"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>就对应着SqlSessionFactory的生成，类似于原生Mybatis使用时的以下代码</p>
<src class="cnblogs_code">
<pre><code>SqlSessionFactory sqlSessionFactory = <span style="color: #0000ff;">new</span> SqlSessionFactoryBuilder().build( Resources.getResourceAsStream("mybatis-config.xml"));</code></pre>

<p>而UserMapper代理对象的获取，是通过扫描的形式获取，也就是<strong>MapperScannerConfigurer</strong>这个类</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="basePackage"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="com.chenhao.mapper"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>对应着Mapper接口的获取，类似于原生Mybatis使用时的以下代码：</p>
<src class="cnblogs_code">
<pre><code>SqlSession session =<span style="color: #000000;"> sqlSessionFactory.openSession();
UserMapper mapper </span>= session.getMapper(UserMapper.<span style="color: #0000ff;">class</span>);</code></pre>

<p>接着我们就可以在Service中直接从Spring的BeanFactory中获取了，如下</p>
<p><img src="./images/Mybaits 源码解析 （十）----- Spring-Mybatis框架使用与源码解析0.png" alt="" /></p>
<p><strong>所以我们现在就主要分析下在Spring中是如何生成SqlSessionFactory和Mapper接口的</strong></p>
<h2 class="title-article">SqlSessionFactoryBean的设计与实现</h2>
<h3>大体思路</h3>
<ul>
<li>mybatis-spring为了实现spring对mybatis的整合，即将mybatis的相关组件作为spring的IOC容器的bean来管理，使用了spring的FactoryBean接口来对mybatis的相关组件进行包装。spring的IOC容器在启动加载时，如果发现某个bean实现了FactoryBean接口，则会调用该bean的getObject方法，获取实际的bean对象注册到IOC容器，其中FactoryBean接口提供了getObject方法的声明，从而统一spring的IOC容器的行为。</li>
<li>SqlSessionFactory作为mybatis的启动组件，在mybatis-spring中提供了SqlSessionFactoryBean来进行包装，所以在spring项目中整合mybatis，首先需要在spring的配置，如XML配置文件applicationContext.xml中，配置SqlSessionFactoryBean来引入SqlSessionFactory，即在spring项目启动时能加载并创建SqlSessionFactory对象，然后注册到spring的IOC容器中，从而可以直接在应用代码中注入使用或者作为属性，注入到mybatis的其他组件对应的bean对象。在applicationContext.xml的配置如下：</li>
</ul>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="sqlSessionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.mybatis.spring.SqlSessionFactoryBean"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
       // 数据源
       </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="dataSource"</span> <span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
       // mapper.xml的资源文件,也就是SQL文件
       </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="mapperLocations"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mybatis/mapper/**/*.xml"</span> <span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
       //mybatis配置mybatisConfig.xml的资源文件
       </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="configLocation"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mybatis/mybitas-config.xml"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>接口设计与实现</h3>
<p>SqlSessionFactory的接口设计如下：实现了spring提供的<strong>FactoryBean，InitializingBean和ApplicationListener这三个接口，在内部封装了mybatis的相关组件作为内部属性，如mybatisConfig.xml配置资源文件引用，mapper.xml配置资源文件引用，以及SqlSessionFactoryBuilder构造器和SqlSessionFactory引用。</strong></p>
<src class="cnblogs_code">
<pre><code><span style="color: #008000;">//</span><span style="color: #008000;"> 解析mybatisConfig.xml文件和mapper.xml，设置数据源和所使用的事务管理机制，将这些封装到Configuration对象
</span><span style="color: #008000;">//</span><span style="color: #008000;"> 使用Configuration对象作为构造参数，创建SqlSessionFactory对象，其中SqlSessionFactory为单例bean，最后将SqlSessionFactory单例对象注册到spring容器。</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SqlSessionFactoryBean <span style="color: #0000ff;">implements</span> FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt;<span style="color: #000000;"> {

  </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Logger LOGGER = LoggerFactory.getLogger(SqlSessionFactoryBean.<span style="color: #0000ff;">class</span><span style="color: #000000;">);

  </span><span style="color: #008000;">//</span><span style="color: #008000;"> mybatis配置mybatisConfig.xml的资源文件</span>
  <span style="color: #0000ff;">private</span><span style="color: #000000;"> Resource configLocation;

  </span><span style="color: #008000;">//</span><span style="color: #008000;">解析完mybatisConfig.xml后生成Configuration对象</span>
  <span style="color: #0000ff;">private</span><span style="color: #000000;"> Configuration configuration;

  </span><span style="color: #008000;">//</span><span style="color: #008000;"> mapper.xml的资源文件</span>
  <span style="color: #0000ff;">private</span><span style="color: #000000;"> Resource[] mapperLocations;

  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 数据源</span>
  <span style="color: #0000ff;">private</span><span style="color: #000000;"> DataSource dataSource;

  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 事务管理，mybatis接入spring的一个重要原因也是可以直接使用spring提供的事务管理</span>
  <span style="color: #0000ff;">private</span><span style="color: #000000;"> TransactionFactory transactionFactory;

  </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Properties configurationProperties;

  </span><span style="color: #008000;">//</span><span style="color: #008000;"> mybatis的SqlSessionFactoryBuidler和SqlSessionFactory</span>
  <span style="color: #0000ff;">private</span> SqlSessionFactoryBuilder sqlSessionFactoryBuilder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlSessionFactoryBuilder();

  </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> SqlSessionFactory sqlSessionFactory;
  
  
  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 实现FactoryBean的getObject方法</span>
<span style="color: #000000;">  @Override
  </span><span style="color: #0000ff;">public</span> SqlSessionFactory getObject() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
  
    </span><span style="color: #008000;">//</span><span style="color: #008000;">...</span>
<span style="color: #000000;">
  }
  
  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 实现InitializingBean的</span>
<span style="color: #000000;">  @Override
  </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> afterPropertiesSet() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
  
    </span><span style="color: #008000;">//</span><span style="color: #008000;">...</span>
<span style="color: #000000;">    
  }
  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 为单例</span>
  <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isSingleton() {
    </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
  }
}</span></code></pre>

<p>我们重点关注FactoryBean，InitializingBean这两个接口，spring的IOC容器在加载创建SqlSessionFactoryBean的bean对象实例时，会调用InitializingBean的afterPropertiesSet方法进行对该bean对象进行相关初始化处理。</p>
<h3>InitializingBean的afterPropertiesSet方法</h3>
<p>大家最好看一下我前面关于Spring源码的文章，有Bean的生命周期详细源码分析，我们现在简单回顾一下，在getBean()时initializeBean方法中调用InitializingBean的afterPropertiesSet，而在前一步操作populateBean中，以及将该bean对象实例的属性设值好了，InitializingBean的afterPropertiesSet进行一些后置处理。此时我们要注意，<strong>populateBean方法已经将</strong>SqlSessionFactoryBean对象的属性进行赋值了，也就是xml中property配置的dataSource，mapperLocations，configLocation这三个属性已经在SqlSessionFactoryBean对象的属性进行赋值了，后面调用afterPropertiesSet时直接可以使用这三个配置的值了。</p>
<src class="cnblogs_code">
<pre><code><span style="color: #008000;">//</span><span style="color: #008000;"> bean对象实例创建的核心实现方法</span>
<span style="color: #0000ff;">protected</span> Object doCreateBean(<span style="color: #0000ff;">final</span> String beanName, <span style="color: #0000ff;">final</span> RootBeanDefinition mbd, <span style="color: #0000ff;">final</span><span style="color: #000000;"> @Nullable Object[] args)
        </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> BeanCreationException {

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 使用构造函数或者工厂方法来创建bean对象实例
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Instantiate the bean.</span>
    BeanWrapper instanceWrapper = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (mbd.isSingleton()) {
        instanceWrapper </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">.factoryBeanInstanceCache.remove(beanName);
    }
    </span><span style="color: #0000ff;">if</span> (instanceWrapper == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        instanceWrapper </span>=<span style="color: #000000;"> createBeanInstance(beanName, mbd, args);
    }
    
    ...

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 初始化bean对象实例，包括属性赋值，初始化方法，BeanPostProcessor的执行
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Initialize the bean instance.</span>
    Object exposedObject =<span style="color: #000000;"> bean;
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 1. InstantiationAwareBeanPostProcessor执行:
        </span><span style="color: #008000;">//</span><span style="color: #008000;">     (1). 调用InstantiationAwareBeanPostProcessor的postProcessAfterInstantiation,
        </span><span style="color: #008000;">//</span><span style="color: #008000;">  (2). 调用InstantiationAwareBeanPostProcessor的postProcessProperties和postProcessPropertyValues
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 2. bean对象的属性赋值</span>
<span style="color: #000000;">        populateBean(beanName, mbd, instanceWrapper);

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 1. Aware接口的方法调用
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 2. BeanPostProcess执行：调用BeanPostProcessor的postProcessBeforeInitialization
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 3. 调用init-method：首先InitializingBean的afterPropertiesSet，然后应用配置的init-method
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 4. BeanPostProcess执行：调用BeanPostProcessor的postProcessAfterInitialization</span>
        exposedObject =<span style="color: #000000;"> initializeBean(beanName, exposedObject, mbd);
    }
    

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Register bean as disposable.</span>
    <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
        registerDisposableBeanIfNecessary(beanName, bean, mbd);
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (BeanDefinitionValidationException ex) {
        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> BeanCreationException(
                mbd.getResourceDescription(), beanName, </span>"Invalid destruction signature"<span style="color: #000000;">, ex);
    }

    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> exposedObject;
}</span></code></pre>

<p>如上，在<strong>populateBean阶段，</strong>dataSource，mapperLocations，configLocation这三个属性已经在SqlSessionFactoryBean对象的属性进行赋值了，调用afterPropertiesSet时直接可以使用这三个配置的值了。那我们来接着看看afterPropertiesSet方法</p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@Override
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> afterPropertiesSet() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
    notNull(dataSource, </span>"Property 'dataSource' is required"<span style="color: #000000;">);
    notNull(sqlSessionFactoryBuilder, </span>"Property 'sqlSessionFactoryBuilder' is required"<span style="color: #000000;">);
    state((configuration </span>== <span style="color: #0000ff;">null</span> &amp;&amp; configLocation == <span style="color: #0000ff;">null</span>) || !(configuration != <span style="color: #0000ff;">null</span> &amp;&amp; configLocation != <span style="color: #0000ff;">null</span><span style="color: #000000;">),
              </span>"Property 'configuration' and 'configLocation' can not specified with together"<span style="color: #000000;">);

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 创建sqlSessionFactory</span>
    <span style="color: #0000ff;">this</span>.sqlSessionFactory =<span style="color: #000000;"> buildSqlSessionFactory();
}</span></code></pre>

<p>SqlSessionFactoryBean的afterPropertiesSet方法实现如下：调用buildSqlSessionFactory方法创建用于注册到spring的IOC容器的sqlSessionFactory对象。我们接着来看看<strong>buildSqlSessionFactory</strong></p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">protected</span> SqlSessionFactory buildSqlSessionFactory() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 配置类</span>
<span style="color: #000000;">   Configuration configuration;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 解析mybatis-Config.xml文件，
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 将相关配置信息保存到configuration</span>
   XMLConfigBuilder xmlConfigBuilder = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
   </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.configuration != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
     configuration </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">.configuration;
     </span><span style="color: #0000ff;">if</span> (configuration.getVariables() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
       configuration.setVariables(</span><span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationProperties);
     } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.configurationProperties != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
       configuration.getVariables().putAll(</span><span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationProperties);
     }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">资源文件不为空</span>
   } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.configLocation != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
     </span><span style="color: #008000;">//</span><span style="color: #008000;">根据configLocation创建xmlConfigBuilder，XMLConfigBuilder构造器中会创建Configuration对象</span>
     xmlConfigBuilder = <span style="color: #0000ff;">new</span> XMLConfigBuilder(<span style="color: #0000ff;">this</span>.configLocation.getInputStream(), <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationProperties);
     </span><span style="color: #008000;">//</span><span style="color: #008000;">将XMLConfigBuilder构造器中创建的Configuration对象直接赋值给configuration属性</span>
     configuration =<span style="color: #000000;"> xmlConfigBuilder.getConfiguration();
   } 
   
    </span><span style="color: #008000;">//</span><span style="color: #008000;">略....</span>

   <span style="color: #0000ff;">if</span> (xmlConfigBuilder != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
     </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
       </span><span style="color: #008000;">//</span><span style="color: #008000;">解析mybatis-Config.xml文件，并将相关配置信息保存到configuration</span>
<span style="color: #000000;">       xmlConfigBuilder.parse();
       </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
         LOGGER.debug(</span>"Parsed configuration file: '" + <span style="color: #0000ff;">this</span>.configLocation + "'"<span style="color: #000000;">);
       }
     } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {
       </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> NestedIOException("Failed to parse config resource: " + <span style="color: #0000ff;">this</span><span style="color: #000000;">.configLocation, ex);
     }
   }
    
   </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.transactionFactory == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
     </span><span style="color: #008000;">//</span><span style="color: #008000;">事务默认采用SpringManagedTransaction，这一块非常重要，我将在后买你单独写一篇文章讲解Mybatis和Spring事务的关系</span>
     <span style="color: #0000ff;">this</span>.transactionFactory = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SpringManagedTransactionFactory();
   }
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 为sqlSessionFactory绑定事务管理器和数据源
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 这样sqlSessionFactory在创建sqlSession的时候可以通过该事务管理器获取jdbc连接，从而执行SQL</span>
   configuration.setEnvironment(<span style="color: #0000ff;">new</span> Environment(<span style="color: #0000ff;">this</span>.environment, <span style="color: #0000ff;">this</span>.transactionFactory, <span style="color: #0000ff;">this</span><span style="color: #000000;">.dataSource));
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 解析mapper.xml</span>
   <span style="color: #0000ff;">if</span> (!isEmpty(<span style="color: #0000ff;">this</span><span style="color: #000000;">.mapperLocations)) {
     </span><span style="color: #0000ff;">for</span> (Resource mapperLocation : <span style="color: #0000ff;">this</span><span style="color: #000000;">.mapperLocations) {
       </span><span style="color: #0000ff;">if</span> (mapperLocation == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
         </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;
       }
       </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
         </span><span style="color: #008000;">//</span><span style="color: #008000;"> 解析mapper.xml文件，并注册到configuration对象的mapperRegistry</span>
         XMLMapperBuilder xmlMapperBuilder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> XMLMapperBuilder(mapperLocation.getInputStream(),
             configuration, mapperLocation.toString(), configuration.getSqlFragments());
         xmlMapperBuilder.parse();
       } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
         </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> NestedIOException("Failed to parse mapping resource: '" + mapperLocation + "'"<span style="color: #000000;">, e);
       } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {
         ErrorContext.instance().reset();
       }

       </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
         LOGGER.debug(</span>"Parsed mapper file: '" + mapperLocation + "'"<span style="color: #000000;">);
       }
     }
   } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
     </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
       LOGGER.debug(</span>"Property 'mapperLocations' was not specified or no matching resources found"<span style="color: #000000;">);
     }
   }

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 将Configuration对象实例作为参数，
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 调用sqlSessionFactoryBuilder创建sqlSessionFactory对象实例</span>
   <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.sqlSessionFactoryBuilder.build(configuration);
}</span></code></pre>

<p>buildSqlSessionFactory的核心逻辑：解析mybatis配置文件mybatisConfig.xml和mapper配置文件mapper.xml并封装到Configuration对象中，最后调用mybatis的sqlSessionFactoryBuilder来创建SqlSessionFactory对象。这一点相当于前面介绍的原生的mybatis的初始化过程。另外，当<strong>配置中未指定事务时，mybatis-spring默认采用SpringManagedTransaction，这一点非常重要，请大家先在心里做好准备</strong>。此时SqlSessionFactory已经创建好了，并且赋值到了SqlSessionFactoryBean的sqlSessionFactory属性中。</p>
<h3>FactoryBean的getObject方法定义</h3>
<p><strong>FactoryBean：创建某个类的对象实例的工厂。</strong></p>
<p>spring的IOC容器在启动，创建好bean对象实例后，会检查这个bean对象是否实现了FactoryBean接口，如果是，则调用该bean对象的getObject方法，在getObject方法中实现创建并返回实际需要的bean对象实例，然后将该实际需要的bean对象实例注册到spring容器；如果不是则直接将该bean对象实例注册到spring容器。</p>
<p>SqlSessionFactoryBean的getObject方法实现如下：由于spring在创建SqlSessionFactoryBean自身的bean对象时，已经调用了InitializingBean的afterPropertiesSet方法创建了sqlSessionFactory对象，故可以直接返回sqlSessionFactory对象给spring的IOC容器，从而完成sqlSessionFactory的bean对象的注册，之后可以直接在应用代码注入或者spring在创建其他bean对象时，依赖注入sqlSessionFactory对象。</p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@Override
</span><span style="color: #0000ff;">public</span> SqlSessionFactory getObject() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
    </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.sqlSessionFactory == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
      afterPropertiesSet();
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 直接返回sqlSessionFactory对象
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 单例对象，由所有mapper共享</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.sqlSessionFactory;
}</span></code></pre>

<h2>总结</h2>
<p>由以上分析可知，spring在加载创建SqlSessionFactoryBean的bean对象实例时，调用SqlSessionFactoryBean的afterPropertiesSet方法完成了sqlSessionFactory对象实例的创建；在将SqlSessionFactoryBean对象实例注册到spring的IOC容器时，发现SqlSessionFactoryBean实现了FactoryBean接口，故不是SqlSessionFactoryBean对象实例自身需要注册到spring的IOC容器，而是SqlSessionFactoryBean的getObject方法的返回值对应的对象需要注册到spring的IOC容器，而这个返回值就是SqlSessionFactory对象，故完成了将sqlSessionFactory对象实例注册到spring的IOC容器。创建Mapper的代理对象我们下一篇文章再讲</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>