<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®ç»†èŠSpring Cloud Bus' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>ç»†èŠSpring Cloud Bus</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»ç»´æ™Ÿæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/bluersw/p/11643166.html</div><br>
    <h1 id="ç»†èŠspring-cloud-bus">ç»†èŠSpring Cloud Bus</h1>
<h2 id="spring-äº‹ä»¶é©±åŠ¨æ¨¡å‹">Spring äº‹ä»¶é©±åŠ¨æ¨¡å‹</h2>
<p>å› ä¸ºSpring Cloud Busçš„è¿è¡Œæœºåˆ¶ä¹Ÿæ˜¯Springäº‹ä»¶é©±åŠ¨æ¨¡å‹æ‰€ä»¥éœ€è¦å…ˆäº†è§£ç›¸å…³çŸ¥è¯†ç‚¹ï¼š<br />
<img src="./images/ç»†èŠSpring Cloud Bus0.png" alt="Alt text" /><br />
ä¸Šé¢å›¾ä¸­æ˜¯Springäº‹ä»¶é©±åŠ¨æ¨¡å‹çš„å®ç°ç¤ºæ„å›¾ï¼Œä»¥ä¸‹å†è¡¥å……ä¸€äº›å›¾ä¸­æœªæç°çš„å®ç°ç»†èŠ‚ï¼šæŠ½è±¡ç±»abstract class AbstractApplicationEventMulticasterä¸­æ ¹æ®äº‹ä»¶å’Œäº‹ä»¶ç±»å‹è·å–å¯¹åº”çš„è§‚å¯Ÿè€…çš„æ–¹æ³•æ˜¯ï¼š</p>
<pre><code><code>    protected Collection&lt;ApplicationListener&lt;?&gt;&gt; getApplicationListeners(
            ApplicationEvent event, ResolvableType eventType)  </code></code></pre>
<p>è¯¥æ–¹æ³•å†…å…·ä½“æ£€ç´¢ç›‘å¬å™¨ï¼ˆè§‚å¯Ÿè€…çš„æ–¹æ³•ï¼‰æ˜¯ï¼š</p>
<pre><code><code>private Collection&lt;ApplicationListener&lt;?&gt;&gt; retrieveApplicationListeners(
            ResolvableType eventType, @Nullable Class&lt;?&gt; sourceType, @Nullable ListenerRetriever retriever)
            
            .....
        // Add programmatically registered listeners, including ones coming
        // from ApplicationListenerDetector (singleton beans and inner beans).
        for (ApplicationListener&lt;?&gt; listener : listeners) {
            if (supportsEvent(listener, eventType, sourceType)) {
                if (retriever != null) {
                    retriever.applicationListeners.add(listener);
                }
                allListeners.add(listener);
            }
        }
            .....</code></code></pre>
<p>æ­¤æ–¹æ³•å†…æ ¹æ®ä¼ å…¥å‚æ•°äº‹çš„ä»¶å¯¹è±¡éå†æ‰€æœ‰å¯¹åº”ï¼ˆè®¢é˜…ï¼‰çš„ç›‘å¬è€…ï¼Œå…¶ä¸­æœ‰ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•boolean supportsEventï¼Œæ­¤æ–¹æ³•ç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯è®¢é˜…çš„ç›‘å¬è€…ï¼š</p>
<pre><code><code>    protected boolean supportsEvent(
            ApplicationListener&lt;?&gt; listener, ResolvableType eventType, @Nullable Class&lt;?&gt; sourceType) {

        GenericApplicationListener smartListener = (listener instanceof GenericApplicationListener ?
                (GenericApplicationListener) listener : new GenericApplicationListenerAdapter(listener));
        return (smartListener.supportsEventType(eventType) &amp;&amp; smartListener.supportsSourceType(sourceType));
    }</code></code></pre>
<p>å…¶ä¸­æ¥å£GenericApplicationListenerå’ŒGenericApplicationListenerAdapterç±»éƒ½æ˜¯ä¸ºäº†å®šä¹‰æˆ–å®ç°supportsEventTypeæ–¹æ³•å’ŒsupportsSourceTypeæ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•ç¡®å®šæ˜¯å¦æ˜¯äº‹ä»¶çš„ç›‘å¬å™¨ï¼ˆè§‚å¯Ÿè€…ã€è®¢é˜…è€…ï¼‰ã€‚</p>
<pre><code><code>public interface GenericApplicationListener extends ApplicationListener&lt;ApplicationEvent&gt;, Ordered {

    /**
     * Determine whether this listener actually supports the given event type.
     * @param eventType the event type (never {@code null})
     */
    boolean supportsEventType(ResolvableType eventType);

    /**
     * Determine whether this listener actually supports the given source type.
     * &lt;p&gt;The default implementation always returns {@code true}.
     * @param sourceType the source type, or {@code null} if no source
     */
    default boolean supportsSourceType(@Nullable Class&lt;?&gt; sourceType) {
        return true;
    }

    /**
     * Determine this listener&#39;s order in a set of listeners for the same event.
     * &lt;p&gt;The default implementation returns {@link #LOWEST_PRECEDENCE}.
     */
    @Override
    default int getOrder() {
        return LOWEST_PRECEDENCE;
    }

}</code></code></pre>
<p>å…¶ä¸­åˆ¤æ–­å‘å¸ƒäº‹ä»¶çš„æ¥æºå¯¹è±¡supportsSourceTypeæ–¹æ³•é»˜è®¤å°±è¿”å›trueï¼Œæ„å‘³ç€å¦‚æœä¸é‡å†™è¿™ä¸ªæ¥å£æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯è®¢é˜…äº‹ä»¶çš„ç›‘å¬å™¨ä¸ä»¥äº‹ä»¶æ¥æºå¯¹è±¡è¿›è¡Œåˆ¤æ–­ï¼Œåªæ ¹æ®äº‹ä»¶ç±»å‹è¿›è¡Œç­›é€‰,è¯¥æ–¹æ³•çš„å…·ä½“å®ç°å¯å‚è€ƒGenericApplicationListenerAdapterç±»åŒ…è£…çš„supportsSourceTypeæ–¹æ³•å®ç°ï¼š</p>
<pre><code><code>public boolean supportsSourceType(@Nullable Class&lt;?&gt; sourceType) {
        return !(this.delegate instanceof SmartApplicationListener) ||
                ((SmartApplicationListener) this.delegate).supportsSourceType(sourceType);
    }</code></code></pre>
<h2 id="spring-cloud-busçš„äº‹ä»¶å‘å¸ƒè®¢é˜…">Spring Cloud Busçš„äº‹ä»¶ã€å‘å¸ƒã€è®¢é˜…</h2>
<p>Spring Cloud Busçš„äº‹ä»¶éƒ½ç»§æ‰¿äºRemoteApplicationEventç±»ï¼ŒRemoteApplicationEventç±»ç»§æ‰¿äºSpringäº‹ä»¶é©±åŠ¨æ¨¡å‹çš„äº‹ä»¶æŠ½è±¡ç±»ApplicationEventï¼Œä¹Ÿå°±è¯´Spring Cloud Busçš„äº‹ä»¶ã€å‘å¸ƒã€è®¢é˜…ä¹Ÿæ˜¯åŸºäºSpringçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä¾‹å¦‚Spring Cloud Busçš„é…ç½®åˆ·æ–°äº‹ä»¶RefreshRemoteApplicationEventï¼š</p>
<p><img src="./images/ç»†èŠSpring Cloud Bus1.png" alt="Alt text" /></p>
<p>åŒç†è®¢é˜…äº‹ä»¶ä¹Ÿæ˜¯æ ‡å‡†çš„Springäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä¾‹å¦‚é…ç½®åˆ·æ–°çš„ç›‘å¬å™¨æºç ç»§æ‰¿äº†Springäº‹ä»¶é©±åŠ¨æ¨¡å‹ä¸­çš„æ¥å£ApplicationListener&lt;E extends ApplicationEvent&gt;ï¼š</p>
<pre><code><code>public class RefreshListener
        implements ApplicationListener&lt;RefreshRemoteApplicationEvent&gt; {

    private static Log log = LogFactory.getLog(RefreshListener.class);

    private ContextRefresher contextRefresher;

    public RefreshListener(ContextRefresher contextRefresher) {
        this.contextRefresher = contextRefresher;
    }

    @Override
    public void onApplicationEvent(RefreshRemoteApplicationEvent event) {
        Set&lt;String&gt; keys = this.contextRefresher.refresh();
        log.info(&quot;Received remote refresh request. Keys refreshed &quot; + keys);
    }

}</code></code></pre>
<p>åœ¨BusRefreshAutoConfigurationç±»ä¸­ä¼šå°†RefreshListenerå¯¹è±¡æ³¨å†Œåˆ°Springçš„BeanFactoryä¸­ï¼ˆä¸æŠŠç›‘å¬å™¨ç±»æ³¨å†Œåˆ°Springçš„BeanFactoryä¸­å°±æ— æ³•åˆ©ç”¨Springçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹å¯¹åˆ·æ–°äº‹ä»¶è¿›è¡Œå¤„ç†ï¼‰ã€‚</p>
<pre><code><code>    @Bean
    @ConditionalOnProperty(value = &quot;spring.cloud.bus.refresh.enabled&quot;,matchIfMissing = true)
    @ConditionalOnBean(ContextRefresher.class)
    public RefreshListener refreshListener(ContextRefresher contextRefresher) {
        return new RefreshListener(contextRefresher);
    }</code></code></pre>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨@EventListeneråˆ›å»ºç›‘å¬å™¨ï¼Œä¾‹å¦‚TraceListenerç±»ï¼š</p>
<pre><code><code>    @EventListener
    public void onAck(AckRemoteApplicationEvent event) {
        Map&lt;String, Object&gt; trace = getReceivedTrace(event);
        // FIXME boot 2 this.repository.add(trace);
    }

    @EventListener
    public void onSend(SentApplicationEvent event) {
        Map&lt;String, Object&gt; trace = getSentTrace(event);
        // FIXME boot 2 this.repository.add(trace);
    }</code></code></pre>
<p>å‘å¸ƒäº‹ä»¶ä¹Ÿæ˜¯åˆ©ç”¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡è¿›è¡Œäº‹ä»¶å‘å¸ƒï¼Œæ¯”å¦‚é…ç½®åˆ·æ–°çš„å®ç°ä»£ç ï¼š</p>
<pre><code><code>@Endpoint(id = &quot;bus-refresh&quot;) // TODO: document new id
public class RefreshBusEndpoint extends AbstractBusEndpoint {

    public RefreshBusEndpoint(ApplicationEventPublisher context, String id) {
        super(context, id);
    }

    @WriteOperation
    public void busRefreshWithDestination(@Selector String destination) { // TODO:
                                                                            // document
                                                                            // destination
        publish(new RefreshRemoteApplicationEvent(this, getInstanceId(), destination));
    }

    @WriteOperation
    public void busRefresh() {
        publish(new RefreshRemoteApplicationEvent(this, getInstanceId(), null));
    }

}</code></code></pre>
<p>æ³¨è§£@WriteOperationå®ç°POSTæ“ä½œï¼Œ@Endpointç»“åˆmanagement.endpoints.web.exposure.include=* é…ç½®é¡¹å¯å®ç°ä¸€ä¸ªæ¥å…¥ç‚¹ï¼Œæ¥å…¥ç‚¹çš„URLæ˜¯ï¼š/actuator/bus-refresh<br />
çˆ¶ç±»AbstractBusEndpointå†…ç”¨åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡å®ç°äº‹ä»¶çš„å‘å¸ƒï¼š</p>
<pre><code><code>public class AbstractBusEndpoint {

    private ApplicationEventPublisher context;

    private String appId;

    public AbstractBusEndpoint(ApplicationEventPublisher context, String appId) {
        this.context = context;
        this.appId = appId;
    }

    protected String getInstanceId() {
        return this.appId;
    }

    protected void publish(ApplicationEvent event) {
        this.context.publishEvent(event);
    }

}</code></code></pre>
<h2 id="spring-cloud-busçš„åº•å±‚é€šè®¯å®ç°å¯¹ä½¿ç”¨è€…é€æ˜">Spring Cloud Busçš„åº•å±‚é€šè®¯å®ç°ï¼ˆå¯¹ä½¿ç”¨è€…é€æ˜ï¼‰</h2>
<p>Spring Cloud Busçš„åº•å±‚é€šè®¯åŸºç¡€æ˜¯Spring Cloud Streamï¼Œå®šä¹‰å‘é€æ€»çº¿äº‹ä»¶å’Œæ¥æ”¶æ€»çº¿äº‹ä»¶ç›‘å¬å™¨çš„ç±»æ˜¯BusAutoConfigurationï¼ˆåœ¨ç½‘ç»œä¸Šå‘é€å’Œæ¥æ”¶å…¶ä»–èŠ‚ç‚¹çš„äº‹ä»¶æ¶ˆæ¯ï¼‰ï¼Œå› ä¸ºç»§æ‰¿äº†ApplicationEventPublisherAwareæ‰€ä»¥è¯¥ç±»ä¹Ÿå…·å¤‡å‘å¸ƒæœ¬åœ°äº‹ä»¶çš„åŠŸèƒ½ï¼ˆå¯ä»¥æŸ¥è¯¢Awareæ¥å£ä½œç”¨ï¼‰ï¼Œå‘å¸ƒç½‘ç»œäº‹ä»¶æ¶ˆæ¯çš„æ–¹æ³•æ˜¯ï¼š</p>
<pre><code><code>@EventListener(classes = RemoteApplicationEvent.class)
    public void acceptLocal(RemoteApplicationEvent event) {
        if (this.serviceMatcher.isFromSelf(event)
                &amp;&amp; !(event instanceof AckRemoteApplicationEvent)) {
            this.cloudBusOutboundChannel.send(MessageBuilder.withPayload(event).build());
        }
    }</code></code></pre>
<p>å¦‚æœç›‘å¬åˆ°RemoteApplicationEventç±»äº‹ä»¶ï¼Œé¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±å‘å¸ƒå¹¶ä¸”ä¸æ˜¯ACKäº‹ä»¶ï¼Œå¦‚æœæ˜¯è‡ªå·±å‘å¸ƒçš„éACKäº‹ä»¶å°±åœ¨æ€»çº¿ä¸Šå‘é€è¿™ä¸ªäº‹ä»¶æ¶ˆæ¯ã€‚å‘é€AckRemoteApplicationEventï¼ˆACKäº‹ä»¶ï¼‰å·²ç»åœ¨æ¥æ”¶å…¶ä»–èŠ‚ç‚¹å‘çš„äº‹ä»¶æ¶ˆæ¯æ—¶è§¦å‘äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸ç”¨ç®¡å‘é€ACKäº‹ä»¶çš„å·¥ä½œäº†ã€‚</p>
<p>æ¥æ”¶äº‹ä»¶æ¶ˆæ¯ï¼š</p>
<pre><code><code>@StreamListener(SpringCloudBusClient.INPUT)
    public void acceptRemote(RemoteApplicationEvent event) {
        if (event instanceof AckRemoteApplicationEvent) {
            if (this.bus.getTrace().isEnabled() &amp;&amp; !this.serviceMatcher.isFromSelf(event)
                    &amp;&amp; this.applicationEventPublisher != null) {
                this.applicationEventPublisher.publishEvent(event);
            }
            // If it&#39;s an ACK we are finished processing at this point
            return;
        }
        if (this.serviceMatcher.isForSelf(event)
                &amp;&amp; this.applicationEventPublisher != null) {
            if (!this.serviceMatcher.isFromSelf(event)) {
                this.applicationEventPublisher.publishEvent(event);
            }
            if (this.bus.getAck().isEnabled()) {
                AckRemoteApplicationEvent ack = new AckRemoteApplicationEvent(this,
                        this.serviceMatcher.getServiceId(),
                        this.bus.getAck().getDestinationService(),
                        event.getDestinationService(), event.getId(), event.getClass());
                this.cloudBusOutboundChannel
                        .send(MessageBuilder.withPayload(ack).build());
                this.applicationEventPublisher.publishEvent(ack);
            }
        }
        if (this.bus.getTrace().isEnabled() &amp;&amp; this.applicationEventPublisher != null) {
            // We are set to register sent events so publish it for local consumption,
            // irrespective of the origin
            this.applicationEventPublisher.publishEvent(new SentApplicationEvent(this,
                    event.getOriginService(), event.getDestinationService(),
                    event.getId(), event.getClass()));
        }
    }</code></code></pre>
<p>æ¥æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„äº‹ä»¶æ¶ˆæ¯åä¼šå°†æ­¤äº‹ä»¶å‘å¸ƒåˆ°æœ¬åœ°çš„åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ï¼ˆthis.applicationEventPublisherï¼‰ï¼Œç›‘å¬æ­¤äº‹ä»¶ç±»å‹çš„è®¢é˜…è€…å°±ä¼šç›¸åº”çš„è¿›è¡Œå¤„ç†ã€‚</p>
<h2 id="ä¸¤ä¸ªè·Ÿè¸ªäº‹ä»¶ackremoteapplicationeventå’Œsentapplicationevent">ä¸¤ä¸ªè·Ÿè¸ªäº‹ä»¶AckRemoteApplicationEventå’ŒSentApplicationEvent</h2>
<p>ä»ä»–ä»¬çš„ç»§æ‰¿å…³ç³»å¯ä»¥çœ‹å‡ºï¼ŒAckRemoteApplicationEventå¯ä»¥å‘é€åˆ°å…¶ä»–ç½‘ç»œèŠ‚ç‚¹ï¼ˆç»§æ‰¿äºRemoteApplicationEventï¼‰ï¼ŒSentApplicationEventåªæ˜¯æœ¬åœ°äº‹ä»¶ï¼ˆç»§æ‰¿äºApplicationEventï¼‰ï¼ŒSentApplicationEventäº‹ä»¶å¯ä»¥æ˜¾ç¤ºæ”¶åˆ°äº‹ä»¶æ¶ˆæ¯çš„ç±»å‹ï¼ŒAckRemoteApplicationEventäº‹ä»¶åªæ˜¾ç¤ºæ”¶åˆ°äº‹ä»¶æ¶ˆæ¯çš„IDï¼ŒTraceListenerç±»è´Ÿè´£ç›‘å¬å’Œè®°å½•ä»–ä»¬çš„å†…å®¹ï¼ˆé…ç½®é¡¹è¦æ‰“å¼€spring.cloud.bus.trace.enabled=trueï¼‰ï¼š</p>
<pre><code><code>public class TraceListener {

    @EventListener
    public void onAck(AckRemoteApplicationEvent event) {
        Map&lt;String, Object&gt; trace = getReceivedTrace(event);
        // FIXME boot 2 this.repository.add(trace);
    }

    @EventListener
    public void onSend(SentApplicationEvent event) {
        Map&lt;String, Object&gt; trace = getSentTrace(event);
        // FIXME boot 2 this.repository.add(trace);
    }

    protected Map&lt;String, Object&gt; getSentTrace(SentApplicationEvent event) {
        .....
    }

    protected Map&lt;String, Object&gt; getReceivedTrace(AckRemoteApplicationEvent event) {
        .....
    }

}</code></code></pre>
<p>åœ¨æ€»çº¿äº‹ä»¶å‘é€ç«¯å’Œæ€»çº¿äº‹ä»¶æ¥æ”¶ç«¯æ—¥å¿—çš„è®°å½•æµç¨‹å¦‚ä¸‹ï¼š<br />
<img src="./images/ç»†èŠSpring Cloud Bus2.png" alt="Alt text" /></p>
<h2 id="æµ‹è¯•aåº”ç”¨å’Œbåº”ç”¨è¿›è¡ŒèŠå¤©">æµ‹è¯•Aåº”ç”¨å’ŒBåº”ç”¨è¿›è¡Œâ€œèŠå¤©â€</h2>
<p>é¦–å…ˆå‡†å¤‡ç¯å¢ƒï¼š<br />
åˆ›å»º3ä¸ªé¡¹ç›®ï¼šspring-cloud-bus-shared-libraryã€spring-cloud-bus-aã€spring-cloud-bus-b</p>
<ul>
<li>spring-cloud-bus-shared-libraryï¼šè´Ÿè´£å®šä¹‰äº‹ä»¶å’Œç›‘å¬å™¨è¿˜æœ‰é…ç½®ç±»</li>
<li>spring-cloud-bus-aï¼šæ‰®æ¼”Aåº”ç”¨è´Ÿè´£å¼•ç”¨shared-libraryå¹¶åˆ©ç”¨BUSå‘é€æ¶ˆæ¯ç»™Båº”ç”¨ï¼ˆæ­¤æ¶ˆæ¯å®é™…ä¸ºå¹¿æ’­æ¶ˆæ¯ï¼‰</li>
<li>spring-cloud-bus-bï¼šæ‰®æ¼”Båº”ç”¨è´Ÿè´£å¼•ç”¨shared-libraryå¹¶åˆ©ç”¨BUSå›å¤Aåº”ç”¨å‘æ¥çš„æ¶ˆæ¯ï¼ˆæ­¤æ¶ˆæ¯éå¹¿æ’­æ¶ˆæ¯ï¼‰</li>
</ul>
<p>spring-cloud-bus-shared-libraryçš„POMçš„ä¾èµ–é¡¹ï¼š</p>
<pre class="xml"><code>&lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;spring-cloud.version&gt;Greenwich.SR3&lt;/spring-cloud.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;</code></code></pre>
<p>åˆ é™¤æ„å»ºçš„Mavenæ’ä»¶èŠ‚ç‚¹å¦åˆ™æ„å»ºåå…¶ä»–é¡¹ç›®å¼•ç”¨ä¸äº†ï¼ˆæ ¼å¼ä¸å¯¹ï¼‰ï¼š</p>
<pre class="xml"><code>&lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;</code></code></pre>
<p>å¯åŠ¨ä¸€ä¸ªrabbitmq:</p>
<pre class="shell"><code>docker pull rabbitmq:3-management

docker run -d --hostname my-rabbit --name rabbit -p 5672:5672 -p 15672:15672 rabbitmq:3-management</code></code></pre>
<p>application.propertiesé…ç½®å®šä¹‰ï¼š</p>
<pre class="text"><code>spring.application.name=spring-cloud-bus-shared-library
server.port=9007
# å¼€å¯æ¶ˆæ¯è·Ÿè¸ª
spring.cloud.bus.trace.enabled=true
spring.rabbitmq.host=127.0.0.1
spring.rabbitmq.port=5672
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest

#æ˜¾ç¤ºçš„æš´éœ²æ¥å…¥ç‚¹
management.endpoints.web.exposure.include=*</code></code></pre>
<p>spring-cloud-bus-aã€spring-cloud-bus-bçš„é…ç½®ä¿¡æ¯é™¤äº†spring.application.nameå’Œserver.portä¸ä¸€æ ·ï¼Œå…¶ä»–éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>è‡ªå®šä¹‰ä¸€ä¸ªèŠå¤©äº‹ä»¶ç±»ï¼š</p>
<pre><code><code>/**
 * èŠå¤©äº‹ä»¶
 */
public class ChatRemoteApplicationEvent extends RemoteApplicationEvent {

    private String message;

    //for serializers
    private ChatRemoteApplicationEvent(){}

    public ChatRemoteApplicationEvent(Object source, String originService,
            String destinationService,String message){
        super(source, originService, destinationService);

        this.message = message;
    }

    public void setMessage(String message){
        this.message = message;
    }

    public String getMessage(){
        return this.message;
    }
}</code></code></pre>
<p>è‡ªå®šä¹‰èŠå¤©äº‹ä»¶ç›‘å¬å™¨ï¼š</p>
<pre><code><code>/**
 * èŠå¤©äº‹ä»¶ç›‘å¬
 */
public class ChatListener implements ApplicationListener&lt;ChatRemoteApplicationEvent&gt; {

    private static Log log = LogFactory.getLog(ChatListener.class);

    public ChatListener(){}

    @Override
    public void onApplicationEvent(ChatRemoteApplicationEvent event){
        log.info(String.format(&quot;åº”ç”¨%så¯¹åº”ç”¨%sæ‚„æ‚„çš„è¯´ï¼š\&quot;%s\&quot;&quot;,
                event.getOriginService(),
                event.getDestinationService(),
                event.getMessage()));
    }
}</code></code></pre>
<p>é…ç½®ç±»å°†ç›‘å¬å™¨æ³¨å†Œåˆ°BeanFactoryä¸­ï¼Œå¹¶éœ€è¦æ˜¾ç¤ºçš„å‘Šè¯‰Spring Cloud Busæˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶ï¼š@RemoteApplicationEventScan(basePackageClasses=ChatRemoteApplicationEvent.class)ï¼Œå¦åˆ™BUSæ”¶åˆ°æ¶ˆæ¯åæ— æ³•è¯†åˆ«äº‹ä»¶ç±»å‹ã€‚</p>
<pre><code><code>@Configuration
@ConditionalOnClass(ChatListener.class)
@RemoteApplicationEventScan(basePackageClasses=ChatRemoteApplicationEvent.class)
public class BusChatConfiguration {

    @Bean
    public ChatListener ChatListener(){
        return new ChatListener();
    }
}
</code></code></pre>
<p>å‘å¸ƒåˆ°æœ¬åœ°Mavenä»“åº“ï¼š</p>
<pre class="shell"><code>mvn install</code></code></pre>
<p>spring-cloud-bus-aã€spring-cloud-bus-bçš„POMä¾èµ–ï¼š</p>
<pre class="xml"><code>&lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;spring-cloud.version&gt;Greenwich.SR3&lt;/spring-cloud.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-bus&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.bluersw&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-bus-shared-library&lt;/artifactId&gt;
            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-cloud.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;</code></code></pre>
<p>åœ¨spring-cloud-bus-aã€spring-cloud-bus-bçš„å¯åŠ¨Mainå‡½æ•°ä¸Šå¢åŠ @ComponentScan(value = &quot;com.bluersw&quot;)æ³¨è§£ï¼Œå¦åˆ™ä¸ä¼šæ‰«æå¼•ç”¨spring-cloud-bus-shared-libraryé¡¹ç›®çš„é…ç½®ç±»ï¼ˆä¹Ÿå°±åŠ è½½ä¸äº†è‡ªå®šä¹‰çš„äº‹ä»¶å’Œç›‘å¬å™¨ç±»å‹ï¼‰ã€‚</p>
<p>spring-cloud-bus-a:</p>
<pre><code><code>@SpringBootApplication
@ComponentScan(value = &quot;com.bluersw&quot;)
public class SpringCloudBusAApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringCloudBusAApplication.class, args);
    }

}</code></code></pre>
<p>spring-cloud-bus-b:</p>
<pre><code><code>@SpringBootApplication
@ComponentScan(value = &quot;com.bluersw&quot;)
public class SpringCloudBusBApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringCloudBusBApplication.class, args);
    }

}</code></code></pre>
<p>spring-cloud-bus-aå‘é€æ¶ˆæ¯ç»™spring-cloud-bus-bï¼ˆå¯åŠ¨spring-cloud-bus-aç¨‹åºå’Œspring-cloud-bus-bç¨‹åºï¼‰:</p>
<pre><code><code>@RunWith(SpringRunner.class)
@SpringBootTest
public class SpringCloudBusAApplicationTests {

    @Autowired
    private ApplicationEventPublisher context;

    @Autowired
    private BusProperties bp;

    @Test
    public void AChat() {
        context.publishEvent(new ChatRemoteApplicationEvent(this,bp.getId(),null,&quot;hi!Båº”ç”¨ï¼Œæˆ‘æ˜¯Aåº”ç”¨ï¼Œã€‚&quot;));
    }

}</code></code></pre>
<p>æ‰§è¡ŒAChat()ä¹‹åï¼Œspring-cloud-bus-bçš„æ§åˆ¶å°ä¼šè¾“å‡ºï¼š<br />
â€åº”ç”¨spring-cloud-bus-ağŸ‘33b6374cba32e6a3e7e2c8e7631de8c0å¯¹åº”ç”¨**æ‚„æ‚„çš„è¯´ï¼š&quot;hi!Båº”ç”¨ï¼Œæˆ‘æ˜¯Aåº”ç”¨ï¼Œã€‚â€ï¼Œè¯´æ˜spring-cloud-bus-bæ”¶åˆ°äº†æ¶ˆæ¯å¹¶æ­£ç¡®è§£æå’Œæ‰§è¡Œäº†äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œä½†è¿™æ¡æ¶ˆæ¯æ˜¯ç¾¤å‘çš„ï¼Œå› ä¸ºdestinationServiceå‚æ•°æˆ‘ä»¬ç»™çš„æ˜¯ä¸ªnullï¼Œæ‰€æœ‰å¼•ç”¨spring-cloud-bus-shared-libraryé¡¹ç›®æ³¨å†Œç›‘å¬å™¨çš„é¡¹ç›®éƒ½å¯ä»¥æ”¶åˆ°æ­¤ä¿¡æ¯ã€‚</p>
<p>spring-cloud-bus-bå›å¤æ¶ˆæ¯ç»™spring-cloud-bus-aï¼š</p>
<pre><code><code>@RunWith(SpringRunner.class)
@SpringBootTest
public class SpringCloudBusBApplicationTests {

    @Autowired
    private ApplicationEventPublisher context;

    @Autowired
    private BusProperties bp;

    @Test
    public void BChat() {
        context.publishEvent(new ChatRemoteApplicationEvent(this,bp.getId(),&quot;spring-cloud-bus-a:9008&quot;,&quot;hi!æˆ‘æ˜¯Båº”ç”¨,è¿™æ ·æ‰èƒ½ä¸è¢«å…¶ä»–åº”ç”¨æ¥æ”¶åˆ°ã€‚&quot;));
    }
}</code></code></pre>
<p>spring-cloud-bus-aæ˜¯é¡¹ç›®åç§°ï¼Œ9008æ˜¯spring-cloud-bus-aé¡¹ç›®çš„ç«¯å£å·ï¼ŒæŒ‡å®šäº†ç›®æ ‡æœåŠ¡å‚æ•°destinationServiceåï¼Œå…¶ä»–åº”ç”¨å°±æ¥æ”¶ä¸åˆ°è¿™æ¡æ¶ˆæ¯äº†ã€‚æ‰§è¡ŒBChat()ä¹‹åï¼Œspring-cloud-bus-aæ§åˆ¶å°ä¼šæ˜¾ç¤ºï¼š<br />
â€œåº”ç”¨spring-cloud-bus-bğŸ‘d577ac1ab28f0fc465a1e4700e7f538aå¯¹åº”ç”¨spring-cloud-bus-a:9008:**æ‚„æ‚„çš„è¯´ï¼š&quot;hi!æˆ‘æ˜¯Båº”ç”¨,è¿™æ ·æ‰èƒ½ä¸è¢«å…¶ä»–åº”ç”¨æ¥æ”¶åˆ°ã€‚â€<br />
æ­¤æ¶ˆæ¯ç°åœ¨åªæœ‰spring-cloud-bus-aé¡¹ç›®ä¼šæ¥æ”¶åˆ°ã€‚</p>
<h2 id="æºç ">æºç </h2>
<p><a href="https://github.com/sunweisheng/spring-cloud-example">Githubä»“åº“:https://github.com/sunweisheng/spring-cloud-example</a></p>


</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>