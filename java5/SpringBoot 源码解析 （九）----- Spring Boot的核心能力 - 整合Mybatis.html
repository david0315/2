<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修SpringBoot 源码解析 （九）----- Spring Boot的核心能力 - 整合Mybatis' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>SpringBoot 源码解析 （九）----- Spring Boot的核心能力 - 整合Mybatis</center></div><div class='banquan'>原文出处:本文由博客园博主chen_hao提供。<br/>
原文连接:https://www.cnblogs.com/java-chen-hao/p/11849869.html</div><br>
    <p>本篇我们在SpringBoot中整合Mybatis这个orm框架，毕竟分析一下其自动配置的源码，我们先来回顾一下以前Spring中是如何整合Mybatis的，大家可以看看我这篇文章<a class="entry" href="https://www.cnblogs.com/java-chen-hao/p/11833780.html" target="_blank">Mybaits 源码解析 （十）----- Spring-Mybatis框架使用与源码解析</a>&nbsp;</p>
<h2>Spring-Mybatis使用</h2>
<h3>添加maven依赖</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-jdbc<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>4.3.8.RELEASE<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> https://mvnrepository.com/artifact/org.mybatis/mybatis-spring </span><span style="color: #008000;">--&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.mybatis<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span><strong>mybatis-spring</strong><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.3.2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>在src/main/resources下添加mybatis-config.xml文件</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">configuration</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">typeAliases</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">typeAlias </span><span style="color: #ff0000;">alias</span><span style="color: #0000ff;">="User"</span><span style="color: #ff0000;"> type</span><span style="color: #0000ff;">="com.chenhao.bean.User"</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">typeAliases</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">plugins</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">plugin </span><span style="color: #ff0000;">interceptor</span><span style="color: #0000ff;">="com.github.pagehelper.PageInterceptor"</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="helperDialect"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="mysql"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">plugin</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">plugins</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">configuration</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>在src/main/resources/mapper路径下添加User.xml</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span style="color: #0000ff;">&gt;</span>
    
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">mapper </span><span style="color: #ff0000;">namespace</span><span style="color: #0000ff;">="com.chenhao.mapper.UserMapper"</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">select </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="getUser"</span><span style="color: #ff0000;"> parameterType</span><span style="color: #0000ff;">="int"</span><span style="color: #ff0000;">
        resultType</span><span style="color: #0000ff;">="com.chenhao.bean.User"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
        SELECT *
        FROM USER
        WHERE id = #{id}
    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">select</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">mapper</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>在src/main/resources/路径下添加beans.xml</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">beans </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://www.springframework.org/schema/beans"</span><span style="color: #ff0000;">
    xmlns:xsi</span><span style="color: #0000ff;">="http://www.w3.org/2001/XMLSchema-instance"</span><span style="color: #ff0000;">
    xsi:schemaLocation</span><span style="color: #0000ff;">="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span style="color: #0000ff;">&gt;</span>
 
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.springframework.jdbc.datasource.DriverManagerDataSource"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="driverClassName"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="com.mysql.jdbc.Driver"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="url"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="jdbc:mysql://127.0.0.1:3306/test"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="username"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="root"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="password"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="root"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>
 
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="sqlSessionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.mybatis.spring.SqlSessionFactoryBean"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="configLocation"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mybatis-config.xml"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="dataSource"</span> <span style="color: #0000ff;">/&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="mapperLocations"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:mapper/*.xml"</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>
    
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="org.mybatis.spring.mapper.MapperScannerConfigurer"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="basePackage"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="com.chenhao.mapper"</span> <span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>
 
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">beans</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>注解的方式</h3>
<ul>
<li>以上分析都是在spring的XML配置文件applicationContext.xml进行配置的，mybatis-spring也提供了基于注解的方式来配置sqlSessionFactory和Mapper接口。</li>
<li>sqlSessionFactory主要是在@Configuration注解的配置类中使用@Bean注解的名为sqlSessionFactory的方法来配置；</li>
<li>Mapper接口主要是通过在@Configuration注解的配置类中结合@MapperScan注解来指定需要扫描获取mapper接口的包。</li>
</ul>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@Configuration
<strong>@MapperScan(</strong></span><strong>"com.chenhao.mapper"<span style="color: #000000;">)
</span></strong><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> AppConfig {

  @Bean
  </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> DataSource dataSource() {
     </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> EmbeddedDatabaseBuilder()
            .addScript(</span>"schema.sql"<span style="color: #000000;">)
            .build();
  }
 
  @Bean
  </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> DataSourceTransactionManager transactionManager() {
    </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> DataSourceTransactionManager(dataSource());
  }
 
  @Bean
  </span><span style="color: #0000ff;">public</span> SqlSessionFactory sqlSessionFactory() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
    </span><strong><span style="color: #008000;">//</span><span style="color: #008000;">创建SqlSessionFactoryBean对象</span>
    SqlSessionFactoryBean sessionFactory = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlSessionFactoryBean();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">设置数据源</span>
<span style="color: #000000;">    sessionFactory.setDataSource(dataSource());
    </span><span style="color: #008000;">//</span><span style="color: #008000;">设置Mapper.xml路径</span>
    sessionFactory.setMapperLocations(<span style="color: #0000ff;">new</span> PathMatchingResourcePatternResolver().getResources("classpath:mapper/*.xml"<span style="color: #000000;">));
    </span></strong><span style="color: #008000;">//</span><span style="color: #008000;"> 设置MyBatis分页插件</span>
    PageInterceptor pageInterceptor = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PageInterceptor();
    Properties properties </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Properties();
    properties.setProperty(</span>"helperDialect", "mysql"<span style="color: #000000;">);
    pageInterceptor.setProperties(properties);
    sessionFactory.setPlugins(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Interceptor[]{pageInterceptor});
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"><strong> sessionFactory.getObject();</strong>
  }
}</span></code></pre>

<p>最核心的有两点：</p>
<ul>
<li>创建一个SqlSessionFactoryBean，并设置数据源和Mapper.xml路径，其中会解析Mapper.xml文件，最后通过getObject()返回一个SqlSessionFactory 注入Spring容器中</li>
<li>通过@MapperScan扫描所有Mapper接口，扫描过程会将Mapper接口生成MapperFactoryBean这个特殊的Bean，并且在其getObject()通过SqlSession().getMapper(this.mapperInterface)生成每个mapper接口真实的代理类</li>
</ul>
<p><strong>MapperFactoryBean</strong></p>
<src class="cnblogs_code">
<pre><code><span style="color: #008000;">//</span><span style="color: #008000;">最终注入Spring容器的就是这里的返回对象</span>
<span style="color: #0000ff;">public</span> T getObject() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
    </span><span style="color: #008000;">//</span><span style="color: #008000;">获取父类setSqlSessionFactory方法中创建的SqlSessionTemplate
    </span><span style="color: #008000;">//</span><span style="color: #008000;">通过SqlSessionTemplate获取mapperInterface的代理类
    </span><span style="color: #008000;">//</span><span style="color: #008000;">我们例子中就是通过SqlSessionTemplate获取com.chenhao.mapper.UserMapper的代理类
    </span><span style="color: #008000;">//</span><span style="color: #008000;">获取到Mapper接口的代理类后，就把这个Mapper的代理类对象注入Spring容器</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span>.getSqlSession().getMapper(<span style="color: #0000ff;">this</span><span style="color: #000000;">.mapperInterface);
}</span></code></pre>

<p>接下来我们看看SpringBoot是如何引入Mybatis的</p>
<h2>SpringBoot引入Mybatis</h2>
<h3>添加mybatis依赖</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>com.alibaba<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>druid<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.1.9<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.mybatis.spring.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span><strong>mybatis-spring-boot-starter</strong><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.3.2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span></code></pre>

<h3>全局配置文件中配置数据源和mybatis属性</h3>
<src class="cnblogs_code">
<pre><code><strong><span style="color: #000000;">spring:
  datasource:
    url: jdbc:mysql:</span>///<span style="color: #000000;">springboot
    username: root
    password: admin
    </span><span style="color: #ff00ff;">type</span><span style="color: #000000;">: com.alibaba.druid.pool.DruidDataSource
    initialSize: </span><span style="color: #800080;">5</span><span style="color: #000000;">
    minIdle: </span><span style="color: #800080;">5</span><span style="color: #000000;">
    maxActive: </span><span style="color: #800080;">20</span><span style="color: #000000;">
mybatis:
  config</span>-location: classpath:mybatis/mybatis-<span style="color: #000000;">config.xml
  mapper</span>-locations: classpath:mybatis/mapper/*<span style="color: #000000;">.xml
  </span><span style="color: #ff00ff;">type</span>-aliases-package: org.com.cay.spring.boot.entity</strong></code></pre>

<h3><span>加入Mapper扫描注解@MapperScan</span></h3>
<src class="cnblogs_code">
<pre><code><span style="color: #000000;">@SpringBootApplication
@EnableScheduling
@ServletComponentScan
<strong>@MapperScan(</strong></span><strong>"com.supplychain.app.mapper"<span style="color: #000000;">)
</span></strong><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Application {

    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {
        TimeZone.setDefault(TimeZone.getTimeZone(</span>"GMT+8"<span style="color: #000000;">));
        System.setProperty(</span>"user.timezone", "GMT+8"<span style="color: #000000;">);
        SpringApplication.run(Application.</span><span style="color: #0000ff;">class</span><span style="color: #000000;">, args);
    }
}</span></code></pre>

<h2>源码解析</h2>
<h3><strong>mybatis-spring-boot-starter</strong></h3>
<p><img src="./images/SpringBoot 源码解析 （九）----- Spring Boot的核心能力 - 整合Mybatis0.png" alt="" /></p>
<p>我们看到mybatis-spring-boot-starter实际上引入了jdbc的场景启动器，这一块我们上一篇文章已经分析过了，还引入了mybatis-spring的依赖，最终还引入了mybatis-spring-boot-autoconfigure这个依赖，其实mybatis-spring-boot-starter只是引入各种需要的依赖，最核心的代码是在引入的mybatis-spring-boot-autoconfigure这个项目当中，我们来看看这个项目</p>
<p><img src="./images/SpringBoot 源码解析 （九）----- Spring Boot的核心能力 - 整合Mybatis1.png" alt="" /><img src="./images/SpringBoot 源码解析 （九）----- Spring Boot的核心能力 - 整合Mybatis2.png" alt="" /></p>
<p>我们看到mybatis-spring-boot-autoconfigure也像spring-boot-autoconfigure一样配置了spring.factories这个配置文件，并且在配置文件中配置了MybatisAutoConfiguration这个自动配置类，我们知道SpringBoot启动时会获取所有spring.factories配置文件中的自动配置类并且进行解析其中的Bean，那么我们就来看看MybatisAutoConfiguration这个自动配置类做了啥？</p>
<h3>MybatisAutoConfiguration</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #000000;">@org.springframework.context.annotation.Configuration
</span><span style="color: #008080;"> 2</span> @ConditionalOnClass({ SqlSessionFactory.<span style="color: #0000ff;">class</span>, SqlSessionFactoryBean.<span style="color: #0000ff;">class</span><span style="color: #000000;"> })
</span><span style="color: #008080;"> 3</span> @ConditionalOnBean(DataSource.<span style="color: #0000ff;">class</span><span style="color: #000000;">)
</span><strong><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><span style="color: #008000;">引入MybatisProperties配置类</span>
<span style="color: #008080;"> 5</span> @EnableConfigurationProperties(MybatisProperties.<span style="color: #0000ff;">class</span><span style="color: #000000;">)
</span></strong><span style="color: #008080;"> 6</span> @AutoConfigureAfter(DataSourceAutoConfiguration.<span style="color: #0000ff;">class</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MybatisAutoConfiguration {
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> MybatisProperties properties;
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> Interceptor[] interceptors;
</span><span style="color: #008080;">12</span> 
<span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> ResourceLoader resourceLoader;
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> DatabaseIdProvider databaseIdProvider;
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> List&lt;ConfigurationCustomizer&gt;<span style="color: #000000;"> configurationCustomizers;
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MybatisAutoConfiguration(MybatisProperties properties,
</span><span style="color: #008080;">20</span>                                     ObjectProvider&lt;Interceptor[]&gt;<span style="color: #000000;"> interceptorsProvider,
</span><span style="color: #008080;">21</span> <span style="color: #000000;">                                    ResourceLoader resourceLoader,
</span><span style="color: #008080;">22</span>                                     ObjectProvider&lt;DatabaseIdProvider&gt;<span style="color: #000000;"> databaseIdProvider,
</span><span style="color: #008080;">23</span>                                     ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt;<span style="color: #000000;"> configurationCustomizersProvider) {
</span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">this</span>.properties =<span style="color: #000000;"> properties;
</span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">this</span>.interceptors =<span style="color: #000000;"> interceptorsProvider.getIfAvailable();
</span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">this</span>.resourceLoader =<span style="color: #000000;"> resourceLoader;
</span><span style="color: #008080;">27</span>         <span style="color: #0000ff;">this</span>.databaseIdProvider =<span style="color: #000000;"> databaseIdProvider.getIfAvailable();
</span><span style="color: #008080;">28</span>         <span style="color: #0000ff;">this</span>.configurationCustomizers =<span style="color: #000000;"> configurationCustomizersProvider.getIfAvailable();
</span><span style="color: #008080;">29</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span> <span style="color: #000000;">    @Bean
</span><span style="color: #008080;">32</span> <span style="color: #000000;">    @ConditionalOnMissingBean
</span><span style="color: #008080;">33</span>    <strong> <span style="color: #008000;">//</span><span style="color: #008000;">往Spring容器中注入SqlSessionFactory对象
</span><span style="color: #008080;">34</span>     <span style="color: #008000;">//</span><span style="color: #008000;">并且设置数据源、MapperLocations(Mapper.xml路径)等</span></strong>
<span style="color: #008080;">35</span>     <span style="color: #0000ff;">public</span> SqlSessionFactory sqlSessionFactory(DataSource dataSource) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
</span><span style="color: #008080;">36</span>        <strong> SqlSessionFactoryBean factory = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlSessionFactoryBean();
</span></strong><span style="color: #008080;">37</span> <strong><span style="color: #000000;">        factory.setDataSource(dataSource);
</span></strong><span style="color: #008080;">38</span>         factory.setVfs(SpringBootVFS.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
</span><span style="color: #008080;">39</span>         <span style="color: #0000ff;">if</span> (StringUtils.hasText(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getConfigLocation())) {
</span><span style="color: #008080;">40</span>             factory.setConfigLocation(<span style="color: #0000ff;">this</span>.resourceLoader.getResource(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getConfigLocation()));
</span><span style="color: #008080;">41</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">42</span>         Configuration configuration = <span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getConfiguration();
</span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">if</span> (configuration == <span style="color: #0000ff;">null</span> &amp;&amp; !StringUtils.hasText(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getConfigLocation())) {
</span><span style="color: #008080;">44</span>             configuration = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Configuration();
</span><span style="color: #008080;">45</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">46</span>         <span style="color: #0000ff;">if</span> (configuration != <span style="color: #0000ff;">null</span> &amp;&amp; !CollectionUtils.isEmpty(<span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationCustomizers)) {
</span><span style="color: #008080;">47</span>             <span style="color: #0000ff;">for</span> (ConfigurationCustomizer customizer : <span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationCustomizers) {
</span><span style="color: #008080;">48</span> <span style="color: #000000;">                customizer.customize(configuration);
</span><span style="color: #008080;">49</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">50</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">51</span> <span style="color: #000000;">        factory.setConfiguration(configuration);
</span><span style="color: #008080;">52</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.properties.getConfigurationProperties() != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">53</span>             factory.setConfigurationProperties(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getConfigurationProperties());
</span><span style="color: #008080;">54</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">if</span> (!ObjectUtils.isEmpty(<span style="color: #0000ff;">this</span><span style="color: #000000;">.interceptors)) {
</span><span style="color: #008080;">56</span>             factory.setPlugins(<span style="color: #0000ff;">this</span><span style="color: #000000;">.interceptors);
</span><span style="color: #008080;">57</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">58</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.databaseIdProvider != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">59</span>             factory.setDatabaseIdProvider(<span style="color: #0000ff;">this</span><span style="color: #000000;">.databaseIdProvider);
</span><span style="color: #008080;">60</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">61</span>         <span style="color: #0000ff;">if</span> (StringUtils.hasLength(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getTypeAliasesPackage())) {
</span><span style="color: #008080;">62</span>             factory.setTypeAliasesPackage(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getTypeAliasesPackage());
</span><span style="color: #008080;">63</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">64</span>         <span style="color: #0000ff;">if</span> (StringUtils.hasLength(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getTypeHandlersPackage())) {
</span><span style="color: #008080;">65</span>             factory.setTypeHandlersPackage(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getTypeHandlersPackage());
</span><span style="color: #008080;">66</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">if</span> (!ObjectUtils.isEmpty(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.resolveMapperLocations())) {
</span><span style="color: #008080;">68</span>         <strong>    factory.setMapperLocations(<span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.resolveMapperLocations());
</span></strong><span style="color: #008080;">69</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">70</span>       <strong>  <span style="color: #008000;">//</span><span style="color: #008000;">获取SqlSessionFactoryBean的getObject()中的对象注入Spring容器，也就是SqlSessionFactory对象</span>
<span style="color: #008080;">71</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> factory.getObject();
</span></strong><span style="color: #008080;">72</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">73</span> 
<span style="color: #008080;">74</span> <span style="color: #000000;">    @Bean
</span><span style="color: #008080;">75</span> <span style="color: #000000;">    @ConditionalOnMissingBean
</span><span style="color: #008080;">76</span>     <span style="color: #008000;">//</span><span style="color: #008000;">往Spring容器中注入SqlSessionTemplate对象</span>
<span style="color: #008080;">77</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) {
</span><span style="color: #008080;">78</span>         ExecutorType executorType = <span style="color: #0000ff;">this</span><span style="color: #000000;">.properties.getExecutorType();
</span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">if</span> (executorType != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">80</span>           <strong>  <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlSessionTemplate(sqlSessionFactory, executorType);
</span></strong><span style="color: #008080;">81</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">82</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> SqlSessionTemplate(sqlSessionFactory);
</span><span style="color: #008080;">83</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">84</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">85</span>     
<span style="color: #008080;">86</span>     <span style="color: #008000;">//</span><span style="color: #008000;">other code...</span>
<span style="color: #008080;">87</span> }</code></pre>

<p>在自动配置的时候会导入一个Properties配置类MybatisProperties，咱们来看一下</p>
<src class="cnblogs_code">
<pre><code>@ConfigurationProperties(prefix =<span style="color: #000000;"> MybatisProperties.MYBATIS_PREFIX)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MybatisProperties {

    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String MYBATIS_PREFIX = "mybatis"<span style="color: #000000;">;

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Location of MyBatis xml config file.
     </span><span style="color: #008000;">*/</span>
<strong>    <span style="color: #0000ff;">private</span><span style="color: #000000;"> String configLocation;

    </span></strong><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Locations of MyBatis mapper files.
     </span><span style="color: #008000;">*/</span>
 <strong>   <span style="color: #0000ff;">private</span><span style="color: #000000;"> String[] mapperLocations;

    </span></strong><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Packages to search type aliases. (Package delimiters are ",; \t\n")
     </span><span style="color: #008000;">*/</span>
   <strong> <span style="color: #0000ff;">private</span><span style="color: #000000;"> String typeAliasesPackage;

    </span></strong><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Packages to search for type handlers. (Package delimiters are ",; \t\n")
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span><span style="color: #000000;"> String typeHandlersPackage;

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Indicates whether perform presence check of the MyBatis xml config file.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> checkConfigLocation = <span style="color: #0000ff;">false</span><span style="color: #000000;">;

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Execution mode for {</span><span style="color: #808080;">@link</span><span style="color: #008000;"> org.mybatis.spring.SqlSessionTemplate}.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span><span style="color: #000000;"> ExecutorType executorType;

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * Externalized properties for MyBatis configuration.
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span><span style="color: #000000;"> Properties configurationProperties;

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * A Configuration object for customize default settings. If {</span><span style="color: #808080;">@link</span><span style="color: #008000;"> #configLocation}
     * is specified, this property is not used.
     </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @NestedConfigurationProperty
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Configuration configuration;

    </span><span style="color: #008000;">//</span><span style="color: #008000;">other code...</span>
}</code></pre>

<p>​该Properties配置类作用主要用于与yml/properties中以mybatis开头的属性进行一一对应，如下</p>
<src class="cnblogs_code">
<pre><code><strong><span style="color: #000000;">mybatis:
  config-location: classpath:mybatis/mybatis-config.xml
  mapper-locations: classpath:mybatis/mapper/*.xml
  type-aliases-package: org.com.cay.spring.boot.entity</span></strong></code></pre>

<src>​在<strong>MybatisAutoConfiguration</strong>自动配置类中，SpringBoot默认自动配置了两个Bean，分别是<strong>SqlSessionFactory</strong>和<strong>SqlSessionTemplate</strong>。我们看到上面代码中第71行，其实是返回的factory.getObject();，也就是注入Spring容器中的是SqlSessionFactory对象，SqlSessionFactory主要是将Properties配置类中的属性赋值到SqlSessionFactoryBean中，类似以前xml中配置的SqlSessionFactory
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="sqlSessionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.mybatis.spring.SqlSessionFactoryBean"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="<strong>dataSource</strong>"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 自动扫描mapping.xml文件 </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="<strong>mapperLocations</strong>"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="classpath:com/cn/mapper/*.xml"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
        ...
</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>另外一个Bean为SqlSessionTemplate，通过SqlSessionFactory来生成SqlSession代理类：</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SqlSessionTemplate <span style="color: #0000ff;">implements</span><span style="color: #000000;"> SqlSession, DisposableBean {

    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> SqlSessionFactory sqlSessionFactory;

    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> ExecutorType executorType;

    </span><strong><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> SqlSession sqlSessionProxy;

    </span></strong><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> PersistenceExceptionTranslator exceptionTranslator;

    </span><span style="color: #008000;">//</span><span style="color: #008000;">other code...</span>
    
    <span style="color: #0000ff;">public</span><span style="color: #000000;"> SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,
          PersistenceExceptionTranslator exceptionTranslator) {

        notNull(sqlSessionFactory, </span>"Property 'sqlSessionFactory' is required"<span style="color: #000000;">);
        notNull(executorType, </span>"Property 'executorType' is required"<span style="color: #000000;">);

        </span><span style="color: #0000ff;">this</span>.sqlSessionFactory =<span style="color: #000000;"> sqlSessionFactory;
        </span><span style="color: #0000ff;">this</span>.executorType =<span style="color: #000000;"> executorType;
        </span><span style="color: #0000ff;">this</span>.exceptionTranslator =<span style="color: #000000;"> exceptionTranslator;
        
        </span><strong><span style="color: #008000;">//</span><span style="color: #008000;">生成SqlSessioin代理类</span>
        <span style="color: #0000ff;">this</span>.sqlSessionProxy =<span style="color: #000000;"> (SqlSession) newProxyInstance(
            SqlSessionFactory.</span><span style="color: #0000ff;">class</span><span style="color: #000000;">.getClassLoader(),
            </span><span style="color: #0000ff;">new</span> Class[] { SqlSession.<span style="color: #0000ff;">class</span><span style="color: #000000;"> },
            </span><span style="color: #0000ff;">new</span></strong><span style="color: #000000;"><strong> SqlSessionInterceptor());</strong>
    }
}</span></code></pre>

<p>而@MapperScan注解是和Spring整合Mybatis的使用是一样的，都是在配置类上指定Mapper接口的路径，大家可以看一下我以前的一篇文章<a class="entry" href="https://www.cnblogs.com/java-chen-hao/p/11839958.html" target="_blank">Mybaits 源码解析 （十一）----- @MapperScan将Mapper接口生成代理注入到Spring-静态代理和动态代理结合使用</a></p>
<h2 id="h-24">日常求赞</h2>
<p>好了各位，以上就是这篇文章的全部内容了，能看到这里的人呀，都是人才。</p>
<p>如果这个文章写得还不错，觉得学到了一点东西的话&nbsp;求点赞👍&nbsp;对我来说真的&nbsp;非常有用！！！</p>
<p>创作不易，各位的支持和认可，就是我创作的最大动力，我们下篇文章见！</p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>