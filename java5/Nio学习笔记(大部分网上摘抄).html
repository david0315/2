<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Nio学习笔记(大部分网上摘抄)' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Nio学习笔记(大部分网上摘抄)</center></div><div class='banquan'>原文出处:本文由博客园博主暖如骄阳提供。<br/>
原文连接:https://www.cnblogs.com/yangFly/p/11985421.html</div><br>
    <p><span style="color: #000000; font-size: 18pt;">Nio与IO的区别</span></p>
<p><span style="color: #000000; font-size: 18px;">　 原有的 IO 是面向流的、阻塞的，NIO 则是面向块的、非阻塞的。</span></p>
<p><span style="color: #000000; font-size: 18px;">　　　1.<span style="font-size: 16px;">IO流每次从流中读一个或多个字节，直至读完所有字节，他们没有被缓存在其他地方，并且，IO流不能移动流中的数据，</span></span><span style="font-size: 16px;">如果需要前后移动从流中读取的教据，需要先将它缓存到一个缓冲区。Java NIO的缓冲导向方法略有不同。数据读取到一个它稍后处理的缓冲区，霱要时可在缓冲区中前后移动。这就增加了处理过程中的灵活性。但是，还需要检查是否该缓冲区中包含所有您需要处理的数裾。而且，需确保当更多的数据读入缓冲区时，不要覆盖缓冲区里尚未处理的数据。</span></p>
<p>&nbsp;</p>
<p><span style="color: #000000; font-size: 18px;">　　　2.</span><span style="font-size: 16px;">Java IO的各种流是阻塞的。这意味着，当一个线程调用read() 或 write()时，该线程被阻塞，直到有一些数据被读取，或数据完全写入。该线程在此期间不能再干任何事情了。 Java NIO的非阻塞模式，使一个线程从某通道发送请求读取数据，但是它仅能得到目前可用的数据，如果目前没有数据可用时，就什么都不会获取。而不是保持线程阻塞，所以直至数据变的可以读取之前，该线程可以继续做其他的事情。 非阻塞写也是如此。一个线程请求写入一些数据到某通道，但不需要等待它完全写入，这个线程同时可以去做别的事情。 线程通常将非阻塞IO的空闲时间用于在其它通道上执行IO操作，所以一个单独的线程现在可以管理多个输入和输出通道（channel）</span>。、</p>
<h4><span style="font-size: 18pt;">通道Channel</span></h4>
<p><span style="font-size: 18px;">　　NIO的通道类似于流，但有些区别如下：</span></p>
<p><span style="font-size: 16px;">　　　　1. 通道可以同时进行读写，而流只能读或者只能写</span></p>
<p><span style="font-size: 16px;">　　　　2. 通道可以实现异步读写数据</span></p>
<p><span style="font-size: 16px;">　　　　3. 通道可以从缓冲读数据，也可以写数据到缓冲:&nbsp;</span></p>
<p><span style="font-size: 18pt;">缓冲区Buffer类</span></p>
<p><span style="font-size: 14pt;">　　缓冲区是一个对象，有四个基本属性，Nio的读写都是利用Buffer来实现的，简而言之，读取数据先从缓冲区读，写数据也是先写入缓冲区的。我们最常用的是ByteBuffer这个实现类，对于Java中的基本类型都有一个对应的Buffer实现类与之对应，如CharBuffer,DoubleBuffer等等</span></p>
<p><span style="font-size: 16px;">&nbsp; 　　1丶<span style="font-size: 18px;">其中的四个属性的含义分别如下：</span></span><br /><span style="font-size: 16px;">　　　　容量（Capacity）：缓冲区能够容纳的数据元素的最大数量。这一个容量在缓冲区创建时被设定，并且永远不能改变。</span><br /><span style="font-size: 16px;">　　　　上界(Limit)：缓冲区的第一个不能被读或写的元素。或者说,缓冲区中现存元素的计数。</span><br /><span style="font-size: 16px;">　　　　位置(Position)：下一个要被读或写的元素的索引。位置会自动由相应的 get( )和 put( )函数更新。</span><br /><span style="font-size: 16px;">　　　　标记(Mark)：下一个要被读或写的元素的索引。位置会自动由相应的 get( )和 put( )函数更新。</span><br /><span style="font-size: 18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2丶Buffer的常见方法如下所示:</span><span style="font-size: 18px;">　　</span></p>
<p><span style="font-size: 16px;">　　　　flip(): 写模式转换成读模式</span><br /><span style="font-size: 16px;">　　　　rewind()：将 position 重置为 0 ，一般用于重复读。</span><br /><span style="font-size: 16px;">　　　　clear() ：</span><br /><span style="font-size: 16px;">　　　　compact(): 将未读取的数据拷贝到 buffer 的头部位。</span><br /><span style="font-size: 16px;">　　　　mark(): reset():mark 可以标记一个位置， reset 可以重置到该位置</span></p>
<p><span style="font-size: 16px;">　　　3丶读取操作</span></p>
<src class="cnblogs_code" onclick="cnblogs_code_show('fd819a3e-09a3-4473-9291-ba56e75f45db')"><img id="code_img_closed_fd819a3e-09a3-4473-9291-ba56e75f45db" class="code_img_closed" src="./images/Nio学习笔记(大部分网上摘抄)0.png" alt="" /><img id="code_img_opened_fd819a3e-09a3-4473-9291-ba56e75f45db" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('fd819a3e-09a3-4473-9291-ba56e75f45db',event)" src="./images/Nio学习笔记(大部分网上摘抄)1.png" alt="" />
<src id="cnblogs_code_open_fd819a3e-09a3-4473-9291-ba56e75f45db" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;"> 1</span> FileInputStream inputStream = <span style="color: #0000ff;">new</span> FileInputStream("E:\\A.txt"<span style="color: #000000;">);
</span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 3</span> <span style="color: #008000;">         * 拿到通道
</span><span style="color: #008080;"> 4</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 5</span>         FileChannel channel =<span style="color: #000000;"> inputStream.getChannel();
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 8</span> <span style="color: #008000;">         * 创建缓存区
</span><span style="color: #008080;"> 9</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">10</span>         ByteBuffer buffer = ByteBuffer.allocate(1024<span style="color: #000000;">);
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">13</span> <span style="color: #008000;">         * 读取数据到缓冲区
</span><span style="color: #008080;">14</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">15</span> <span style="color: #000000;">        channel.read(buffer);
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span> <span style="color: #000000;">        buffer.flip();
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>         <span style="color: #0000ff;">while</span> (buffer.remaining() &gt; 0<span style="color: #000000;">){
</span><span style="color: #008080;">20</span>             <span style="color: #0000ff;">byte</span> b =<span style="color: #000000;"> buffer.get();
</span><span style="color: #008080;">21</span>             System.out.println(((<span style="color: #0000ff;">char</span><span style="color: #000000;">)b));
</span><span style="color: #008080;">22</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">23</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">24</span> <span style="color: #008000;">         * 关闭流
</span><span style="color: #008080;">25</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">26</span>         inputStream.close();</code></pre>

<span class="cnblogs_code_collapse">View Code</span>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4丶写入操作</p>
<src class="cnblogs_code" onclick="cnblogs_code_show('417b2f11-1d71-459b-a49c-ee038b78e6d0')"><img id="code_img_closed_417b2f11-1d71-459b-a49c-ee038b78e6d0" class="code_img_closed" src="./images/Nio学习笔记(大部分网上摘抄)0.png" alt="" /><img id="code_img_opened_417b2f11-1d71-459b-a49c-ee038b78e6d0" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('417b2f11-1d71-459b-a49c-ee038b78e6d0',event)" src="./images/Nio学习笔记(大部分网上摘抄)1.png" alt="" />
<src id="cnblogs_code_open_417b2f11-1d71-459b-a49c-ee038b78e6d0" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">byte</span> message[] = { 83,83,83,83,83,83<span style="color: #000000;"> };
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> main( String args[] ) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
</span><span style="color: #008080;"> 4</span>         FileOutputStream fout = <span style="color: #0000ff;">new</span> FileOutputStream( "e:\\A.txt"<span style="color: #000000;"> );
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span>         FileChannel fc =<span style="color: #000000;"> fout.getChannel();
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span>         ByteBuffer buffer = ByteBuffer.allocate( 1024<span style="color: #000000;"> );
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i=0; i&lt;message.length; ++<span style="color: #000000;">i) {
</span><span style="color: #008080;">11</span> <span style="color: #000000;">            buffer.put( message[i] );
</span><span style="color: #008080;">12</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span> <span style="color: #000000;">        buffer.flip();
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> <span style="color: #000000;">        fc.write( buffer );
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span> <span style="color: #000000;">        fout.close();
</span><span style="color: #008080;">19</span>     }</code></pre>

<span class="cnblogs_code_collapse">View Code</span>
<p><span style="font-size: 18pt;">选择器Selector</span></p>
<p><span style="font-size: 18pt;">　　</span><span style="font-size: 18px;">可以检测多个NIO channel，看看读或者写事件是否就绪。</span><span style="font-size: 18px;">多个Channel以事件的方式可以注册到同一个Selector，从而达到用一个线程处理多个请求成为可能。</span></p>
<p><span style="font-size: 18px;">　　使用NIO中非阻塞IO编写服务器处理程序，有三个步骤</span></p>
<p><span style="font-size: 16px;">　　　　1.向Selector对象注册感兴趣的事件</span></p>
<p><span style="font-size: 16px;"><em id="__mceDel"><em id="__mceDel">　　　　2.从Selector中获取感兴趣的事件</em></em></span></p>
<p><span style="font-size: 16px;"><em id="__mceDel"><em id="__mceDel">　　　　</em></em><em id="__mceDel"><em id="__mceDel"><em id="__mceDel"><em id="__mceDel">3.根据不同事件进行相应的处理</em></em></em></em></span></p>
<p><img src="./images/Nio学习笔记(大部分网上摘抄)4.png" alt="" /></p>
<p>&nbsp;</p>
<p>&nbsp;简单API介绍</p>
<p>　　open：创建selector<br />&nbsp; &nbsp; &nbsp; &nbsp;selectKeys:获取可用channel的集合<br />&nbsp; &nbsp; &nbsp; &nbsp;select:选择就绪的通道</p>
<p><span style="font-size: 18pt;">简单聊天室实现思路代码</span></p>
<p><span style="font-size: 18px;">服务器代码</span></p>
<p>&nbsp;</p>
<src class="cnblogs_code" onclick="cnblogs_code_show('8fe73535-36d7-4a59-aaa1-c2ff15bf96f8')"><img id="code_img_closed_8fe73535-36d7-4a59-aaa1-c2ff15bf96f8" class="code_img_closed" src="./images/Nio学习笔记(大部分网上摘抄)0.png" alt="" /><img id="code_img_opened_8fe73535-36d7-4a59-aaa1-c2ff15bf96f8" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('8fe73535-36d7-4a59-aaa1-c2ff15bf96f8',event)" src="./images/Nio学习笔记(大部分网上摘抄)1.png" alt="" />
<src id="cnblogs_code_open_8fe73535-36d7-4a59-aaa1-c2ff15bf96f8" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;">  1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> NioServer {
</span><span style="color: #008080;">  2</span> 
<span style="color: #008080;">  3</span> 
<span style="color: #008080;">  4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> start() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
</span><span style="color: #008080;">  5</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">  6</span> <span style="color: #008000;">         * 1.创建selector
</span><span style="color: #008080;">  7</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">  8</span>         Selector selector =<span style="color: #000000;"> Selector.open();
</span><span style="color: #008080;">  9</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 10</span> <span style="color: #008000;">         * 2.通过ServerSocketChannel创建channel
</span><span style="color: #008080;"> 11</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 12</span>         ServerSocketChannel serverSocketChannel =<span style="color: #000000;"> ServerSocketChannel.open();
</span><span style="color: #008080;"> 13</span> 
<span style="color: #008080;"> 14</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 15</span> <span style="color: #008000;">         * 3.为channel通道绑定监听端口
</span><span style="color: #008080;"> 16</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 17</span>         serverSocketChannel.bind(<span style="color: #0000ff;">new</span> InetSocketAddress(8000<span style="color: #000000;">));
</span><span style="color: #008080;"> 18</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 19</span> <span style="color: #008000;">         * 4.设置channel 为非阻塞模式
</span><span style="color: #008080;"> 20</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 21</span>         serverSocketChannel.configureBlocking(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 22</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 23</span> <span style="color: #008000;">         * 5.将channel 注册到selector，监听连接
</span><span style="color: #008080;"> 24</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 25</span> <span style="color: #000000;">        serverSocketChannel.register(selector,SelectionKey.OP_ACCEPT);
</span><span style="color: #008080;"> 26</span>         System.out.println("服务器启动成功"<span style="color: #000000;">);
</span><span style="color: #008080;"> 27</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 28</span> <span style="color: #008000;">         * 6.循环等待新接入的连接
</span><span style="color: #008080;"> 29</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;">(;;){
</span><span style="color: #008080;"> 31</span>             <span style="color: #0000ff;">int</span> select =<span style="color: #000000;"> selector.select();
</span><span style="color: #008080;"> 32</span>             <span style="color: #0000ff;">if</span> (select == 0<span style="color: #000000;">){
</span><span style="color: #008080;"> 33</span>                 <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 34</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 35</span> 
<span style="color: #008080;"> 36</span>             <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 37</span> <span style="color: #008000;">             * 7.获取可用channel的集合
</span><span style="color: #008080;"> 38</span>              <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 39</span>             Set&lt;SelectionKey&gt; keys =<span style="color: #000000;"> selector.selectedKeys();
</span><span style="color: #008080;"> 40</span>             Iterator&lt;SelectionKey&gt; iterator =<span style="color: #000000;"> keys.iterator();
</span><span style="color: #008080;"> 41</span>             <span style="color: #0000ff;">while</span><span style="color: #000000;"> (iterator.hasNext()){
</span><span style="color: #008080;"> 42</span>                 SelectionKey selectionKey =<span style="color: #000000;"> (SelectionKey) iterator.next();
</span><span style="color: #008080;"> 43</span>                 <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 44</span> <span style="color: #008000;">                 * 8.移除selctionKey
</span><span style="color: #008080;"> 45</span>                  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 46</span> <span style="color: #000000;">                iterator.remove();
</span><span style="color: #008080;"> 47</span>                 <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 48</span> <span style="color: #008000;">                 * 处理具体业务逻辑
</span><span style="color: #008080;"> 49</span>                  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 50</span>                 <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 51</span> <span style="color: #008000;">                 * 接入事件
</span><span style="color: #008080;"> 52</span>                  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 53</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (selectionKey.isAcceptable()){
</span><span style="color: #008080;"> 54</span> <span style="color: #000000;">                    acceptHandler(serverSocketChannel,selector);
</span><span style="color: #008080;"> 55</span> <span style="color: #000000;">                }
</span><span style="color: #008080;"> 56</span>                 <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 57</span> <span style="color: #008000;">                 * 可读事件
</span><span style="color: #008080;"> 58</span>                  <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 59</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;">(selectionKey.isReadable()){
</span><span style="color: #008080;"> 60</span> <span style="color: #000000;">                    readHandler(selectionKey, selector);
</span><span style="color: #008080;"> 61</span> <span style="color: #000000;">                }
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 63</span> 
<span style="color: #008080;"> 64</span> 
<span style="color: #008080;"> 65</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 66</span> 
<span style="color: #008080;"> 67</span> 
<span style="color: #008080;"> 68</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 69</span> <span style="color: #008000;">         * 根据就绪状态，调用对应方法处理业务逻辑
</span><span style="color: #008080;"> 70</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 71</span> 
<span style="color: #008080;"> 72</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 73</span> 
<span style="color: #008080;"> 74</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 75</span> <span style="color: #008000;">     * 接入事件处理器
</span><span style="color: #008080;"> 76</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 77</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> acceptHandler(ServerSocketChannel serverSocketChannel, Selector selector) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
</span><span style="color: #008080;"> 78</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 79</span> <span style="color: #008000;">         * 如果是接入事件 创建serverSocket
</span><span style="color: #008080;"> 80</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 81</span>         SocketChannel socketChannel =<span style="color: #000000;"> serverSocketChannel.accept();
</span><span style="color: #008080;"> 82</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 83</span> <span style="color: #008000;">         * 设置非阻塞
</span><span style="color: #008080;"> 84</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 85</span>         socketChannel.configureBlocking(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 86</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 87</span> <span style="color: #008000;">         * 注册进selector中
</span><span style="color: #008080;"> 88</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 89</span> <span style="color: #000000;">        socketChannel.register(selector, SelectionKey.OP_READ);
</span><span style="color: #008080;"> 90</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 91</span> <span style="color: #008000;">         * 回复服务端信息
</span><span style="color: #008080;"> 92</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 93</span>         socketChannel.write(Charset.forName("UTF-8").encode("你与聊天室里其他人都不是朋友关系,请注意隐私安全"<span style="color: #000000;">));
</span><span style="color: #008080;"> 94</span> 
<span style="color: #008080;"> 95</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 96</span> 
<span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span>  readHandler(SelectionKey selectionKey, Selector selector) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{
</span><span style="color: #008080;"> 98</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 99</span> <span style="color: #008000;">         * 要用selectionKey中获取已经就绪的channel
</span><span style="color: #008080;">100</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">101</span>         SocketChannel channel =<span style="color: #000000;"> (SocketChannel)selectionKey.channel();
</span><span style="color: #008080;">102</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">103</span> <span style="color: #008000;">         * 创建buffer
</span><span style="color: #008080;">104</span>           <span style="color: #008000;">*/</span>
<span style="color: #008080;">105</span>         ByteBuffer buffer = ByteBuffer.allocate(1024<span style="color: #000000;">);
</span><span style="color: #008080;">106</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">107</span> <span style="color: #008000;">         * 循环读取客户端数据
</span><span style="color: #008080;">108</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">109</span>         String request = ""<span style="color: #000000;">;
</span><span style="color: #008080;">110</span>         <span style="color: #0000ff;">while</span> (channel.read(buffer) &gt; 0<span style="color: #000000;">){
</span><span style="color: #008080;">111</span>             <span style="color: #008000;">/**</span>
<span style="color: #008080;">112</span> <span style="color: #008000;">             * 切换读模式
</span><span style="color: #008080;">113</span>              <span style="color: #008000;">*/</span>
<span style="color: #008080;">114</span> <span style="color: #000000;">            buffer.flip();
</span><span style="color: #008080;">115</span>             <span style="color: #008000;">/**</span>
<span style="color: #008080;">116</span> <span style="color: #008000;">             * 读取buffer中的内容
</span><span style="color: #008080;">117</span>              <span style="color: #008000;">*/</span>
<span style="color: #008080;">118</span>             request  += Charset.forName("UTF-8"<span style="color: #000000;">).decode(buffer);
</span><span style="color: #008080;">119</span> 
<span style="color: #008080;">120</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">121</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">122</span> <span style="color: #008000;">         * 讲channel注册到selector上
</span><span style="color: #008080;">123</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">124</span> <span style="color: #000000;">        channel.register(selector, SelectionKey.OP_READ);
</span><span style="color: #008080;">125</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">126</span> <span style="color: #008000;">         * 讲客户端发送的请求信息，广播给其他客户端
</span><span style="color: #008080;">127</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">128</span>         <span style="color: #0000ff;">if</span> (request.length() &gt; 0<span style="color: #000000;">){
</span><span style="color: #008080;">129</span> <span style="color: #000000;">            broadCast(selector, channel, request);
</span><span style="color: #008080;">130</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">131</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">132</span> 
<span style="color: #008080;">133</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> broadCast(Selector selector, SocketChannel socketChannel, String request){
</span><span style="color: #008080;">134</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">135</span> <span style="color: #008000;">         * 获取到已接入的客户端hannel
</span><span style="color: #008080;">136</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">137</span>         Set&lt;SelectionKey&gt; selectionKeys =<span style="color: #000000;"> selector.keys();
</span><span style="color: #008080;">138</span>         selectionKeys.forEach(selectionKey -&gt;<span style="color: #000000;"> {
</span><span style="color: #008080;">139</span>             Channel channel =<span style="color: #000000;"> selectionKey.channel();
</span><span style="color: #008080;">140</span>             <span style="color: #0000ff;">if</span> (channel  <span style="color: #0000ff;">instanceof</span> SocketChannel &amp;&amp;
<span style="color: #008080;">141</span>                     channel !=<span style="color: #000000;"> socketChannel){
</span><span style="color: #008080;">142</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">143</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">将信息发送到channel客户端</span>
<span style="color: #008080;">144</span>                     ((SocketChannel) channel).write(Charset.forName("UTF-8"<span style="color: #000000;">).encode(request));
</span><span style="color: #008080;">145</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;">146</span> <span style="color: #000000;">                    e.printStackTrace();
</span><span style="color: #008080;">147</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">148</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">149</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">150</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">151</span> <span style="color: #008000;">         * 循环向所有channel广播信息
</span><span style="color: #008080;">152</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">153</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">154</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;">155</span> <span style="color: #008000;">     *
</span><span style="color: #008080;">156</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> args
</span><span style="color: #008080;">157</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;">158</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
</span><span style="color: #008080;">159</span>         NioServer server = <span style="color: #0000ff;">new</span><span style="color: #000000;"> NioServer();
</span><span style="color: #008080;">160</span> <span style="color: #000000;">        server.start();
</span><span style="color: #008080;">161</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">162</span> }</code></pre>

<span class="cnblogs_code_collapse">View Code</span>
<p>&nbsp;</p>
<p><span style="font-size: 18px;">客户端代码</span></p>
<src class="cnblogs_code" onclick="cnblogs_code_show('a02087d5-9135-4dc8-9ed3-b7a8555f1959')"><img id="code_img_closed_a02087d5-9135-4dc8-9ed3-b7a8555f1959" class="code_img_closed" src="./images/Nio学习笔记(大部分网上摘抄)0.png" alt="" /><img id="code_img_opened_a02087d5-9135-4dc8-9ed3-b7a8555f1959" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('a02087d5-9135-4dc8-9ed3-b7a8555f1959',event)" src="./images/Nio学习笔记(大部分网上摘抄)1.png" alt="" />
<src id="cnblogs_code_open_a02087d5-9135-4dc8-9ed3-b7a8555f1959" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> NioClient {
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> start() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
</span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 6</span> <span style="color: #008000;">         * 连接服务器
</span><span style="color: #008080;"> 7</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 8</span>         SocketChannel socketChannel = SocketChannel.open(<span style="color: #0000ff;">new</span> InetSocketAddress("127.0.0.1", 8000<span style="color: #000000;">));
</span><span style="color: #008080;"> 9</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">10</span> <span style="color: #008000;">         * 接收服务器地址
</span><span style="color: #008080;">11</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">12</span>         Selector selector =<span style="color: #000000;"> Selector.open();
</span><span style="color: #008080;">13</span>         socketChannel.configureBlocking(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
</span><span style="color: #008080;">14</span> <span style="color: #000000;">        socketChannel.register(selector, SelectionKey.OP_READ);
</span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">new</span> Thread(<span style="color: #0000ff;">new</span><span style="color: #000000;"> NioClientHandler(selector)).start();
</span><span style="color: #008080;">16</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">17</span> <span style="color: #008000;">         * 向服务器发送数据
</span><span style="color: #008080;">18</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">19</span>         Scanner scanner = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Scanner(System.in);
</span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">while</span><span style="color: #000000;"> (scanner.hasNextLine()){
</span><span style="color: #008080;">21</span>             String next =<span style="color: #000000;"> scanner.nextLine();
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (StringUtils.isNotBlank(next)){
</span><span style="color: #008080;">23</span>                 socketChannel.write(Charset.forName("UTF-8"<span style="color: #000000;">).encode(next));
</span><span style="color: #008080;">24</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">25</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">26</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {
</span><span style="color: #008080;">29</span>         <span style="color: #0000ff;">new</span><span style="color: #000000;"> NioClient().start();
</span><span style="color: #008080;">30</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">31</span> }</code></pre>

<span class="cnblogs_code_collapse">View Code</span>
<p>客户端线程类</p>
<src class="cnblogs_code" onclick="cnblogs_code_show('98735aa1-1ca5-4ac0-bf94-e8bc349e8d4f')"><img id="code_img_closed_98735aa1-1ca5-4ac0-bf94-e8bc349e8d4f" class="code_img_closed" src="./images/Nio学习笔记(大部分网上摘抄)0.png" alt="" /><img id="code_img_opened_98735aa1-1ca5-4ac0-bf94-e8bc349e8d4f" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('98735aa1-1ca5-4ac0-bf94-e8bc349e8d4f',event)" src="./images/Nio学习笔记(大部分网上摘抄)1.png" alt="" />
<src id="cnblogs_code_open_98735aa1-1ca5-4ac0-bf94-e8bc349e8d4f" class="cnblogs_code_hide">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NioClientHandler <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Runnable {
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Selector selector;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> NioClientHandler(Selector selector) {
</span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">this</span>.selector =<span style="color: #000000;"> selector;
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span> <span style="color: #000000;">    @Override
</span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {
</span><span style="color: #008080;">11</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">12</span> <span style="color: #008000;">         * 循环等待新接入的连接
</span><span style="color: #008080;">13</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">14</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">for</span><span style="color: #000000;">(;;){
</span><span style="color: #008080;">16</span>                 <span style="color: #0000ff;">int</span> select = 0<span style="color: #000000;">;
</span><span style="color: #008080;">17</span>                 select =<span style="color: #000000;"> selector.select();
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>                 <span style="color: #0000ff;">if</span> (select == 0<span style="color: #000000;">){
</span><span style="color: #008080;">20</span>                     <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">21</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">22</span> 
<span style="color: #008080;">23</span>                 <span style="color: #008000;">/**</span>
<span style="color: #008080;">24</span> <span style="color: #008000;">                 * 获取可用channel的集合
</span><span style="color: #008080;">25</span>                  <span style="color: #008000;">*/</span>
<span style="color: #008080;">26</span>                 Set&lt;SelectionKey&gt; keys =<span style="color: #000000;"> selector.selectedKeys();
</span><span style="color: #008080;">27</span>                 Iterator&lt;SelectionKey&gt; iterator =<span style="color: #000000;"> keys.iterator();
</span><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">while</span><span style="color: #000000;"> (iterator.hasNext()){
</span><span style="color: #008080;">29</span>                     SelectionKey selectionKey =<span style="color: #000000;"> (SelectionKey) iterator.next();
</span><span style="color: #008080;">30</span>                     <span style="color: #008000;">/**</span>
<span style="color: #008080;">31</span> <span style="color: #008000;">                     * 移除selctionKey
</span><span style="color: #008080;">32</span>                      <span style="color: #008000;">*/</span>
<span style="color: #008080;">33</span> <span style="color: #000000;">                    iterator.remove();
</span><span style="color: #008080;">34</span>                     <span style="color: #008000;">/**</span>
<span style="color: #008080;">35</span> <span style="color: #008000;">                     * 可读事件
</span><span style="color: #008080;">36</span>                      <span style="color: #008000;">*/</span>
<span style="color: #008080;">37</span>                     <span style="color: #0000ff;">if</span><span style="color: #000000;">(selectionKey.isReadable()){
</span><span style="color: #008080;">38</span> <span style="color: #000000;">                        readHandler(selectionKey, selector);
</span><span style="color: #008080;">39</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;">40</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">41</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">42</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
</span><span style="color: #008080;">43</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;">44</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">45</span> 
<span style="color: #008080;">46</span> 
<span style="color: #008080;">47</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">48</span> 
<span style="color: #008080;">49</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span>  readHandler(SelectionKey selectionKey, Selector selector) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{
</span><span style="color: #008080;">50</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">51</span> <span style="color: #008000;">         * 要用selectionKey中获取已经就绪的channel
</span><span style="color: #008080;">52</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">53</span>         SocketChannel channel =<span style="color: #000000;"> (SocketChannel)selectionKey.channel();
</span><span style="color: #008080;">54</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">55</span> <span style="color: #008000;">         * 创建buffer
</span><span style="color: #008080;">56</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">57</span>         ByteBuffer buffer = ByteBuffer.allocate(1024<span style="color: #000000;">);
</span><span style="color: #008080;">58</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">59</span> <span style="color: #008000;">         * 循环读取客户端数据
</span><span style="color: #008080;">60</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">61</span>         String request = ""<span style="color: #000000;">;
</span><span style="color: #008080;">62</span>         <span style="color: #0000ff;">while</span> (channel.read(buffer) &gt; 0<span style="color: #000000;">){
</span><span style="color: #008080;">63</span>             <span style="color: #008000;">/**</span>
<span style="color: #008080;">64</span> <span style="color: #008000;">             * 切换读模式
</span><span style="color: #008080;">65</span>              <span style="color: #008000;">*/</span>
<span style="color: #008080;">66</span> <span style="color: #000000;">            buffer.flip();
</span><span style="color: #008080;">67</span>             <span style="color: #008000;">/**</span>
<span style="color: #008080;">68</span> <span style="color: #008000;">             * 读取buffer中的内容
</span><span style="color: #008080;">69</span>              <span style="color: #008000;">*/</span>
<span style="color: #008080;">70</span>             request  += Charset.forName("UTF-8"<span style="color: #000000;">).decode(buffer);
</span><span style="color: #008080;">71</span> 
<span style="color: #008080;">72</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">73</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">74</span> <span style="color: #008000;">         * 讲channel注册到selector上
</span><span style="color: #008080;">75</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">76</span> <span style="color: #000000;">        channel.register(selector, SelectionKey.OP_READ);
</span><span style="color: #008080;">77</span>         <span style="color: #008000;">/**</span>
<span style="color: #008080;">78</span> <span style="color: #008000;">         * 讲客户端发送的请求信息，广播给其他客户端
</span><span style="color: #008080;">79</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">80</span>         <span style="color: #0000ff;">if</span> (request.length() &gt; 0<span style="color: #000000;">){
</span><span style="color: #008080;">81</span> <span style="color: #000000;">            System.out.println(request);
</span><span style="color: #008080;">82</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">83</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">84</span> }</code></pre>

<span class="cnblogs_code_collapse">View Code</span>
<p>&nbsp;</p>
<p><span style="font-size: 18px;"><em id="__mceDel">&nbsp;</em></span></p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>