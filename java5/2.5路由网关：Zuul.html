<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修2.5路由网关：Zuul' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>2.5路由网关：Zuul</center></div><div class='banquan'>原文出处:本文由博客园博主wm根mw提供。<br/>
原文连接:https://www.cnblogs.com/sovy/p/11549161.html</div><br>
    <p>在原有的工程上，创建一个新的工程</p>
<h3 id="三创建service-zuul工程">创建service-zuul工程</h3>
<p>其pom.xml文件如下：</p>
<p>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br />    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br /> <br />    &lt;groupId&gt;com.forezp&lt;/groupId&gt;<br />    &lt;artifactId&gt;service-zuul&lt;/artifactId&gt;<br />    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;<br />    &lt;packaging&gt;jar&lt;/packaging&gt;<br /> <br />    &lt;name&gt;service-zuul&lt;/name&gt;<br />    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;<br /> <br />    &lt;parent&gt;<br />        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br />        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;<br />        &lt;version&gt;1.5.2.RELEASE&lt;/version&gt;<br />        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;<br />    &lt;/parent&gt;<br /> <br />    &lt;properties&gt;<br />        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br />        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;<br />        &lt;java.version&gt;1.8&lt;/java.version&gt;<br />    &lt;/properties&gt;<br /> <br />    &lt;dependencies&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;<br />        &lt;/dependency&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-cloud-starter-zuul&lt;/artifactId&gt;<br />        &lt;/dependency&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br />        &lt;/dependency&gt;<br /> <br />        &lt;dependency&gt;<br />            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br />            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br />            &lt;scope&gt;test&lt;/scope&gt;<br />        &lt;/dependency&gt;<br />    &lt;/dependencies&gt;<br /> <br />    &lt;dependencyManagement&gt;<br />        &lt;dependencies&gt;<br />            &lt;dependency&gt;<br />                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br />                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;<br />                &lt;version&gt;Dalston.RC1&lt;/version&gt;<br />                &lt;type&gt;pom&lt;/type&gt;<br />                &lt;scope&gt;import&lt;/scope&gt;<br />            &lt;/dependency&gt;<br />        &lt;/dependencies&gt;<br />    &lt;/dependencyManagement&gt;<br /> <br />    &lt;build&gt;<br />        &lt;plugins&gt;<br />            &lt;plugin&gt;<br />                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br />                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;<br />            &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /> <br />    &lt;repositories&gt;<br />        &lt;repository&gt;<br />            &lt;id&gt;spring-milestones&lt;/id&gt;<br />            &lt;name&gt;Spring Milestones&lt;/name&gt;<br />            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;<br />            &lt;snapshots&gt;<br />                &lt;enabled&gt;false&lt;/enabled&gt;<br />            &lt;/snapshots&gt;<br />        &lt;/repository&gt;<br />    &lt;/repositories&gt;<br /> <br /> <br />&lt;/project&gt;</p>
<p>在其入口applicaton类加上注解@EnableZuulProxy，开启zuul的功能：</p>
<p>@EnableZuulProxy<br />@EnableEurekaClient<br />@SpringBootApplication<br />public class ServiceZuulApplication {<br /> <br />    public static void main(String[] args) {<br />        SpringApplication.run(ServiceZuulApplication.class, args);<br />    }<br />}<br /> </p>
<p>加上配置文件application.yml加上以下的配置代码：</p>
<p>eureka:<br />  client:<br />    serviceUrl:<br />      defaultZone: http://localhost:8761/eureka/<br />server:<br />  port: 8769<br />spring:<br />  application:<br />    name: service-zuul<br />zuul:<br />  routes:<br />    api-a:<br />      path: /api-a/**<br />      serviceId: service-ribbon<br />    api-b:<br />      path: /api-b/**<br />      serviceId: service-feign</p>
<p>首先指定服务注册中心的地址为http://localhost:8765/eureka/，服务的端口为8769，服务名为service-zuul；以/api-a/ 开头的请求都转发给service-ribbon服务；以/api-b/开头的请求都转发给service-feign服务；</p>
<p>依次运行这五个工程;打开浏览器访问：http://localhost:8769/api-a/hi?name=forezp ;浏览器显示：</p>
<p>hi forezp,i am from port:8762</p>
<p>这说明zuul起到了路由的作用</p>
<h3 id="四服务过滤">服务过滤</h3>
<p>zuul不仅只是路由，并且还能过滤，做一些安全验证。继续改造工程；</p>
<p>@Component<br />public class MyFilter extends ZuulFilter{<br /> <br />    private static Logger log = LoggerFactory.getLogger(MyFilter.class);<br />    @Override<br />    public String filterType() {<br />        return "pre";<br />    }<br /> <br />    @Override<br />    public int filterOrder() {<br />        return 0;<br />    }<br /> <br />    @Override<br />    public boolean shouldFilter() {<br />        return true;<br />    }<br /> <br />    @Override<br />    public Object run() {<br />        RequestContext ctx = RequestContext.getCurrentContext();<br />        HttpServletRequest request = ctx.getRequest();<br />        log.info(String.format("%s &gt;&gt;&gt; %s", request.getMethod(), request.getRequestURL().toString()));<br />        Object accessToken = request.getParameter("token");<br />        if(accessToken == null) {<br />            log.warn("token is empty");<br />            ctx.setSendZuulResponse(false);<br />            ctx.setResponseStatusCode(401);<br />            try {<br />                ctx.getResponse().getWriter().write("token is empty");<br />            }catch (Exception e){}<br /> <br />            return null;<br />        }<br />        log.info("ok");<br />        return null;<br />    }<br />}</p>
<p>filterType：返回一个字符串代表过滤器的类型，在zuul中定义了四种不同生命周期的过滤器类型，具体如下：<br />pre：路由之前<br />routing：路由之时<br />post： 路由之后<br />error：发送错误调用<br />filterOrder：过滤的顺序<br />shouldFilter：这里可以写逻辑判断，是否要过滤，本文true,永远过滤。<br />run：过滤器的具体逻辑。可用很复杂，包括查sql，nosql去判断该请求到底有没有权限访问。<br />这时访问：http://localhost:8769/api-a/hi?name=forezp ；网页显示：</p>
<p>token is empty</p>
<p>访问 http://localhost:8769/api-a/hi?name=forezp&amp;token=22 ；<br />网页显示：</p>
<p>hi forezp,i am from port:8762</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>