<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修手写MVC框架（二）-代码实现和使用示例' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>手写MVC框架（二）-代码实现和使用示例</center></div><div class='banquan'>原文出处:本文由博客园博主水木桶提供。<br/>
原文连接:https://www.cnblogs.com/shuimutong/p/11487124.html</div><br>
    <p>--------上一篇：<a id="post_title_link_11456831" href="https://www.cnblogs.com/shuimutong/p/11456831.html">手写MVC框架（一）-再出发</a>-----</p>
<h1>背景</h1>
<p>书接上文，之前整理了实现MVC框架需要写哪些东西。这周粗看了一下，感觉也没多少工作量，所以就计划一天时间来完成。周末的时间，哪会那么老实的坐在电脑前写代码呢？看电影的时候应该是老实的。为了不给自己留遗憾，所以今天就接着写了，然后就写完了。</p>
<h1>一、主要代码结构</h1>
<src class="cnblogs_code">
<pre><code>.
├── annotation 
│   ├── XAutowired.java //用于依赖注入
│   ├── XComponent.java //资源管理
│   ├── XController.java //资源管理-controller
│   ├── XRepository.java //资源管理-资源层
│   ├── XRequestMapping.java //资源uri
│   └── XService.java //资源管理-service
├── bean
│   ├── EntityBean.java //存储实例化的资源
│   └── SystemConst.java
├── handler
│   └── XDispatcherServlet.java //核心调度类
├── mapper
│   ├── InstanceManager.java //资源实例管理
│   └── ServletMapper.java //请求路径-资源映射
└── util
├── ClazzUtil.java
├── CommonUtil.java
└── RequestResolveUtil.java</code></pre>

<h1>二、主要流程</h1>
<p>1、服务启动，加载XDispatcherServlet</p>
<p>2、XDispatcherServlet初始化，调用InstanceManager进行对象初始化、依赖注入</p>
<p>3、调用ServletMapper扫描编写的各个URI</p>
<p>4、请求到达XDispatcherServlet时，通过ServletMapper匹配到对应的方法</p>
<p>5、执行匹配到的方法</p>
<h1>三、InstanceManager实现</h1>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.gmvc.mapper;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.annotation.Annotation;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Field;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Collection;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashSet;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Set;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.commons.lang3.StringUtils;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.reflections.Reflections;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XAutowired;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XComponent;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XController;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XRepository;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.bean.EntityBean;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.bean.SystemConst;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.util.ClazzUtil;

</span><span style="color: #008000;">/**</span><span style="color: #008000;">
 * 实例管理
 * @ClassName:  InstanceManager   
 * @Description:(这里用一句话描述这个类的作用)   
 * </span><span style="color: #808080;">@author</span><span style="color: #008000;">: 水木桶
 * @date:   2019年9月7日 下午10:08:27     
 * @Copyright: 2019 [水木桶]  All rights reserved.
 </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> InstanceManager {
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">被注解的类*</span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Map&lt;String, EntityBean&gt; CLASS_ENTITY_MAP = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HashMap();
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">被XController注解的类*</span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Set&lt;EntityBean&gt; CONTROLLER_CLASS_ENTITY_MAP = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HashSet();
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 初始化
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> conf
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> InstantiationException
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IllegalAccessException
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> init(Map&lt;String, String&gt; conf) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InstantiationException, IllegalAccessException {
        String basePackageStr </span>=<span style="color: #000000;"> conf.get(SystemConst.BASE_PACKAGE);
        //扫描通过框架管理的资源<br />        scanAnnotationedResources(basePackageStr);<br />　　　　　//实例化通过框架管理的资源
        generateAnnotationedEntity();
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 获取controller类
     * </span><span style="color: #808080;">@return</span>
     <span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Set&lt;EntityBean&gt;<span style="color: #000000;"> getControllerClazzes() {
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> CONTROLLER_CLASS_ENTITY_MAP;
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 根据类（被框架管理的类）获取对应的实例对象
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> clazz
     * </span><span style="color: #808080;">@return</span>
     <span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> EntityBean getEntityByClazz(Class clazz) {
        String className </span>=<span style="color: #000000;"> ClazzUtil.getClazzName(clazz);
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> CLASS_ENTITY_MAP.get(className);
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 扫描需要框架管理的类
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> basePackageStr
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> scanAnnotationedResources(String basePackageStr) {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(StringUtils.isBlank(basePackageStr)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
        }
        String[] basePackages </span>= basePackageStr.split(","<span style="color: #000000;">);
        Reflections reflections </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Reflections(basePackages);
        Class</span>&lt;?&gt;[] annotations = {XController.<span style="color: #0000ff;">class</span>, XService.<span style="color: #0000ff;">class</span>, XRepository.<span style="color: #0000ff;">class</span>, XComponent.<span style="color: #0000ff;">class</span><span style="color: #000000;">};
        </span><span style="color: #0000ff;">for</span>(Class&lt;?&gt;<span style="color: #000000;"> annotation : annotations) {
            Set</span>&lt;Class&lt;?&gt;&gt; resourceClazzes =<span style="color: #000000;"> reflections
                    .getTypesAnnotatedWith((Class</span>&lt;? <span style="color: #0000ff;">extends</span> Annotation&gt;<span style="color: #000000;">) annotation);
            </span><span style="color: #0000ff;">for</span>(Class&lt;?&gt;<span style="color: #000000;"> resourceClazz : resourceClazzes) {
                String className </span>=<span style="color: #000000;"> ClazzUtil.getClazzName(resourceClazz);
                CLASS_ENTITY_MAP.put(className, </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> EntityBean(className, resourceClazz));
                </span><span style="color: #0000ff;">if</span>(resourceClazz.isAnnotationPresent(XController.<span style="color: #0000ff;">class</span><span style="color: #000000;">)) {
                    CONTROLLER_CLASS_ENTITY_MAP.add(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> EntityBean(className, resourceClazz));
                }
            }
        }
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 对通过框架管理的类进行实例化
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IllegalAccessException 
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> InstantiationException 
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> generateAnnotationedEntity() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InstantiationException, IllegalAccessException {
        </span><span style="color: #008000;">//</span><span style="color: #008000;">先根据构造方法初始化bean</span>
<span style="color: #000000;">        initBeanInstance(CLASS_ENTITY_MAP.values());
        Set</span>&lt;String&gt; clazzNames =<span style="color: #000000;"> CLASS_ENTITY_MAP.keySet();
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(String clazzName : clazzNames) {
            EntityBean entityBean </span>=<span style="color: #000000;"> CLASS_ENTITY_MAP.get(clazzName);
            initBeanAutowired(entityBean);
        }
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 初始化实例对象
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> classEntityMap
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IllegalAccessException 
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> InstantiationException 
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> initBeanInstance(Collection&lt;EntityBean&gt; entityBeans) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InstantiationException, IllegalAccessException {
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(EntityBean entityBean : entityBeans) {
            </span><span style="color: #0000ff;">if</span>(entityBean.getO() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                Class</span>&lt;?&gt; destClazz =<span style="color: #000000;"> entityBean.getClazz();
                entityBean.setO(destClazz.newInstance());
            }
        }
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 初始化bean中注入的类
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> entityBean
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IllegalArgumentException
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> IllegalAccessException
     * </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> InstantiationException
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> initBeanAutowired(EntityBean entityBean) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IllegalArgumentException, IllegalAccessException, InstantiationException {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(entityBean.isFullAutowired()) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
        }
        Class</span>&lt;?&gt; destClazz =<span style="color: #000000;"> entityBean.getClazz();
        Field[] fields </span>=<span style="color: #000000;"> destClazz.getDeclaredFields();
        Object entityInstance </span>=<span style="color: #000000;"> entityBean.getO();
        Collection</span>&lt;EntityBean&gt; entityBeans =<span style="color: #000000;"> CLASS_ENTITY_MAP.values();
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(Field field : fields) {
            </span><span style="color: #0000ff;">if</span>(!field.isAnnotationPresent(XAutowired.<span style="color: #0000ff;">class</span><span style="color: #000000;">)) {
                </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;
            }
            field.setAccessible(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);
            Object fieldVal </span>=<span style="color: #000000;"> field.get(entityInstance);
            </span><span style="color: #0000ff;">if</span>(fieldVal != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;
            }
            Class</span>&lt;?&gt; fieldClazz =<span style="color: #000000;"> field.getType();
            EntityBean relayEntity </span>=<span style="color: #000000;"> getEntityByClazz(fieldClazz);
            </span><span style="color: #008000;">//</span><span style="color: #008000;">依赖的对象能够直接查到</span>
            <span style="color: #0000ff;">if</span>(relayEntity != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                field.set(entityInstance, relayEntity.getO());
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                </span><span style="color: #0000ff;">boolean</span> find = <span style="color: #0000ff;">false</span><span style="color: #000000;">;
                </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(EntityBean otherEntityBean : entityBeans) {
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">判断子类</span>
                    <span style="color: #0000ff;">if</span><span style="color: #000000;">(fieldClazz.isAssignableFrom(otherEntityBean.getClazz())) {
                        field.set(entityInstance, otherEntityBean.getO());
                        find </span>= <span style="color: #0000ff;">true</span><span style="color: #000000;">;
                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
                    }
                }
                </span><span style="color: #0000ff;">if</span>(!<span style="color: #000000;">find) {
                    </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalArgumentException("autowiredEntityNotFoundException"<span style="color: #000000;">);
                }
            }
        }
        entityBean.setFullAutowired(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);
    }
    
    
}</span></code></pre>

<p>&nbsp;</p>
<h1>四、ServletMapper实现</h1>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.gmvc.mapper;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.annotation.Annotation;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Set;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XRequestMapping;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.bean.EntityBean;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.util.CommonUtil;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gutil.common.GUtilCommonUtil;

</span><span style="color: #008000;">/**</span><span style="color: #008000;">
 * servlet映射
 * @ClassName:  ServletMapper   
 * @Description:(这里用一句话描述这个类的作用)   
 * </span><span style="color: #808080;">@author</span><span style="color: #008000;">: 水木桶
 * @date:   2019年9月7日 下午6:22:19     
 * @Copyright: 2019 [水木桶]  All rights reserved.
 </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ServletMapper {
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">uri-method映射*</span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Map&lt;String, Method&gt; URI_MAP = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HashMap();
    
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init() {
        generateUriMap(InstanceManager.getControllerClazzes());
        StringBuilder logSb </span>= <span style="color: #0000ff;">new</span> StringBuilder("ServletMapper,scanUriPath:\n"<span style="color: #000000;">);
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(String uri : URI_MAP.keySet()) {
            logSb.append(uri).append(</span>"\n"<span style="color: #000000;">);
        }
        logSb.append(</span>"\n").append("---scanUriPath-----end----"<span style="color: #000000;">);
        System.out.println(logSb.toString());
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 生成uri-方法映射
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> controllerClazz
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> generateUriMap(Set&lt;EntityBean&gt;<span style="color: #000000;"> controllerClazzBeans) {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(GUtilCommonUtil.checkListEmpty(controllerClazzBeans)) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
        }
        Class</span>&lt;? <span style="color: #0000ff;">extends</span> Annotation&gt; requestMappingClazz = XRequestMapping.<span style="color: #0000ff;">class</span><span style="color: #000000;">;
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(EntityBean eb : controllerClazzBeans) {
            Class</span>&lt;?&gt; controllerClazz =<span style="color: #000000;"> eb.getClazz();
            String rootUri </span>= ""<span style="color: #000000;">;
            </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(controllerClazz.isAnnotationPresent(requestMappingClazz)) {
                XRequestMapping xrm </span>= (XRequestMapping) controllerClazz.getAnnotation(XRequestMapping.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
                rootUri </span>=<span style="color: #000000;"> xrm.value();
            }
            Method[] methods </span>=<span style="color: #000000;"> controllerClazz.getDeclaredMethods();
            </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(Method method : methods) {
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(method.isAnnotationPresent(requestMappingClazz)) {
                    XRequestMapping xrm </span>= (XRequestMapping) method.getAnnotation(XRequestMapping.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
                    String methodUri </span>=<span style="color: #000000;"> xrm.value();
                    String fullUri </span>= rootUri + "/" +<span style="color: #000000;"> methodUri;
                    URI_MAP.put(CommonUtil.formatUri(fullUri), method);
                }
            }
        }
    }
    
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 获取uri对应的方法
     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> uri
     * </span><span style="color: #808080;">@return</span>
     <span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Method getMethodByUri(String uri) {
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> URI_MAP.get(uri);
    }
    
}</span></code></pre>

<p>&nbsp;</p>
<h1>五、XDispatcherServlet-核心调度实现</h1>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.gmvc.handler;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.ServletConfig;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.ServletException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.http.HttpServlet;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.http.HttpServletRequest;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.http.HttpServletResponse;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.slf4j.Logger;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.slf4j.LoggerFactory;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.bean.EntityBean;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.bean.SystemConst;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.mapper.InstanceManager;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.mapper.ServletMapper;

</span><span style="color: #008000;">/**</span><span style="color: #008000;">
 * 调度servlet
 * @ClassName:  XDispatcherServlet   
 * @Description:(这里用一句话描述这个类的作用)   
 * </span><span style="color: #808080;">@author</span><span style="color: #008000;">: 水木桶
 * @date:   2019年9月8日 上午11:58:37     
 * @Copyright: 2019 [水木桶]  All rights reserved.
 </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> XDispatcherServlet <span style="color: #0000ff;">extends</span><span style="color: #000000;"> HttpServlet {
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Logger log = LoggerFactory.getLogger(XDispatcherServlet.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
    
    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> init() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {
        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.init();
        </span><span style="color: #008000;">//</span><span style="color: #008000;">获取ServletConfig对象</span>
        ServletConfig config = <span style="color: #0000ff;">this</span><span style="color: #000000;">.getServletConfig();
        </span><span style="color: #008000;">//</span><span style="color: #008000;">根据参数名获取参数值
</span><span style="color: #008000;">//</span><span style="color: #008000;">        String basePackage = config.getInitParameter(SystemConst.BASE_PACKAGE);</span>
        Map&lt;String, String&gt; confMap = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HashMap();
        confMap.put(SystemConst.BASE_PACKAGE, config.getInitParameter(SystemConst.BASE_PACKAGE));
        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            InstanceManager.init(confMap);
        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
            </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ServletException(e);
        }
        ServletMapper.init();
    }

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * </span><span style="color: #808080;">@see</span><span style="color: #008000;"> HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> doGet(HttpServletRequest request, HttpServletResponse response) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException, IOException {
        doPost(request, response);
    }

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * </span><span style="color: #808080;">@see</span><span style="color: #008000;"> HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
     </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> doPost(HttpServletRequest request, HttpServletResponse response) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException, IOException {
</span><span style="color: #008000;">//</span><span style="color: #008000;">        System.out.println("Hello");</span>
        String requestUri = request.getRequestURI().replace(request.getContextPath(), ""<span style="color: #000000;">);
</span><span style="color: #008000;">//</span><span style="color: #008000;">        System.out.println("requestUri:" + requestUri);</span>
        Method resolveMethod =<span style="color: #000000;"> ServletMapper.getMethodByUri(requestUri);
        EntityBean entityBean </span>=<span style="color: #000000;"> InstanceManager.getEntityByClazz(resolveMethod.getDeclaringClass());
        </span><span style="color: #0000ff;">if</span>(entityBean == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ServletException("uriNotFoundException"<span style="color: #000000;">);
        }
        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            resolveMethod.invoke(entityBean.getO(), request, response);
        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
            log.error(</span>"execute" + resolveMethod.getName() + "Exception"<span style="color: #000000;">, e);
            </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ServletException(e);
        }
    }
}</span></code></pre>

<p>&nbsp;</p>
<h1>六、源码分享</h1>
<p>gmvc：https://gitee.com/simpleha/gmvc.git</p>
<p>依赖：https://gitee.com/simpleha/gutil.git</p>
<h1>七、使用示例</h1>
<h2>1、编译打包gutil</h2>
<p>https://gitee.com/simpleha/gutil.git</p>
<h2>2、编译打包gmvc</h2>
<p>https://gitee.com/simpleha/gmvc.git</p>
<h2>3、新建webapp，引入pom</h2>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>com.shuimutong<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>gmvc<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>0.0.1-SNAPSHOT<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>&nbsp;</p>
<h2>4、修改web.xml</h2>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE web-app PUBLIC
 "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
 "http://java.sun.com/dtd/web-app_2_3.dtd" </span><span style="color: #0000ff;">&gt;</span>

<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">web-app</span><span style="color: #0000ff;">&gt;</span>
  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">display-name</span><span style="color: #0000ff;">&gt;</span>Archetype Created Web Application<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">display-name</span><span style="color: #0000ff;">&gt;</span>
  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">servlet</span><span style="color: #0000ff;">&gt;</span>
      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">servlet-name</span><span style="color: #0000ff;">&gt;</span>gmvc<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">servlet-name</span><span style="color: #0000ff;">&gt;</span>
      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">servlet-class</span><span style="color: #0000ff;">&gt;</span>com.shuimutong.gmvc.handler.XDispatcherServlet<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">servlet-class</span><span style="color: #0000ff;">&gt;</span>
      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">init-param</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">param-name</span><span style="color: #0000ff;">&gt;</span>basePackage<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">param-name</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">param-value</span><span style="color: #0000ff;">&gt;</span>com.shuimutong.testgmvc<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">param-value</span><span style="color: #0000ff;">&gt; //框架扫描的包名，多个路径以&ldquo;,&rdquo;连接</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">init-param</span><span style="color: #0000ff;">&gt;</span>
      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">load-on-startup</span><span style="color: #0000ff;">&gt;</span>2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">load-on-startup</span><span style="color: #0000ff;">&gt;</span>
  <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">servlet</span><span style="color: #0000ff;">&gt;</span>

  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">servlet-mapping</span><span style="color: #0000ff;">&gt;</span>
      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">servlet-name</span><span style="color: #0000ff;">&gt;</span>gmvc<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">servlet-name</span><span style="color: #0000ff;">&gt;</span>
      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">url-pattern</span><span style="color: #0000ff;">&gt;</span>/<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">url-pattern</span><span style="color: #0000ff;">&gt;</span>
  <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">servlet-mapping</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">web-app</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>&nbsp;</p>
<h2>5、编写dao层</h2>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.testgmvc.dao;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.bean.Person;
//接口
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> TestDao {
    Person findPerson();
}


</span><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.testgmvc.dao.impl;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XRepository;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.bean.Person;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.dao.TestDao;
//实现类，需加注解
@XRepository
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TestDaoImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> TestDao {

    @Override
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Person findPerson() {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Person();
    }

}</span></code></pre>

<p>&nbsp;</p>
<h2>6、编写service</h2>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.testgmvc.service;
//接口
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Test2Service {
    </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> speak();
    String convertString(String s);
}


</span><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.testgmvc.service.impl;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.alibaba.fastjson.JSONObject;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XAutowired;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.bean.Person;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.dao.TestDao;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.service.Test2Service;
//实现类
@XService
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Test2ServiceImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Test2Service {
    @XAutowired
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> TestDao testDao;

    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> speak() {
        System.out.println(</span>"----Test2ServiceImpl-----speak----"<span style="color: #000000;">);
    }

    @Override
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String convertString(String s) {
        Person p </span>=<span style="color: #000000;"> testDao.findPerson();
        p.setName(p.getName() </span>+<span style="color: #000000;"> s);
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> JSONObject.toJSONString(p);
    }

}</span></code></pre>

<p>&nbsp;</p>
<h2>7、编写controller</h2>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.shuimutong.testgmvc.controller;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.http.HttpServletRequest;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.servlet.http.HttpServletResponse;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.alibaba.fastjson.JSONObject;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XAutowired;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XController;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.annotation.XRequestMapping;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.gmvc.util.RequestResolveUtil;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.service.Test2Service;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.shuimutong.testgmvc.service.TestService;

@XController
@XRequestMapping(</span>"/test"<span style="color: #000000;">)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> TestController {
    @XAutowired
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Test2Service test2Service;
    @XAutowired
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> TestService testService;

    @XRequestMapping(</span>"/testA"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> testA(HttpServletRequest request, HttpServletResponse reponse) {
        System.out.println(</span>"Hi, this is TestA"<span style="color: #000000;">);
    }
    
    @XRequestMapping(</span>"/testB"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> testB(HttpServletRequest request, HttpServletResponse reponse) {
        System.out.println(</span>"Hi, this is TestA"<span style="color: #000000;">);
        JSONObject res </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> JSONObject();
        String tmpMsg </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;
        Map</span>&lt;String, String[]&gt; map =<span style="color: #000000;"> request.getParameterMap();
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(String k : map.keySet()) {
            res.put(k, map.get(k));
            </span><span style="color: #0000ff;">if</span>(tmpMsg == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                tmpMsg </span>= map.get(k)[0<span style="color: #000000;">];
            }
        }
        System.out.println(</span>"----------testService.speak()------------"<span style="color: #000000;">);
        testService.speak();
        System.out.println(</span>"----------test2Service.convertString()------------"<span style="color: #000000;">);
        String person </span>=<span style="color: #000000;"> test2Service.convertString(tmpMsg);
        res.put(</span>"person"<span style="color: #000000;">, person);
        RequestResolveUtil.returnJson(request, reponse, res.toJSONString());
    }
}</span></code></pre>

<p>&nbsp;</p>
<h2>8、启动服务</h2>
<h2>9、示例代码地址</h2>
<p>https://github.com/shuimutong/useDemo/tree/master/gmvc_demo</p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>