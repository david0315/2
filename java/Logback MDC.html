<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Logback MDC' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Logback MDC</center></div><div class='banquan'>原文出处:本文由博客园博主废物大师兄提供。<br/>
原文连接:https://www.cnblogs.com/cjsblog/p/11831046.html</div><br>
    <p><span style="font-size: 18px; color: #53a451;">Mapped Diagnostic Contexts (MDC)&nbsp; &nbsp;（译：诊断上下文映射）</span></p>
<p><span style="font-size: 16px;">Logback的设计目标之一是审计和调试复杂的分布式应用程序。大多数实际的分布式系统需要同时处理来自多个客户端的请求。为了区分开每个客户端的日志，也为了能够快速定位某个请求日志来自哪个客户端，最简单地方式是，给每个客户端的每个日志请求一个唯一标记。</span></p>
<p><span style="font-size: 16px;">为了对每个请求进行惟一的标记，用户将上下文信息放入MDC中。</span></p>
<p><img src="./images/Logback MDC0.png" alt="" width="570" height="338" /></p>
<p><span style="font-size: 16px;">MDC类只包含静态方法。它允许开发人员将信息放在诊断上下文中，然后通过某些logback组件检索这些信息。MDC在每个线程的基础上管理上下文信息。通常，在开始服务新的客户端请求时，开发人员会将相关的上下文信息（如客户端id、客户端IP地址、请求参数等）插入到MDC中。如果配置得当，Logback组件将自动在每个日志条目中包含此信息。另外请注意，子线程不会自动继承其父线程的映射诊断上下文的副本。</span></p>
<p><span style="font-size: 16px;">下面是一个例子：</span></p>
<p><img src="./images/Logback MDC1.png" alt="" width="871" height="660" /></p>
<p><span style="font-size: 16px;">假设Logback配置文件是这样配置的：</span></p>
<p><img src="./images/Logback MDC2.png" alt="" width="872" height="91" /></p>
<p><span style="font-size: 16px;">运行这段程序，将会看到以下输出：</span></p>
<p><img src="./images/Logback MDC3.png" alt="" width="869" height="81" /></p>
<p><span style="font-size: 16px;">请注意，在PatternLayout转换模式中使用<span style="color: #ff0000;"><strong>%X</strong></span></span></p>
<p><span style="font-size: 16px;">补充一句，如果不知道这些格式字符串怎么写，可以参加&nbsp;ch.qos.logback.classic.PatternLayout</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px;">通常，服务器用多个线程为多个客户端提供服务。尽管MDC类中的方法是静态的，但是诊断上下文是在每个线程的基础上进行管理的，允许每个服务器线程都带有不同的MDC戳记。诸如put()和get()之类的MDC操作只影响当前线程的MDC和当前线程的子线程。其他线程中的MDC不受影响。由于MDC信息是在每个线程的基础上管理的，所以每个线程都有自己的MDC副本。因此，开发人员在使用MDC编程时不需要担心线程安全或同步问题，因为它可以安全、透明地处理这些问题。</span></p>
<p><span style="font-size: 16px;">正如我们所看到的，MDC非常有用。我们可以在MDC中设置用户名，这样便可以从日志中追踪用户行为。但是，因为MDC是在每个线程的基础上管理数据的，而且项目中基本上都是用的线程池，所以回收线程的服务器可能会导致MDC中包含错误信息。为了使MDC中包含的信息在处理请求时始终正确，一种可能的方法是在线程开始时存储用户名，并在线程结束时删除它。在这种情况下，servlet过滤器就派上用场了。</span></p>
<p><img src="./images/Logback MDC4.png" alt="" width="990" height="1343" /></p>
<p>&nbsp;</p>
<p><span style="color: #53a451;"><strong><span style="font-size: 16px;">MDC与线程管理</span></strong></span></p>
<p><span style="font-size: 16px;">worker线程不总是可以从启动线程那里继承诊断上下文副本，例如当使用java.util.concurrent.Executors来管理线程时就不能。在这种情况下，推荐在提交任务到executor之前在原始线程上先调用MDC.getCopyOfContextMap()。当任务启动后，第一个动作应该先调用MDC.setContextMapValues()来关联这个原始MDC的副本。</span></p>
<p>&nbsp;</p>
<p><span style="color: #53a451;"><strong><span style="font-size: 16px;">MDCInsertingServletFilter</span></strong></span></p>
<p><span style="font-size: 16px;">在Web应用程序中，知道给定的HTTP请求的主机名、请求URL以及user-agent等信息通常是非常有用的。MDCInsertingServletFilter插入这些数据到MDC中。</span></p>
<p><img src="./images/Logback MDC5.png" alt="" width="593" height="261" /></p>
<p><span style="font-size: 16px;">为了引入MDCInsertingServletFilter过滤器，添加以下到web.xml中</span></p>
<p><img src="./images/Logback MDC6.png" alt="" width="582" height="199" /></p>
<p><span style="font-size: 16px;">如果有多个过滤器，请务必确保MDCInsertingServletFilter在所有其他过滤器的前面。</span></p>
<p>&nbsp;</p>
<p><span style="color: #53a451;"><strong><span style="font-size: 16px;">示例：追踪用户行为（举个栗子）</span></strong></span></p>
<p><span style="font-size: 16px;">使用过滤器或者拦截器都行</span></p>
<p><span style="font-size: 16px;">pom.xml</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> <span style="color: #008800;">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> <span style="color: #008000; font-weight: bold;">&lt;project</span> <span style="color: #bb4444;">xmlns="http://maven.apache.org/POM/4.0.0"</span> <span style="color: #bb4444;">xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span>          <span style="color: #bb4444;">xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span style="color: #008000; font-weight: bold;">&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span>     <span style="color: #008000; font-weight: bold;">&lt;modelVersion&gt;</span>4.0.0<span style="color: #008000; font-weight: bold;">&lt;/modelVersion&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span>     <span style="color: #008000; font-weight: bold;">&lt;parent&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span>         <span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>org.springframework.boot<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span>         <span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span>         <span style="color: #008000; font-weight: bold;">&lt;version&gt;</span>2.2.1.RELEASE<span style="color: #008000; font-weight: bold;">&lt;/version&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span>         <span style="color: #008000; font-weight: bold;">&lt;relativePath/&gt;</span> <span style="color: #008800; font-style: italic;">&lt;!-- lookup parent from repository --&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span>     <span style="color: #008000; font-weight: bold;">&lt;/parent&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>     <span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>com.cjs.example<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span>     <span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>demo123<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">13</span>     <span style="color: #008000; font-weight: bold;">&lt;version&gt;</span>0.0.1-SNAPSHOT<span style="color: #008000; font-weight: bold;">&lt;/version&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">14</span>     <span style="color: #008000; font-weight: bold;">&lt;name&gt;</span>demo123<span style="color: #008000; font-weight: bold;">&lt;/name&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">15</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">16</span>     <span style="color: #008000; font-weight: bold;">&lt;properties&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">17</span>         <span style="color: #008000; font-weight: bold;">&lt;java.version&gt;</span>1.8<span style="color: #008000; font-weight: bold;">&lt;/java.version&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">18</span>     <span style="color: #008000; font-weight: bold;">&lt;/properties&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">19</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">20</span>     <span style="color: #008000; font-weight: bold;">&lt;dependencies&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">21</span>         <span style="color: #008000; font-weight: bold;">&lt;dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">22</span>             <span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>org.springframework.boot<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">23</span>             <span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">24</span>         <span style="color: #008000; font-weight: bold;">&lt;/dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">25</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">26</span>         <span style="color: #008000; font-weight: bold;">&lt;dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">27</span>             <span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>ch.qos.logback<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">28</span>             <span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>logback-classic<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">29</span>             <span style="color: #008000; font-weight: bold;">&lt;version&gt;</span>1.2.3<span style="color: #008000; font-weight: bold;">&lt;/version&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">30</span>         <span style="color: #008000; font-weight: bold;">&lt;/dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">31</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">32</span>         <span style="color: #008000; font-weight: bold;">&lt;dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">33</span>             <span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>org.projectlombok<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">34</span>             <span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>lombok<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">35</span>             <span style="color: #008000; font-weight: bold;">&lt;optional&gt;</span>true<span style="color: #008000; font-weight: bold;">&lt;/optional&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">36</span>         <span style="color: #008000; font-weight: bold;">&lt;/dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">37</span>     <span style="color: #008000; font-weight: bold;">&lt;/dependencies&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">38</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">39</span>     <span style="color: #008000; font-weight: bold;">&lt;build&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">40</span>         <span style="color: #008000; font-weight: bold;">&lt;plugins&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">41</span>             <span style="color: #008000; font-weight: bold;">&lt;plugin&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">42</span>                 <span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>org.springframework.boot<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">43</span>                 <span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">44</span>             <span style="color: #008000; font-weight: bold;">&lt;/plugin&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">45</span>         <span style="color: #008000; font-weight: bold;">&lt;/plugins&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">46</span>     <span style="color: #008000; font-weight: bold;">&lt;/build&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">47</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">48</span> <span style="color: #008000; font-weight: bold;">&lt;/project&gt;</span></span></code></pre>

<p><span style="font-size: 16px;">过滤器配置</span></p>
<src class="highlight" style="background: #272822;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #272822; padding: 0 5px 0 5px;"> 1</span> <span style="color: #f92672;">package</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">cjs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">example</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">config</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 3</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">ch.qos.logback.classic.helpers.MDCInsertingServletFilter</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 4</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.boot.web.servlet.FilterRegistrationBean</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 5</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.context.annotation.Bean</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 6</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.context.annotation.Configuration</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 7</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 8</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.Arrays</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 9</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">10</span> <span style="color: #75715e;">/**</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">11</span> <span style="color: #75715e;"> * @author ChengJianSheng</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">12</span> <span style="color: #75715e;"> * @date 2019-11-10</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">13</span> <span style="color: #75715e;"> */</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">14</span> <span style="color: #a6e22e;">@Configuration</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">15</span> <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">WebConfig</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">16</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">17</span>     <span style="color: #a6e22e;">@Bean</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">18</span>     <span style="color: #66d9ef;">public</span> <span style="color: #f8f8f2;">FilterRegistrationBean</span> <span style="color: #a6e22e;">registration</span><span style="color: #f92672;">()</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">19</span>         <span style="color: #f8f8f2;">MDCInsertingServletFilter</span> <span style="color: #f8f8f2;">filter</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">MDCInsertingServletFilter</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">20</span>         <span style="color: #f8f8f2;">FilterRegistrationBean</span> <span style="color: #f8f8f2;">registration</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">FilterRegistrationBean</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">filter</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">21</span>         <span style="color: #f8f8f2;">registration</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setUrlPatterns</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">Arrays</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">asList</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/*"</span><span style="color: #f92672;">));</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">22</span>         <span style="color: #f8f8f2;">registration</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setOrder</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">1</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">23</span>         <span style="color: #66d9ef;">return</span> <span style="color: #f8f8f2;">registration</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">24</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">25</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">26</span> <span style="color: #75715e;">//    @Bean</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">27</span> <span style="color: #75715e;">//    public MDCInsertingServletFilter mdcInsertingServletFilter() {</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">28</span> <span style="color: #75715e;">//        return new MDCInsertingServletFilter();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">29</span> <span style="color: #75715e;">//    }</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">30</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">31</span> <span style="color: #f92672;">}</span>&nbsp;</span></code></pre>

<p><span style="font-size: 16px;">定义一个拦截器</span></p>
<src class="highlight" style="background: #272822;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #272822; padding: 0 5px 0 5px;"> 1</span> <span style="color: #f92672;">package</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">cjs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">example</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">interceptor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 3</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.slf4j.MDC</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 4</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.servlet.HandlerInterceptor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 5</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.servlet.ModelAndView</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 6</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 7</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">javax.servlet.http.HttpServletRequest</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 8</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">javax.servlet.http.HttpServletResponse</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 9</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.UUID</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">10</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">11</span> <span style="color: #75715e;">/**</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">12</span> <span style="color: #75715e;"> * @author ChengJianSheng</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">13</span> <span style="color: #75715e;"> * @date 2019-11-10</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">14</span> <span style="color: #75715e;"> */</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">15</span> <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">MyInterceptor</span> <span style="color: #66d9ef;">implements</span> <span style="color: #f8f8f2;">HandlerInterceptor</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">16</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">17</span>     <span style="color: #66d9ef;">private</span> <span style="color: #66d9ef;">final</span> <span style="color: #f8f8f2;">String</span> <span style="color: #f8f8f2;">SESSION_KEY</span> <span style="color: #f92672;">=</span> <span style="color: #e6db74;">"sessionId"</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">18</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">19</span>     <span style="color: #a6e22e;">@Override</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">20</span>     <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">boolean</span> <span style="color: #a6e22e;">preHandle</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">HttpServletRequest</span> <span style="color: #f8f8f2;">request</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">HttpServletResponse</span> <span style="color: #f8f8f2;">response</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">Object</span> <span style="color: #f8f8f2;">handler</span><span style="color: #f92672;">)</span> <span style="color: #66d9ef;">throws</span> <span style="color: #f8f8f2;">Exception</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">21</span>         <span style="color: #f8f8f2;">String</span> <span style="color: #f8f8f2;">sessionId</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">UUID</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">randomUUID</span><span style="color: #f92672;">().</span><span style="color: #a6e22e;">toString</span><span style="color: #f92672;">().</span><span style="color: #a6e22e;">replace</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"-"</span><span style="color: #f92672;">,</span> <span style="color: #e6db74;">""</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">22</span>         <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">put</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">SESSION_KEY</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">sessionId</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">23</span>         <span style="color: #66d9ef;">return</span> <span style="color: #66d9ef;">true</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">24</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">25</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">26</span>     <span style="color: #a6e22e;">@Override</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">27</span>     <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">void</span> <span style="color: #a6e22e;">postHandle</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">HttpServletRequest</span> <span style="color: #f8f8f2;">request</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">HttpServletResponse</span> <span style="color: #f8f8f2;">response</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">Object</span> <span style="color: #f8f8f2;">handler</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">ModelAndView</span> <span style="color: #f8f8f2;">modelAndView</span><span style="color: #f92672;">)</span> <span style="color: #66d9ef;">throws</span> <span style="color: #f8f8f2;">Exception</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">28</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">29</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">30</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">31</span>     <span style="color: #a6e22e;">@Override</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">32</span>     <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">void</span> <span style="color: #a6e22e;">afterCompletion</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">HttpServletRequest</span> <span style="color: #f8f8f2;">request</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">HttpServletResponse</span> <span style="color: #f8f8f2;">response</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">Object</span> <span style="color: #f8f8f2;">handler</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">Exception</span> <span style="color: #f8f8f2;">ex</span><span style="color: #f92672;">)</span> <span style="color: #66d9ef;">throws</span> <span style="color: #f8f8f2;">Exception</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">33</span>         <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">remove</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">SESSION_KEY</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">34</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">35</span> <span style="color: #f92672;">}</span></span></code></pre>

<p><span style="font-size: 16px;">拦截器配置</span></p>
<src class="highlight" style="background: #272822;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #272822; padding: 0 5px 0 5px;"> 1</span> <span style="color: #f92672;">package</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">cjs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">example</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">config</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 3</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">com.cjs.example.interceptor.MyInterceptor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 4</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.context.annotation.Configuration</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 5</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.servlet.config.annotation.InterceptorRegistry</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 6</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 7</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 8</span> <span style="color: #75715e;">/**</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 9</span> <span style="color: #75715e;"> * @author ChengJianSheng</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">10</span> <span style="color: #75715e;"> * @date 2019-11-10</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">11</span> <span style="color: #75715e;"> */</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">12</span> <span style="color: #a6e22e;">@Configuration</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">13</span> <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">InterceptorConfig</span> <span style="color: #66d9ef;">implements</span> <span style="color: #f8f8f2;">WebMvcConfigurer</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">14</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">15</span>     <span style="color: #a6e22e;">@Override</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">16</span>     <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">void</span> <span style="color: #a6e22e;">addInterceptors</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">InterceptorRegistry</span> <span style="color: #f8f8f2;">registry</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">17</span>         <span style="color: #f8f8f2;">registry</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">addInterceptor</span><span style="color: #f92672;">(</span><span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">MyInterceptor</span><span style="color: #f92672;">()).</span><span style="color: #a6e22e;">addPathPatterns</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/**"</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">18</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">19</span> <span style="color: #f92672;">}</span>&nbsp;</span></code></pre>

<p><span style="font-size: 16px;">Controller和Service</span></p>
<src class="highlight" style="background: #272822;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #272822; padding: 0 5px 0 5px;"> 1</span> <span style="color: #f92672;">package</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">cjs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">example</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">controller</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 3</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">com.cjs.example.service.HelloService</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 4</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">lombok.extern.slf4j.Slf4j</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 5</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.beans.factory.annotation.Autowired</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 6</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.beans.factory.annotation.Qualifier</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 7</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 8</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.bind.annotation.GetMapping</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 9</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.bind.annotation.RequestMapping</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">10</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.bind.annotation.RequestParam</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">11</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.web.bind.annotation.RestController</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">12</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">13</span> <span style="color: #75715e;">/**</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">14</span> <span style="color: #75715e;"> * @author ChengJianSheng</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">15</span> <span style="color: #75715e;"> * @date 2019-11-10</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">16</span> <span style="color: #75715e;"> */</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">17</span> <span style="color: #a6e22e;">@Slf4j</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">18</span> <span style="color: #a6e22e;">@RestController</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">19</span> <span style="color: #a6e22e;">@RequestMapping</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/hello"</span><span style="color: #f92672;">)</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">20</span> <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">HelloController</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">21</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">22</span>     <span style="color: #a6e22e;">@Autowired</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">23</span>     <span style="color: #66d9ef;">private</span> <span style="color: #f8f8f2;">HelloService</span> <span style="color: #f8f8f2;">helloService</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">24</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">25</span>     <span style="color: #a6e22e;">@Autowired</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">26</span>     <span style="color: #a6e22e;">@Qualifier</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"taskExecutor"</span><span style="color: #f92672;">)</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">27</span>     <span style="color: #66d9ef;">private</span> <span style="color: #f8f8f2;">ThreadPoolTaskExecutor</span> <span style="color: #f8f8f2;">taskExecutor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">28</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">29</span>     <span style="color: #a6e22e;">@GetMapping</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"/sayHello"</span><span style="color: #f92672;">)</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">30</span>     <span style="color: #66d9ef;">public</span> <span style="color: #f8f8f2;">String</span> <span style="color: #a6e22e;">sayHello</span><span style="color: #f92672;">(</span><span style="color: #a6e22e;">@RequestParam</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"name"</span><span style="color: #f92672;">)</span> <span style="color: #f8f8f2;">String</span> <span style="color: #f8f8f2;">name</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">31</span>         <span style="color: #f8f8f2;">log</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">info</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"收到请求：name={}"</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">name</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">32</span>         <span style="color: #f8f8f2;">String</span> <span style="color: #f8f8f2;">str</span> <span style="color: #f92672;">=</span> <span style="color: #e6db74;">"Hello, "</span> <span style="color: #f92672;">+</span> <span style="color: #f8f8f2;">name</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">33</span>         <span style="color: #f8f8f2;">log</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">info</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">str</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">34</span>         <span style="color: #f8f8f2;">helloService</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">print</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">35</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">36</span> <span style="color: #75715e;">//        Map&lt;String, String&gt; ctx = MDC.getCopyOfContextMap();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">37</span> <span style="color: #75715e;">//        new Thread(()-&gt;{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">38</span> <span style="color: #75715e;">//            MDC.setContextMap(ctx);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">39</span> <span style="color: #75715e;">//            log.info("1111");}).start();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">40</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">41</span>         <span style="color: #f8f8f2;">taskExecutor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">submit</span><span style="color: #f92672;">(()-&gt;{</span><span style="color: #f8f8f2;">log</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">info</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"1234234"</span><span style="color: #f92672;">);});</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">42</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">43</span>         <span style="color: #66d9ef;">return</span> <span style="color: #f8f8f2;">str</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">44</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">45</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">46</span> <span style="color: #f92672;">}</span>
</span></code></pre>

<p>&nbsp;</p>
<src class="highlight" style="background: #272822;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #272822; padding: 0 5px 0 5px;"> 1</span> <span style="color: #f92672;">package</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">cjs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">example</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">service</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 3</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">lombok.extern.slf4j.Slf4j</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 4</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.scheduling.annotation.Async</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 5</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.stereotype.Service</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 6</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 7</span> <span style="color: #75715e;">/**</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 8</span> <span style="color: #75715e;"> * @author ChengJianSheng</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 9</span> <span style="color: #75715e;"> * @date 2019-11-10</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">10</span> <span style="color: #75715e;"> */</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">11</span> <span style="color: #a6e22e;">@Slf4j</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">12</span> <span style="color: #a6e22e;">@Service</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">13</span> <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">HelloService</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">14</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">15</span>     <span style="color: #75715e;">/**</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">16</span> <span style="color: #75715e;">     * 使用@Aysnc异步执行任务时，虽然指定了Executor但是在真正执行时却不会调我们重写的这个submit或execute方法，因而无法将父线程MDC拷贝到子线程中</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">17</span> <span style="color: #75715e;">     * 实践表明，必须手动显式调用submit或execute才行，这就相当于我们自己重写了任务的Runnable</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">18</span> <span style="color: #75715e;">     */</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">19</span>     <span style="color: #a6e22e;">@Async</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"taskExecutor"</span><span style="color: #f92672;">)</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">20</span>     <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">void</span> <span style="color: #a6e22e;">print</span><span style="color: #f92672;">()</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">21</span>         <span style="color: #f8f8f2;">log</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">info</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"This is apple"</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">22</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">23</span> <span style="color: #f92672;">}</span>&nbsp;</span></code></pre>

<p><span style="font-size: 16px;">线程池配置（可选）</span></p>
<src class="highlight" style="background: #272822;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #272822; padding: 0 5px 0 5px;"> 1</span> <span style="color: #f92672;">package</span> <span style="color: #f8f8f2;">com</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">cjs</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">example</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">config</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 3</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.slf4j.MDC</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 4</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.context.annotation.Bean</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 5</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.context.annotation.Configuration</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 6</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.scheduling.annotation.EnableAsync</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 7</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 8</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;"> 9</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.Map</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">10</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.concurrent.Future</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">11</span> <span style="color: #f92672;">import</span> <span style="color: #f8f8f2;">java.util.concurrent.ThreadPoolExecutor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">12</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">13</span> <span style="color: #75715e;">/**</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">14</span> <span style="color: #75715e;"> * http://logback.qos.ch/manual/mdc.html#MDC And Managed Threads</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">15</span> <span style="color: #75715e;"> * @author ChengJianSheng</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">16</span> <span style="color: #75715e;"> * @date 2019-11-10</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">17</span> <span style="color: #75715e;"> */</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">18</span> <span style="color: #a6e22e;">@EnableAsync</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">proxyTargetClass</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">true</span><span style="color: #f92672;">)</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">19</span> <span style="color: #a6e22e;">@Configuration</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">20</span> <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">ThreadPoolConfig</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">21</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">22</span>     <span style="color: #a6e22e;">@Bean</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">name</span> <span style="color: #f92672;">=</span> <span style="color: #e6db74;">"taskExecutor"</span><span style="color: #f92672;">)</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">23</span>     <span style="color: #66d9ef;">public</span> <span style="color: #f8f8f2;">ThreadPoolTaskExecutor</span> <span style="color: #a6e22e;">taskExecutor</span><span style="color: #f92672;">()</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">24</span>         <span style="color: #75715e;">//  对于使用@Async方式提交的异步任务不会生效</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">25</span>         <span style="color: #f8f8f2;">ThreadPoolTaskExecutor</span> <span style="color: #f8f8f2;">executor</span> <span style="color: #f92672;">=</span> <span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">ThreadPoolTaskExecutor</span><span style="color: #f92672;">(){</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">26</span>             <span style="color: #a6e22e;">@Override</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">27</span>             <span style="color: #66d9ef;">public</span> <span style="color: #66d9ef;">void</span> <span style="color: #a6e22e;">execute</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">Runnable</span> <span style="color: #f8f8f2;">task</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">28</span>                 <span style="color: #f8f8f2;">Map</span><span style="color: #f92672;">&lt;</span><span style="color: #f8f8f2;">String</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">String</span><span style="color: #f92672;">&gt;</span> <span style="color: #f8f8f2;">contextMap</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getCopyOfContextMap</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">29</span>                 <span style="color: #66d9ef;">super</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">execute</span><span style="color: #f92672;">(()-&gt;{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">30</span>                     <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setContextMap</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">contextMap</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">31</span>                     <span style="color: #66d9ef;">try</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">32</span>                         <span style="color: #f8f8f2;">task</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">run</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">33</span>                     <span style="color: #f92672;">}</span> <span style="color: #66d9ef;">finally</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">34</span>                         <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">clear</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">35</span>                     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">36</span>                 <span style="color: #f92672;">});</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">37</span>             <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">38</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">39</span>             <span style="color: #a6e22e;">@Override</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">40</span>             <span style="color: #66d9ef;">public</span> <span style="color: #f8f8f2;">Future</span><span style="color: #f92672;">&lt;?&gt;</span> <span style="color: #f8f8f2;">submit</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">Runnable</span> <span style="color: #f8f8f2;">task</span><span style="color: #f92672;">)</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">41</span>                 <span style="color: #f8f8f2;">Map</span><span style="color: #f92672;">&lt;</span><span style="color: #f8f8f2;">String</span><span style="color: #f92672;">,</span> <span style="color: #f8f8f2;">String</span><span style="color: #f92672;">&gt;</span> <span style="color: #f8f8f2;">contextMap</span> <span style="color: #f92672;">=</span> <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">getCopyOfContextMap</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">42</span>                 <span style="color: #66d9ef;">return</span> <span style="color: #66d9ef;">super</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">submit</span><span style="color: #f92672;">(()-&gt;{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">43</span>                     <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setContextMap</span><span style="color: #f92672;">(</span><span style="color: #f8f8f2;">contextMap</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">44</span>                     <span style="color: #66d9ef;">try</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">45</span>                         <span style="color: #f8f8f2;">task</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">run</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">46</span>                     <span style="color: #f92672;">}</span> <span style="color: #66d9ef;">finally</span> <span style="color: #f92672;">{</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">47</span>                         <span style="color: #f8f8f2;">MDC</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">clear</span><span style="color: #f92672;">();</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">48</span>                     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">49</span>                 <span style="color: #f92672;">});</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">50</span>             <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">51</span>         <span style="color: #f92672;">};</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">52</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">53</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setCorePoolSize</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">10</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">54</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setMaxPoolSize</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">20</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">55</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setQueueCapacity</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">1000</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">56</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setKeepAliveSeconds</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">60</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">57</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setThreadNamePrefix</span><span style="color: #f92672;">(</span><span style="color: #e6db74;">"cjsTaskExecutor-"</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">58</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setWaitForTasksToCompleteOnShutdown</span><span style="color: #f92672;">(</span><span style="color: #66d9ef;">true</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">59</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setAwaitTerminationSeconds</span><span style="color: #f92672;">(</span><span style="color: #ae81ff;">10</span><span style="color: #f92672;">);</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">60</span>         <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">setRejectedExecutionHandler</span><span style="color: #f92672;">(</span><span style="color: #66d9ef;">new</span> <span style="color: #f8f8f2;">ThreadPoolExecutor</span><span style="color: #f92672;">.</span><span style="color: #a6e22e;">CallerRunsPolicy</span><span style="color: #f92672;">());</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">61</span> 
<span style="background-color: #272822; padding: 0 5px 0 5px;">62</span>         <span style="color: #66d9ef;">return</span> <span style="color: #f8f8f2;">executor</span><span style="color: #f92672;">;</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">63</span>     <span style="color: #f92672;">}</span>
<span style="background-color: #272822; padding: 0 5px 0 5px;">64</span> <span style="color: #f92672;">}</span>
</span></code></pre>

<p><span style="font-size: 16px;">logback配置</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 14px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> <span style="color: #008800;">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> <span style="color: #008000; font-weight: bold;">&lt;configuration&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span>     <span style="color: #008000; font-weight: bold;">&lt;appender</span> <span style="color: #bb4444;">name="STDOUT"</span> <span style="color: #bb4444;">class="ch.qos.logback.core.ConsoleAppender"</span><span style="color: #008000; font-weight: bold;">&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span>         <span style="color: #008000; font-weight: bold;">&lt;layout</span> <span style="color: #bb4444;">class="ch.qos.logback.classic.PatternLayout"</span><span style="color: #008000; font-weight: bold;">&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span>             <span style="color: #008000; font-weight: bold;">&lt;Pattern&gt;</span>%d{HH:mm:ss.SSS} [%thread] [%X{req.remoteHost}] [%X{req.requestURI}] [%X{sessionId}] %-5level %logger{36} - %msg%n<span style="color: #008000; font-weight: bold;">&lt;/Pattern&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span>         <span style="color: #008000; font-weight: bold;">&lt;/layout&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span>     <span style="color: #008000; font-weight: bold;">&lt;/appender&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span>   
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span>     <span style="color: #008000; font-weight: bold;">&lt;root</span> <span style="color: #bb4444;">level="INFO"</span><span style="color: #008000; font-weight: bold;">&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>         <span style="color: #008000; font-weight: bold;">&lt;appender-ref</span> <span style="color: #bb4444;">ref="STDOUT"</span> <span style="color: #008000; font-weight: bold;">/&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span>     <span style="color: #008000; font-weight: bold;">&lt;/root&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">13</span> <span style="color: #008000; font-weight: bold;">&lt;/configuration&gt;</span>&nbsp;</span></code></pre>

<p><span style="font-size: 16px;">运行效果</span></p>
<p><span style="font-size: 16px;">访问<a href="http://localhost:8080/hello/sayHello?name=zhangsan">http://localhost:8080/hello/sayHello?name=zhangsan</a>&nbsp;</span></p>
<p>&nbsp;</p>
<src class="cnblogs_code">
<pre><code>17:09:08.524 [http-nio-8080-exec-1] [0:0:0:0:0:0:0:1] [/hello/sayHello] [551f5632eddc4a1ca4a387464e954143] INFO  c.c.e.controller.HelloController - 收到请求：name=zhangsan
17:09:08.525 [http-nio-8080-exec-1] [0:0:0:0:0:0:0:1] [/hello/sayHello] [551f5632eddc4a1ca4a387464e954143] INFO  c.c.e.controller.HelloController - Hello, zhangsan
17:09:15.343 [cjsTaskExecutor-2] [0:0:0:0:0:0:0:1] [/hello/sayHello] [551f5632eddc4a1ca4a387464e954143] INFO  c.c.e.controller.HelloController - 1234234
17:09:15.348 [cjsTaskExecutor-1] [] [] [] INFO  com.cjs.example.service.HelloService - This is apple</code></pre>

<p><span style="font-size: 18px; color: #53a451;">其它</span></p>
<p><span style="font-size: 16px;"><a href="http://logback.qos.ch/manual/mdc.html">http://logback.qos.ch/manual/mdc.html</a></span></p>
<p>此处没能实现@Async方式的异步任务MDC拷贝，有些遗憾，另外，跨服务调用的TraceId传递也是一个值得思考的问题，不知道Spring Cloud Sleuth的链路跟踪是怎么做的</p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>