<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®åŸºäºAOPå’ŒRediså®ç°å¯¹æ¥å£è°ƒç”¨æƒ…å†µçš„ç›‘æ§åŠIPé™æµ' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>åŸºäºAOPå’ŒRediså®ç°å¯¹æ¥å£è°ƒç”¨æƒ…å†µçš„ç›‘æ§åŠIPé™æµ</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»ğŸ«æ²™æ¼ éª†é©¼æä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/csh24/p/11771647.html</div><br>
    <src class="toc">
    <p class="toc-title">ç›®å½•</p>
    <src class="toc-list">
        <ul>
        <li><a href="#éœ€æ±‚æè¿°">éœ€æ±‚æè¿°</a></li>
        <li><a href="#æ¦‚è¦è®¾è®¡">æ¦‚è¦è®¾è®¡</a></li>
        <li><a href="#ä»£ç å®ç°">ä»£ç å®ç°</a></li>
        <li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
        </ul>
    

<h3 id="éœ€æ±‚æè¿°">éœ€æ±‚æè¿°</h3>
<ol>
<li>é¡¹ç›®ä¸­æœ‰è®¸å¤šæ¥å£ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªåŠŸèƒ½å¯¹æ¥å£è°ƒç”¨æƒ…å†µè¿›è¡Œç»Ÿè®¡ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š
<ul>
<li>éœ€æ±‚ä¸€ï¼šå®ç°å¯¹æ¯ä¸ªæ¥å£ï¼Œæ¯å¤©çš„è°ƒç”¨æ¬¡æ•°åšè®°å½•ï¼›</li>
<li>éœ€æ±‚äºŒï¼šå¦‚æœæŸæ¬¡è°ƒç”¨æŠ›å‡ºäº†å¼‚å¸¸ä¿¡æ¯ï¼Œåˆ™è®°å½•ä¸‹å¼‚å¸¸ä¿¡æ¯ï¼›</li>
<li>éœ€æ±‚ä¸‰ï¼šé™æµï¼Œé™åˆ¶å•ä¸ªIPä¸€å¤©å†…å¯¹ä¸€ä¸ªæ¥å£çš„è°ƒç”¨æ¬¡æ•°ã€‚</li>
</ul></li>
</ol>
<h3 id="æ¦‚è¦è®¾è®¡">æ¦‚è¦è®¾è®¡</h3>
<ol>
<li><p>å› ä¸ºéœ€è¦å¯¹æ¯ä¸ªæ¥å£çš„è°ƒç”¨æƒ…å†µè¿›è¡Œç»Ÿè®¡ï¼Œæ‰€ä»¥é€‰æ‹©AOPæ¥å®ç°ï¼Œå°†Controllerå±‚æŠ½è±¡ä¸ºä¸€ä¸ªåˆ‡é¢</p>
<ul>
<li><p>@Before æ‰§è¡Œä¸šåŠ¡æ“ä½œå‰è¿›è¡Œé™æµåˆ¤æ–­ï¼›</p></li>
<li>@AfterReturn å¦‚æœæ­£å¸¸è¿”å›åˆ™è°ƒç”¨æ¬¡æ•°åŠ 1ï¼›</li>
<li><p>@AfterThrowing å¦‚æœæŠ›å‡ºå¼‚å¸¸åˆ™è®°å½•å¼‚å¸¸ä¿¡æ¯ã€‚</p></li>
</ul>
<p>å¦‚æœå°†è¿™äº›ä¿¡æ¯å†™å…¥æ•°æ®åº“çš„è¯ä¼šå¯¹æ¯ä¸ªæ¥å£å¸¦æ¥é¢å¤–çš„æ“ä½œæ•°æ®åº“çš„å¼€é”€ï¼Œå½±å“æ¥å£å“åº”æ—¶é—´ï¼Œä¸”æ­¤ç±»è®°å½•ä¿¡æ¯è¾ƒå¤šï¼Œæ‰€ä»¥æ­¤å¤„é€‰æ‹©Rediså°†è¿™äº›ä¿¡æ¯ç¼“å­˜ä¸‹æ¥ã€‚</p></li>
<li><p>Redisè®¾è®¡</p>
<ul>
<li>å¯¹äºéœ€æ±‚ä¸€ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•ä¸‰ä¸ªä¿¡æ¯ï¼š1ã€è°ƒç”¨çš„æ¥å£åï¼›2ã€è°ƒç”¨çš„æ—¥æœŸï¼ˆç²¾ç¡®åˆ°å¤©ï¼‰ï¼›3ã€è°ƒç”¨æ¬¡æ•°ã€‚æ‰€ä»¥æ­¤å¤„Redisçš„keyä½¿ç”¨Hashç»“æ„ï¼Œæ•°æ®ç»“æ„å¦‚ä¸‹ï¼škey = æ¥å£URIã€key = è°ƒç”¨æ—¥æœŸï¼ˆåˆ°å¤©ï¼‰ã€value = è°ƒç”¨æ¬¡æ•°ï¼ˆåˆå§‹å€¼ä¸º1ï¼Œæ²¡ä¸€æ¬¡è°ƒç”¨åè‡ªå¢1ï¼‰ã€‚</li>
<li>å¯¹äºéœ€æ±‚äºŒï¼Œéœ€è¦è®°å½•çš„ä¿¡æ¯æœ‰ï¼š1ã€è°ƒç”¨çš„æ¥å£åï¼›2ã€å¼‚å¸¸å‘ç”Ÿæ—¶é—´ï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ï¼›3ã€å¼‚å¸¸ä¿¡æ¯ã€‚å› ä¸ºéœ€æ±‚ä¸€çš„keyå·²ç»è®¾ç½®æˆäº†æ¥å£URIï¼Œæ‰€ä»¥æ­¤å¤„é€‰æ‹©ä½¿ç”¨URI + åç¼€â€œ_exceptionâ€çš„å½¢å¼æ¥ä»£è¡¨å¼‚å¸¸ä¿¡æ¯çš„keyã€‚æ‰€ä»¥æ­¤éœ€æ±‚Redisçš„æ•°æ®ç»“æ„è®¾è®¡å¦‚ä¸‹ï¼ˆä»ç„¶ä½¿ç”¨Hashç»“æ„ï¼‰ï¼škey = URI + â€œ_exceptionâ€ã€key = å¼‚å¸¸å‘ç”Ÿæ—¶é—´ï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ã€value = å¼‚å¸¸ä¿¡æ¯ã€‚</li>
<li>å¯¹äºéœ€æ±‚ä¸‰ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•çš„ä¿¡æ¯æœ‰ï¼š1ã€è°ƒç”¨çš„æ¥å£åï¼›2ã€ipåœ°å€ï¼›3ã€è°ƒç”¨æ—¶é—´ï¼›4ã€è°ƒç”¨æ¬¡æ•°ã€‚æ­¤éœ€æ±‚éœ€è¦è®°å½•çš„ä¿¡æ¯è¾ƒå¤šï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°†ä¿¡æ¯1ã€ä¿¡æ¯2ã€ä¿¡æ¯3ç»„åˆèµ·æ¥æ‹¼æ¥æˆä¸€ä¸ªå”¯ä¸€çš„keyå³å¯ï¼Œå°†è°ƒç”¨æ—¶é—´çš„ç»´åº¦ç²¾ç¡®åˆ°å¤©ä¸”è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´ä¸ºä¸€å¤©ï¼Œè¿™æ ·çš„ä¸€ä¸ªkeyå³å¯ä»£è¡¨å•ä¸ªIPä¸€å¤©æ—¶é—´å†…è®¿é—®äº†å“ªäº›æ¥å£ã€‚æ‰€ä»¥Redisçš„æ•°æ®ç»“æ„è®¾è®¡å¦‚ä¸‹ï¼škey = URI + ip +dateï¼ˆç²¾ç¡®åˆ°å¤©ï¼‰ã€value = è°ƒç”¨æ¬¡æ•°ã€‚</li>
</ul></li>
</ol>
<h3 id="ä»£ç å®ç°">ä»£ç å®ç°</h3>
<pre><code><code>/**
 * æ¥å£è°ƒç”¨æƒ…å†µç›‘æ§
 * 1ã€ç›‘æ§å•ä¸ªæ¥å£ä¸€å¤©å†…çš„è°ƒç”¨æ¬¡æ•°
 * 2ã€å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è®°å½•å¼‚å¸¸ä¿¡æ¯åŠå‘ç”Ÿæ—¶é—´
 * 3ã€å¯¹å•ä¸ªIPè¿›è¡Œé™æµï¼Œæ¯å¤©å¯¹æ¯ä¸ªæ¥å£çš„è°ƒç”¨æ¬¡æ•°æœ‰é™
 *
 * @author csh
 * @date 2019/10/30
 */
@Aspect
@Component
public class ApiCallAdvice {

    @Resource
    private RedisTemplate redisTemplate;
    @Resource
    private StringRedisTemplate stringRedisTemplate;

    private static final String FORMAT_PATTERN_DAY = &quot;yyyy-MM-dd&quot;;
    private static final String FORMAT_PATTERN_MILLS = &quot;yyyy-MM-dd HH:mm:ss:SSS&quot;;

    /**
     * çœŸæ­£æ‰§è¡Œä¸šåŠ¡æ“ä½œå‰å…ˆè¿›è¡Œé™æµçš„éªŒè¯
     * é™åˆ¶ç»´åº¦ä¸ºï¼šä¸€å¤©å†…å•ä¸ªIPçš„è®¿é—®æ¬¡æ•°
     * key = URI + IP + dateï¼ˆç²¾ç¡®åˆ°å¤©ï¼‰
     * value = è°ƒç”¨æ¬¡æ•°
     */
    @Before(&quot;execution(* com.pagoda.erp.platform.controller.*.*(..))&quot;)
    public void before() {
        // æ¥æ”¶åˆ°è¯·æ±‚ï¼Œè®°å½•è¯·æ±‚å†…å®¹
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        //è·å–è¯·æ±‚çš„request
        HttpServletRequest request = attributes.getRequest();

        String uri = request.getRequestURI();
        String date = dateFormat(FORMAT_PATTERN_DAY);
        String ip = getRequestIp(request);

        if (StringUtils.isEmpty(ip)) {
            throw new BusinessException(&quot;IPä¸èƒ½ä¸ºç©ºã€‚&quot;);
        }
        // URI+IP+æ—¥æœŸ æ„æˆä»¥å¤©ä¸ºç»´åº¦çš„key
        String ipKey = uri + &quot;_&quot; + ip + &quot;_&quot; + date;
        if (redisTemplate.hasKey(ipKey)) {
            if (Integer.parseInt(redisTemplate.opsForValue().get(ipKey).toString()) &gt; 10000) {
                throw new BusinessException(&quot;è®¿é—®å¤±è´¥ï¼Œå·²è¶…è¿‡è®¿é—®æ¬¡æ•°ã€‚&quot;);
            }
            redisTemplate.opsForValue().increment(ipKey, 1);
        } else {
            stringRedisTemplate.opsForValue().set(ipKey, &quot;1&quot;, 1L, TimeUnit.DAYS);
        }
    }

    /**
     * å¦‚æœæœ‰è¿”å›ç»“æœï¼Œä»£è¡¨ä¸€æ¬¡è°ƒç”¨ï¼Œåˆ™å¯¹åº”æ¥å£çš„è°ƒç”¨æ¬¡æ•°åŠ ä¸€ï¼Œç»Ÿè®¡ç»´åº¦ä¸ºå¤©
     * ï¼ˆRedisä½¿ç”¨Hashç»“æ„ï¼‰
     * key = URI
     * key = date ï¼ˆç²¾ç¡®åˆ°å¤©ï¼‰
     * value = è°ƒç”¨æ¬¡æ•°
     */
    @AfterReturning(&quot;execution(* com.pagoda.erp.platform.controller.*.*(..))&quot;)
    public void afterReturning() {
        // æ¥æ”¶åˆ°è¯·æ±‚ï¼Œè®°å½•è¯·æ±‚å†…å®¹
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        //è·å–è¯·æ±‚çš„request
        HttpServletRequest request = attributes.getRequest();

        String uri = request.getRequestURI();
        String date = dateFormat(FORMAT_PATTERN_DAY);
        if (redisTemplate.hasKey(uri)) {
            redisTemplate.boundHashOps(uri).increment(date, 1);
        } else {
            redisTemplate.boundHashOps(uri).put(date, 1);
        }
    }

    /**
     * å¦‚æœè°ƒç”¨æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ç¼“å­˜å¼‚å¸¸ä¿¡æ¯ï¼ˆRedisä½¿ç”¨Hashç»“æ„ï¼‰
     * key = URI + â€œ_exceptionâ€
     * key = time (ç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´)
     * value = exception å¼‚å¸¸ä¿¡æ¯
     *
     * @param ex å¼‚å¸¸ä¿¡æ¯
     */
    @AfterThrowing(value = &quot;execution(* com.pagoda.erp.platform.controller.*.*(..))&quot;, throwing = &quot;ex&quot;)
    public void afterThrowing(Exception ex) {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();

        String uri = request.getRequestURI() + &quot;_exception&quot;;
        String time = dateFormat(FORMAT_PATTERN_MILLS);
        String exception = ex.getMessage();

        redisTemplate.boundHashOps(uri).put(time, exception);
    }

    private String getRequestIp(HttpServletRequest request) {
        // è·å–è¯·æ±‚IP
        String ip = request.getHeader(&quot;x-forwarded-for&quot;);
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip) || &quot;null&quot;.equals(ip)) {
            ip = &quot;&quot; + request.getHeader(&quot;Proxy-Client-IP&quot;);
        }
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip) || &quot;null&quot;.equals(ip)) {
            ip = &quot;&quot; + request.getHeader(&quot;WL-Proxy-Client-IP&quot;);
        }
        if (ip == null || ip.length() == 0 || &quot;unknown&quot;.equalsIgnoreCase(ip) || &quot;null&quot;.equals(ip)) {
            ip = &quot;&quot; + request.getRemoteAddr();
        }
        return ip;
    }

    private String dateFormat(String pattern) {
        SimpleDateFormat dateFormat = new SimpleDateFormat(pattern);
        return dateFormat.format(new Date());
    }
}</code></code></pre>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>
<ul>
<li><a href="https://blog.csdn.net/yali_aini/article/details/92653982">ä½¿ç”¨aop+redis+æ³¨è§£ å®ç° é™åˆ¶å•ä½æ—¶é—´å†…è®¿é—®æ¥å£çš„æ¬¡æ•°</a></li>
<li><a href="https://www.cnblogs.com/hq233/p/6637488.html">Spring AOPå®ä¾‹</a></li>
</ul>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>