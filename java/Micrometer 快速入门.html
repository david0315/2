<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Micrometer 快速入门' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Micrometer 快速入门</center></div><div class='banquan'>原文出处:本文由博客园博主废物大师兄提供。<br/>
原文连接:https://www.cnblogs.com/cjsblog/p/11556029.html</div><br>
    <p><span style="font-size: 15px;">Micrometer为最流行的监控系统提供了一个简单的仪表客户端外观，允许仪表化JVM应用，而无需关心是哪个供应商提供的指标。它的作用和SLF4J类似，只不过它关注的不是Logging（日志），而是application metrics（应用指标）。简而言之，它就是应用监控界的SLF4J。</span></p>
<p><img src="./images/Micrometer 快速入门0.png" alt="" /></p>
<p><span style="font-size: 16px; color: #d64e8a;">Micrometer（译：千分尺）</span></p>
<p><img src="./images/Micrometer 快速入门1.png" alt="" width="460" height="211" /></p>
<p><span style="font-size: 15px;">不妨看看SLF4J官网上对于SLF4J的说明：Simple Logging Facade for Java (SLF4J)</span></p>
<p><span style="font-size: 15px;">现在再看Micrometer的说明：Micrometer provides a simple facade over the instrumentation clients for the most popular monitoring systems.</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; color: #d64e8a;">Metrics（译：指标，度量）</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;">Micrometer提供了与供应商无关的接口，包括 <strong>timers（计时器）</strong>， <strong>gauges（量规）</strong>， <strong>counters（计数器）</strong>， <strong>distribution summaries（分布式摘要）</strong>， <strong>long task timers（长任务定时器）</strong>。它具有维度数据模型，当与维度监视系统结合使用时，可以高效地访问特定的命名度量，并能够跨维度深入研究。</span></p>
<p><span style="font-size: 15px;">支持的监控系统：AppOptics ， Azure Monitor ， Netflix Atlas ， CloudWatch ， Datadog ， Dynatrace ， Elastic ， Ganglia ， Graphite ， Humio ， Influx/Telegraf ， JMX ， KairosDB ， New Relic ， Prometheus ， SignalFx ， Google Stackdriver ， StatsD ， Wavefront</span></p>
<p>&nbsp;</p>
<p><span style="color: #c3453b; font-size: 18pt;">1.&nbsp; 安装</span></p>
<p><span style="font-size: 15px;">Micrometer记录的应用程序指标用于观察、告警和对环境当前/最近的操作状态做出反应。</span></p>
<p><span style="font-size: 15px;">为了使用Micrometer，首先要添加你所选择的监视系统的依赖。以Prometheus为例：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> <span style="color: #008000; font-weight: bold;">&lt;dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> 	<span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>io.micrometer<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>   	<span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span>   	<span style="color: #008000; font-weight: bold;">&lt;version&gt;</span>${micrometer.version}<span style="color: #008000; font-weight: bold;">&lt;/version&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">5</span> <span style="color: #008000; font-weight: bold;">&lt;/dependency&gt;</span></span></code></pre>

<p>&nbsp;</p>
<p><span style="color: #c3453b; font-size: 18pt;">2.&nbsp; 概念</span></p>
<p><span style="font-size: 14pt; color: #53a451;">2.1.&nbsp;&nbsp;Registry</span></p>
<p><span style="font-size: 15px;"><span style="color: #d64e8a;">Meter</span>是收集关于你的应用的一系列指标的接口。<span style="color: #d64e8a;">Meter</span>是由<span style="color: #d64e8a;">MeterRegistry</span>创建的。每个支持的监控系统都必须实现<span style="color: #d64e8a;">MeterRegistry</span>。&nbsp;</span></p>
<p><span style="font-size: 15px;">Micrometer中包含一个<span style="color: #d64e8a;">SimpleMeterRegistry</span>，它在内存中维护每个meter的最新值，并且不将数据导出到任何地方。如果你还没有一个首选的监测系统，你可以先用SimpleMeterRegistry：&nbsp;</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> MeterRegistry registry <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">new</span> SimpleMeterRegistry<span style="color: #666666;">();</span>&nbsp;</span></code></pre>

<p><span style="font-size: 15px;">注意：如果你用Spring的话，SimpleMeterRegistry是自动注入的&nbsp;</span></p>
<p><span style="font-size: 15px;">Micrometer还提供一个<span style="color: #d64e8a;">CompositeMeterRegistry</span>用于将多个registries结合在一起使用，允许同时向多个监视系统发布指标。&nbsp;</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> CompositeMeterRegistry composite <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">new</span> CompositeMeterRegistry<span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span> Counter compositeCounter <span style="color: #666666;">=</span> composite<span style="color: #666666;">.</span><span style="color: #bb4444;">counter</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"counter"</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span> compositeCounter<span style="color: #666666;">.</span><span style="color: #bb4444;">increment</span><span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">5</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">6</span> SimpleMeterRegistry simple <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">new</span> SimpleMeterRegistry<span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">7</span> composite<span style="color: #666666;">.</span><span style="color: #bb4444;">add</span><span style="color: #666666;">(</span>simple<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">8</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">9</span> compositeCounter<span style="color: #666666;">.</span><span style="color: #bb4444;">increment</span><span style="color: #666666;">();</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="color: #53a451; font-size: 14pt;">2.2.&nbsp; Meters</span></p>
<p><span style="font-size: 15px;">Micrometer提供一系列原生的Meter，包括Timer , Counter , Gauge , DistributionSummary , LongTaskTimer , FunctionCounter , FunctionTimer , TimeGauge。不同的meter类型导致有不同的时间序列指标值。例如，单个指标值用Gauge表示，计时事件的次数和总时间用Timer表示。</span></p>
<p><span style="font-size: 15px;">每一项指标都有一个唯一标识的名字和维度。&ldquo;维度&rdquo;和&ldquo;标签&rdquo;是一个意思，Micrometer中有一个Tag接口，仅仅因为它更简短。一般来说，应该尽可能地使用名称作为轴心。</span></p>
<p><span style="font-size: 15px; color: #ad33d8;"><span style="color: #7c66de;">（PS：指标的名字很好理解，维度怎么理解呢？如果把name想象成横坐标的话，那么dimension就是纵坐标。Tag是一个key/value对，代表指标的一个维度值）</span>&nbsp;</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 14pt; color: #53a451;">2.3.&nbsp;&nbsp;Naming meters（指标命名）</span></p>
<p><span style="font-size: 15px;">Micrometer使用了一种命名约定，用.分隔小写单词字符。不同的监控系统有不同的命名约定。每个Micrometer的实现都要负责将Micrometer这种以.分隔的小写字符命名转换成对应监控系统推荐的命名。你可以提供一个自己的<span style="color: #d64e8a;">NamingConvention</span>来覆盖默认的命名转换：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">config</span><span style="color: #666666;">().</span><span style="color: #bb4444;">namingConvention</span><span style="color: #666666;">(</span>myCustomNamingConvention<span style="color: #666666;">);</span>&nbsp;</span></code></pre>

<p><span style="font-size: 15px;">&nbsp;有了命名约定以后，下面这个timer在不同的监控系统中看起来就是这样的：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">timer</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"http.server.requests"</span><span style="color: #666666;">);</span>&nbsp;</span></code></pre>

<p><span style="font-size: 15px;">在Prometheus中，它是<span style="color: #d64e8a;">http_server_requests_duration_seconds</span></span></p>
<p><span style="font-size: 15px;">在Atlas中，它对应的是<span style="color: #d64e8a;">httpServerRequests</span></span></p>
<p><span style="font-size: 15px;">在InfluxDB中，对应的是<span style="color: #d64e8a;">http_server_requests</span></span></p>
<p><span style="font-size: 15px; color: #7c66de;">（PS：每项指标都有一个名字，不同的监控系统的命名规则（风格）都不太一样，因此可能同一个指标在不同的监控系统中有不同的名字。简单地来说，比如内存使用率这个指标可能在Prometheus中用MemoryUsage表示，在InfluxDB中用mem_usage表示，因此每个监控系统都要提供一个命名转换器，当看到mem.usage的时候InfluxDB应该知道说的是内存使用率，对应的指标名称是mem_usage。这就好比，中文&ldquo;你好&rdquo;翻译成英文是&ldquo;hello&rdquo;，翻译成日文是&ldquo;こんにちは&rdquo;&nbsp;）&nbsp;</span></p>
<p><span style="font-size: 16px;"><strong>2.3.1.&nbsp; Tag naming</strong></span></p>
<p><span style="font-size: 15px;">假设，我们想要统计HTTP请求数和数据库调用次数，那么可以这样写：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">counter</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"database.calls"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"db"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"users"</span><span style="color: #666666;">);</span>       <span style="color: #008800; font-style: italic;">// 数据库调用次数</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">counter</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"http.requests"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"uri"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"/api/users"</span><span style="color: #666666;">);</span>  <span style="color: #008800; font-style: italic;">// HTTP请求数</span>
</span></code></pre>

<p><span style="font-size: 16px;"><strong>2.3.2.&nbsp; Common tags</strong></span></p>
<p><span style="font-size: 15px;">Common tags可以被定义在registry级别，并且会被添加到每个监控系统的报告中</span></p>
<p><span style="font-size: 15px;">预定义的Tags有host , instance , region , stack等&nbsp;</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">config</span><span style="color: #666666;">().</span><span style="color: #bb4444;">commonTags</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"stack"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"prod"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"region"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"us-east-1"</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">config</span><span style="color: #666666;">().</span><span style="color: #bb4444;">commonTags</span><span style="color: #666666;">(</span>Arrays<span style="color: #666666;">.</span><span style="color: #bb4444;">asList</span><span style="color: #666666;">(</span>Tag<span style="color: #666666;">.</span><span style="color: #bb4444;">of</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"stack"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"prod"</span><span style="color: #666666;">),</span> Tag<span style="color: #666666;">.</span><span style="color: #bb4444;">of</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"region"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"us-east-1"</span><span style="color: #666666;">)));</span> <span style="color: #008800; font-style: italic;">// 二者等价</span>
</span></code></pre>

<p><span style="font-size: 16px;"><strong>2.3.4.&nbsp; Tag values</strong></span></p>
<p><span style="font-size: 15px;">Tag values must be non-null&nbsp;</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 14pt; color: #53a451;">2.4.&nbsp; Meter filters</span></p>
<p><span style="font-size: 15px;">每个registry都可以配置指标过滤器，它有3个方法：</span></p>
<p><span style="font-size: 15px;"><strong>Deny</strong>&nbsp;(or accept) meters from being registered</span></p>
<p><span style="font-size: 15px;"><strong>Transform</strong>&nbsp;meter IDs</span></p>
<p><span style="font-size: 15px;"><strong>Configure</strong>&nbsp;distribution statistics for some meter types.</span></p>
<p><span style="font-size: 15px;">实现MeterFilter就可以加到registry中</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">config</span><span style="color: #666666;">()</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">meterFilter</span><span style="color: #666666;">(</span>MeterFilter<span style="color: #666666;">.</span><span style="color: #bb4444;">ignoreTags</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"too.much.information"</span><span style="color: #666666;">))</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">meterFilter</span><span style="color: #666666;">(</span>MeterFilter<span style="color: #666666;">.</span><span style="color: #bb4444;">denyNameStartsWith</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"jvm"</span><span style="color: #666666;">));</span>&nbsp;</span></code></pre>

<p><span style="font-size: 15px;">过滤器按顺序应用，所有的过滤器形成一个过滤器链（chain）</span>&nbsp;</p>
<p><strong><span style="font-size: 16px;">2.4.1.&nbsp; Deny/accept meters</span></strong></p>
<p><span style="font-size: 15px;">接受或拒绝指标</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">MeterFilter</span><span style="color: #666666;">()</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span>     <span style="color: #aa22ff;">@Override</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>     <span style="color: #aa22ff; font-weight: bold;">public</span> MeterFilterReply <span style="color: #00a000;">accept</span><span style="color: #666666;">(</span>Meter<span style="color: #666666;">.</span><span style="color: #bb4444;">Id</span> id<span style="color: #666666;">)</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span>        <span style="color: #aa22ff; font-weight: bold;">if</span><span style="color: #666666;">(</span>id<span style="color: #666666;">.</span><span style="color: #bb4444;">getName</span><span style="color: #666666;">().</span><span style="color: #bb4444;">contains</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"test"</span><span style="color: #666666;">))</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">5</span>           <span style="color: #aa22ff; font-weight: bold;">return</span> MeterFilterReply<span style="color: #666666;">.</span><span style="color: #bb4444;">DENY</span><span style="color: #666666;">;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">6</span>        <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">7</span>        <span style="color: #aa22ff; font-weight: bold;">return</span> MeterFilterReply<span style="color: #666666;">.</span><span style="color: #bb4444;">NEUTRAL</span><span style="color: #666666;">;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">8</span>     <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">9</span> <span style="color: #666666;">}</span>
</span></code></pre>

<p><span style="font-size: 15px;"><span style="color: #d64e8a;">MeterFilter</span>还提供了许多方便的静态方法用于接受或拒绝指标&nbsp;</span></p>
<p><img src="./images/Micrometer 快速入门2.png" alt="" width="434" height="316" /></p>
<p><span style="font-size: 16px;"><strong>2.4.2.&nbsp; Transforming metrics&nbsp;</strong></span></p>
<p><span style="font-size: 15px;">一个转换过滤器可能是这样的：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">MeterFilter</span><span style="color: #666666;">()</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span>     <span style="color: #aa22ff;">@Override</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>     <span style="color: #aa22ff; font-weight: bold;">public</span> Meter<span style="color: #666666;">.</span><span style="color: #bb4444;">Id</span> <span style="color: #00a000;">map</span><span style="color: #666666;">(</span>Meter<span style="color: #666666;">.</span><span style="color: #bb4444;">Id</span> id<span style="color: #666666;">)</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span>        <span style="color: #aa22ff; font-weight: bold;">if</span><span style="color: #666666;">(</span>id<span style="color: #666666;">.</span><span style="color: #bb4444;">getName</span><span style="color: #666666;">().</span><span style="color: #bb4444;">startsWith</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"test"</span><span style="color: #666666;">))</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">5</span>           <span style="color: #aa22ff; font-weight: bold;">return</span> id<span style="color: #666666;">.</span><span style="color: #bb4444;">withName</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"extra."</span> <span style="color: #666666;">+</span> id<span style="color: #666666;">.</span><span style="color: #bb4444;">getName</span><span style="color: #666666;">()).</span><span style="color: #bb4444;">withTag</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"extra.tag"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"value"</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">6</span>        <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">7</span>        <span style="color: #aa22ff; font-weight: bold;">return</span> id<span style="color: #666666;">;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">8</span>     <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">9</span> <span style="color: #666666;">}</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="color: #53a451; font-size: 14pt;">2.5.&nbsp; Counters（计数器）</span></p>
<p><span style="font-size: 15px;">Counter接口允许以固定的数值递增，该数值必须为正数。</span>&nbsp;</p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> MeterRegistry registry <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">new</span> SimpleMeterRegistry<span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span> <span style="color: #008800; font-style: italic;">//  写法一</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span> Counter counter <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">counter</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"counter"</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span> <span style="color: #008800; font-style: italic;">//  写法二</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span> Counter counter <span style="color: #666666;">=</span> Counter
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">builder</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"counter"</span><span style="color: #666666;">)</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">baseUnit</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"beans"</span><span style="color: #666666;">)</span> <span style="color: #008800; font-style: italic;">// optional</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">description</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"a description of what this counter does"</span><span style="color: #666666;">)</span> <span style="color: #008800; font-style: italic;">// optional</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">tags</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"region"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"test"</span><span style="color: #666666;">)</span> <span style="color: #008800; font-style: italic;">// optional</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">register</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">);</span>
</span></code></pre>

<p><strong><span style="font-size: 16px;">2.5.1.&nbsp;&nbsp;Function-tracking counters</span></strong></p>
<p><span style="font-size: 15px;">跟踪单调递增函数的计数器</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> Cache cache <span style="color: #666666;">=</span> <span style="color: #666666;">...;</span> <span style="color: #008800; font-style: italic;">// suppose we have a Guava cache with stats recording on</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">more</span><span style="color: #666666;">().</span><span style="color: #bb4444;">counter</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"evictions"</span><span style="color: #666666;">,</span> tags<span style="color: #666666;">,</span> cache<span style="color: #666666;">,</span> c <span style="color: #666666;">-&gt;</span> c<span style="color: #666666;">.</span><span style="color: #bb4444;">stats</span><span style="color: #666666;">().</span><span style="color: #bb4444;">evictionCount</span><span style="color: #666666;">());</span> <span style="color: #008800; font-style: italic;">// evictionCount()是一个单调递增函数，用于记录缓存被剔除的次数</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="color: #53a451; font-size: 14pt;">2.6.&nbsp; Gauges</span></p>
<p><span style="font-size: 15px;">gauge是获取当前值的句柄。典型的例子是，获取集合、map、或运行中的线程数等。</span></p>
<p><span style="font-size: 15px;">MeterRegistry接口包含了用于构建gauges的方法，用于观察数字值、函数、集合和map。&nbsp;</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> List<span style="color: #666666;">&lt;</span>String<span style="color: #666666;">&gt;</span> list <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">gauge</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"listGauge"</span><span style="color: #666666;">,</span> Collections<span style="color: #666666;">.</span><span style="color: #bb4444;">emptyList</span><span style="color: #666666;">(),</span> <span style="color: #aa22ff; font-weight: bold;">new</span> ArrayList<span style="color: #666666;">&lt;&gt;(),</span> <span style="color: #a0a000;">List:</span><span style="color: #666666;">:</span>size<span style="color: #666666;">);</span> <span style="color: #008800; font-style: italic;">//监视非数值对象</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> List<span style="color: #666666;">&lt;</span>String<span style="color: #666666;">&gt;</span> list2 <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">gaugeCollectionSize</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"listSize2"</span><span style="color: #666666;">,</span> Tags<span style="color: #666666;">.</span><span style="color: #bb4444;">empty</span><span style="color: #666666;">(),</span> <span style="color: #aa22ff; font-weight: bold;">new</span> ArrayList<span style="color: #666666;">&lt;&gt;());</span> <span style="color: #008800; font-style: italic;">//监视集合大小</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span> Map<span style="color: #666666;">&lt;</span>String<span style="color: #666666;">,</span> Integer<span style="color: #666666;">&gt;</span> map <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">gaugeMapSize</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"mapGauge"</span><span style="color: #666666;">,</span> Tags<span style="color: #666666;">.</span><span style="color: #bb4444;">empty</span><span style="color: #666666;">(),</span> <span style="color: #aa22ff; font-weight: bold;">new</span> HashMap<span style="color: #666666;">&lt;&gt;());</span>&nbsp;</span></code></pre>

<p><span style="font-size: 15px;">还可以手动加减Gauge</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> AtomicInteger n <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">gauge</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"numberGauge"</span><span style="color: #666666;">,</span> <span style="color: #aa22ff; font-weight: bold;">new</span> AtomicInteger<span style="color: #666666;">(0));</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> n<span style="color: #666666;">.</span><span style="color: #bb4444;">set</span><span style="color: #666666;">(1);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span> n<span style="color: #666666;">.</span><span style="color: #bb4444;">set</span><span style="color: #666666;">(2);</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="font-size: 14pt; color: #53a451;">2.7.&nbsp; Timers（计时器）</span>&nbsp;</p>
<p><span style="font-size: 15px;">Timer用于测量短时间延迟和此类事件的频率。所有Timer实现至少将总时间和事件次数报告为单独的时间序列。</span></p>
<p><span style="font-size: 15px;">例如，可以考虑用一个图表来显示一个典型的web服务器的请求延迟情况。服务器可以快速响应许多请求，因此定时器每秒将更新很多次。</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> <span style="color: #008800; font-style: italic;">// 方式一</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> <span style="color: #aa22ff; font-weight: bold;">public</span> <span style="color: #aa22ff; font-weight: bold;">interface</span> <span style="color: #0000ff;">Timer</span> <span style="color: #aa22ff; font-weight: bold;">extends</span> Meter <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span>     <span style="color: #666666;">...</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span>     <span style="color: #00bb00; font-weight: bold;">void</span> <span style="color: #00a000;">record</span><span style="color: #666666;">(</span><span style="color: #00bb00; font-weight: bold;">long</span> amount<span style="color: #666666;">,</span> TimeUnit unit<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span>     <span style="color: #00bb00; font-weight: bold;">void</span> <span style="color: #00a000;">record</span><span style="color: #666666;">(</span>Duration duration<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span>     <span style="color: #00bb00; font-weight: bold;">double</span> <span style="color: #00a000;">totalTime</span><span style="color: #666666;">(</span>TimeUnit unit<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span> <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span> <span style="color: #008800; font-style: italic;">// 方式二</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span> Timer timer <span style="color: #666666;">=</span> Timer
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">builder</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"my.timer"</span><span style="color: #666666;">)</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">description</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"a description of what this timer does"</span><span style="color: #666666;">)</span> <span style="color: #008800; font-style: italic;">// optional</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">13</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">tags</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"region"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"test"</span><span style="color: #666666;">)</span> <span style="color: #008800; font-style: italic;">// optional</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">14</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">register</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">);</span>&nbsp;</span></code></pre>

<p><span style="font-size: 15px;">查看源代码，一目了然，不一一赘述</span></p>
<p><img src="./images/Micrometer 快速入门3.png" alt="" width="368" height="470" />&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #53a451; font-size: 14pt;">2.8.&nbsp; Long task timers&nbsp;</span></p>
<p><span style="font-size: 15px;">长任务计时器用于跟踪所有正在运行的长时间运行任务的总持续时间和此类任务的数量。&nbsp;</span></p>
<p><span style="font-size: 15px;">Timer记录的是次数，Long Task Timer记录的是任务时长和任务数</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> <span style="color: #008800; font-style: italic;">// 方式一</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> <span style="color: #aa22ff;">@Timed</span><span style="color: #666666;">(</span>value <span style="color: #666666;">=</span> <span style="color: #bb4444;">"aws.scrape"</span><span style="color: #666666;">,</span> longTask <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">true</span><span style="color: #666666;">)</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span> <span style="color: #aa22ff;">@Scheduled</span><span style="color: #666666;">(</span>fixedDelay <span style="color: #666666;">=</span> <span style="color: #666666;">360000)</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span> <span style="color: #00bb00; font-weight: bold;">void</span> <span style="color: #00a000;">scrapeResources</span><span style="color: #666666;">()</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span>     <span style="color: #008800; font-style: italic;">// find instances, volumes, auto-scaling groups, etc...</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span> <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span> <span style="color: #008800; font-style: italic;">// 方式二</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span> LongTaskTimer scrapeTimer <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">more</span><span style="color: #666666;">().</span><span style="color: #bb4444;">longTaskTimer</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"scrape"</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span> <span style="color: #00bb00; font-weight: bold;">void</span> <span style="color: #00a000;">scrapeResources</span><span style="color: #666666;">()</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>     scrapeTimer<span style="color: #666666;">.</span><span style="color: #bb4444;">record</span><span style="color: #666666;">(()</span> <span style="color: #666666;">=&gt;</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span>         <span style="color: #008800; font-style: italic;">// find instances, volumes, auto-scaling groups, etc...</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">13</span>     <span style="color: #666666;">});</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">14</span> <span style="color: #666666;">}</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="color: #53a451; font-size: 14pt;">2.9.&nbsp;&nbsp;Distribution summaries（分布汇总）</span></p>
<p><span style="font-size: 15px;">distribution summary用于跟踪分布式的事件。它在结构上类似于计时器，但是记录的值不代表时间单位。例如，记录http服务器上的请求的响应大小。</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> DistributionSummary summary <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">summary</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"response.size"</span><span style="color: #666666;">);</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="font-size: 14pt; color: #53a451;">2.10.&nbsp; Histograms and percentiles（直方图和百分比）&nbsp;</span></p>
<p><span style="font-size: 15px;">Timers 和 distribution summaries 支持收集数据来观察它们的百分比。查看百分比有两种主要方法：</span></p>
<p><span style="font-size: 15px;"><strong>Percentile histograms（百分比直方图）</strong>：&nbsp;&nbsp;Micrometer将值累积到底层直方图，并将一组预先确定的buckets发送到监控系统。监控系统的查询语言负责从这个直方图中计算百分比。目前，只有Prometheus , Atlas , Wavefront支持基于直方图的百分位数近似值，并且通过histogram_quantile , :percentile , hs()依次表示。</span></p>
<p><span style="font-size: 15px;"><strong>Client-side percentiles（客户端百分比）</strong>：Micrometer为每个meter ID（一组name和tag）计算百分位数近似值，并将百分位数值发送到监控系统。</span></p>
<p><span style="font-size: 15px;">下面是用直方图构建Timer的一个例子：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> Timer<span style="color: #666666;">.</span><span style="color: #bb4444;">builder</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"my.timer"</span><span style="color: #666666;">)</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span>    <span style="color: #666666;">.</span><span style="color: #bb4444;">publishPercentiles</span><span style="color: #666666;">(0.5,</span> <span style="color: #666666;">0.95)</span> <span style="color: #008800; font-style: italic;">// median and 95th percentile</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>    <span style="color: #666666;">.</span><span style="color: #bb4444;">publishPercentileHistogram</span><span style="color: #666666;">()</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span>    <span style="color: #666666;">.</span><span style="color: #bb4444;">sla</span><span style="color: #666666;">(</span>Duration<span style="color: #666666;">.</span><span style="color: #bb4444;">ofMillis</span><span style="color: #666666;">(100))</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">5</span>    <span style="color: #666666;">.</span><span style="color: #bb4444;">minimumExpectedValue</span><span style="color: #666666;">(</span>Duration<span style="color: #666666;">.</span><span style="color: #bb4444;">ofMillis</span><span style="color: #666666;">(1))</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">6</span>    <span style="color: #666666;">.</span><span style="color: #bb4444;">maximumExpectedValue</span><span style="color: #666666;">(</span>Duration<span style="color: #666666;">.</span><span style="color: #bb4444;">ofSeconds</span><span style="color: #666666;">(10))</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="font-size: 18pt; color: #c3453b;">3.&nbsp; Micrometer Prometheus</span>&nbsp;</p>
<p><span style="font-size: 15px;">Prometheus是一个内存中的维度时间序列数据库，具有简单的内置UI、定制查询语言和数学操作。Prometheus的设计是基于pull模型进行操作，根据服务发现定期从应用程序实例中抓取指标。</span></p>
<p>&nbsp;</p>
<p><span style="color: #53a451; font-size: 14pt;">3.1.&nbsp; 安装</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> <span style="color: #008000; font-weight: bold;">&lt;dependency&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span>     <span style="color: #008000; font-weight: bold;">&lt;groupId&gt;</span>io.micrometer<span style="color: #008000; font-weight: bold;">&lt;/groupId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>     <span style="color: #008000; font-weight: bold;">&lt;artifactId&gt;</span>micrometer-registry-prometheus<span style="color: #008000; font-weight: bold;">&lt;/artifactId&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span>     <span style="color: #008000; font-weight: bold;">&lt;version&gt;</span>${micrometer.version}<span style="color: #008000; font-weight: bold;">&lt;/version&gt;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">5</span> <span style="color: #008000; font-weight: bold;">&lt;/dependency&gt;</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="font-size: 14pt; color: #53a451;">3.2.&nbsp; 配置</span></p>
<p><span style="font-size: 15px;">Prometheus希望通过抓取或轮询单个应用程序实例来获得指标。除了创建Prometheus registry之外，还需要向Prometheus的scraper公开一个HTTP端点。在Spring环境中，一个Prometheus actuator endpoint是在Spring Boot Actuator存在的情况下自动配置的。</span></p>
<p><span style="font-size: 15px;">下面的示例使用JDK的<span style="color: #d64e8a;">com.sun.net.httpserver.HttpServer</span>来公布scrape端点：&nbsp;</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> PrometheusMeterRegistry prometheusRegistry <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">new</span> PrometheusMeterRegistry<span style="color: #666666;">(</span>PrometheusConfig<span style="color: #666666;">.</span><span style="color: #bb4444;">DEFAULT</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span> <span style="color: #aa22ff; font-weight: bold;">try</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span>     HttpServer server <span style="color: #666666;">=</span> HttpServer<span style="color: #666666;">.</span><span style="color: #bb4444;">create</span><span style="color: #666666;">(</span><span style="color: #aa22ff; font-weight: bold;">new</span> InetSocketAddress<span style="color: #666666;">(8080),</span> <span style="color: #666666;">0);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span>     server<span style="color: #666666;">.</span><span style="color: #bb4444;">createContext</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"/prometheus"</span><span style="color: #666666;">,</span> httpExchange <span style="color: #666666;">-&gt;</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span>         String response <span style="color: #666666;">=</span> prometheusRegistry<span style="color: #666666;">.</span><span style="color: #bb4444;">scrape</span><span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span>         httpExchange<span style="color: #666666;">.</span><span style="color: #bb4444;">sendResponseHeaders</span><span style="color: #666666;">(200,</span> response<span style="color: #666666;">.</span><span style="color: #bb4444;">getBytes</span><span style="color: #666666;">().</span><span style="color: #bb4444;">length</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span>         <span style="color: #aa22ff; font-weight: bold;">try</span> <span style="color: #666666;">(</span>OutputStream os <span style="color: #666666;">=</span> httpExchange<span style="color: #666666;">.</span><span style="color: #bb4444;">getResponseBody</span><span style="color: #666666;">())</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span>             os<span style="color: #666666;">.</span><span style="color: #bb4444;">write</span><span style="color: #666666;">(</span>response<span style="color: #666666;">.</span><span style="color: #bb4444;">getBytes</span><span style="color: #666666;">());</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span>         <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>     <span style="color: #666666;">});</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">13</span>     <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">Thread</span><span style="color: #666666;">(</span><span style="color: #a0a000;">server:</span><span style="color: #666666;">:</span>start<span style="color: #666666;">).</span><span style="color: #bb4444;">start</span><span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">14</span> <span style="color: #666666;">}</span> <span style="color: #aa22ff; font-weight: bold;">catch</span> <span style="color: #666666;">(</span>IOException e<span style="color: #666666;">)</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">15</span>     <span style="color: #aa22ff; font-weight: bold;">throw</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">RuntimeException</span><span style="color: #666666;">(</span>e<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">16</span> <span style="color: #666666;">}</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="color: #53a451; font-size: 14pt;">3.3.&nbsp; 图表</span></p>
<p><span style="font-size: 15px;">Grafana Dashboard</span></p>
<p><img src="./images/Micrometer 快速入门4.png" alt="" /></p>
<p>&nbsp;</p>
<p><span style="color: #c3453b; font-size: 18pt;">4.&nbsp; Spring Boot 2.0</span></p>
<p><span style="font-size: 15px;">Spring Boot Actuator提供依赖管理并自动配置Micrometer</span></p>
<p><span style="font-size: 15px;">Spring Boot 自动配置一个组合的MeterRegistry，并添加一个registry到这个组合<span style="color: #d64e8a;">MeterRegistry</span>中。</span></p>
<p><span style="font-size: 15px;">你可以注册任意数量的<span style="color: #d64e8a;">MeterRegistryCustomizer</span>来进一步配置registry</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> <span style="color: #aa22ff;">@Bean</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span> MeterRegistryCustomizer<span style="color: #666666;">&lt;</span>MeterRegistry<span style="color: #666666;">&gt;</span> <span style="color: #00a000;">metricsCommonTags</span><span style="color: #666666;">()</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>     <span style="color: #aa22ff; font-weight: bold;">return</span> registry <span style="color: #666666;">-&gt;</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">config</span><span style="color: #666666;">().</span><span style="color: #bb4444;">commonTags</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"region"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"us-east-1"</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span> <span style="color: #666666;">}</span>
</span></code></pre>

<p><span style="font-size: 15px;">你可以在组件中注入MeterRegistry，并注册指标：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> <span style="color: #aa22ff;">@Component</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> <span style="color: #aa22ff; font-weight: bold;">public</span> <span style="color: #aa22ff; font-weight: bold;">class</span> <span style="color: #0000ff;">SampleBean</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span>     <span style="color: #aa22ff; font-weight: bold;">private</span> <span style="color: #aa22ff; font-weight: bold;">final</span> Counter counter<span style="color: #666666;">;</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span>     <span style="color: #aa22ff; font-weight: bold;">public</span> <span style="color: #00a000;">SampleBean</span><span style="color: #666666;">(</span>MeterRegistry registry<span style="color: #666666;">)</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span>         <span style="color: #aa22ff; font-weight: bold;">this</span><span style="color: #666666;">.</span><span style="color: #bb4444;">counter</span> <span style="color: #666666;">=</span> registry<span style="color: #666666;">.</span><span style="color: #bb4444;">counter</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"received.messages"</span><span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span>     <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span>     <span style="color: #aa22ff; font-weight: bold;">public</span> <span style="color: #00bb00; font-weight: bold;">void</span> <span style="color: #00a000;">handleMessage</span><span style="color: #666666;">(</span>String message<span style="color: #666666;">)</span> <span style="color: #666666;">{</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>         <span style="color: #aa22ff; font-weight: bold;">this</span><span style="color: #666666;">.</span><span style="color: #bb4444;">counter</span><span style="color: #666666;">.</span><span style="color: #bb4444;">increment</span><span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span>         <span style="color: #008800; font-style: italic;">// handle message implementation</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">13</span>     <span style="color: #666666;">}</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">14</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">15</span> <span style="color: #666666;">}</span>
</span></code></pre>

<p><span style="font-size: 15px;">Spring Boot为Prometheus提供<span style="color: #d64e8a;">/actuator/prometheus</span>端点</span></p>
<p><span style="font-size: 15px;">下面是一个简单的例子，<span style="color: #d64e8a;">scrape_config</span>添加到<span style="color: #d64e8a;">prometheus.yml</span>中：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">1</span> <span style="color: #a0a000;">scrape_configs:</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">2</span>   <span style="color: #666666;">-</span> <span style="color: #a0a000;">job_name:</span> <span style="border: 1px solid #FF0000;">'</span>spring<span style="border: 1px solid #FF0000;">'</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">3</span>     <span style="color: #a0a000;">metrics_path:</span> <span style="border: 1px solid #FF0000;">'</span><span style="color: #666666;">/</span>actuator<span style="color: #666666;">/</span>prometheus<span style="border: 1px solid #FF0000;">'</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">4</span>     <span style="color: #a0a000;">static_configs:</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">5</span>       <span style="color: #666666;">-</span> <span style="color: #a0a000;">targets:</span> <span style="color: #666666;">[</span><span style="border: 1px solid #FF0000;">'</span><span style="color: #a0a000;">HOST:</span>PORT<span style="border: 1px solid #FF0000;">'</span><span style="color: #666666;">]</span>
</span></code></pre>

<p>&nbsp;</p>
<p><span style="font-size: 18pt; color: #c3453b;">5.&nbsp; JVM、Cache、OkHttpClient</span></p>
<p><span style="font-size: 15px;">Micrometer提供了几个用于监视JVM、Cache等的binder。例如：</span></p>
<src class="highlight" style="background: #f8f8f8;">
<pre><code><span style="font-size: 15px;"><span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 1</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">ClassLoaderMetrics</span><span style="color: #666666;">().</span><span style="color: #bb4444;">bindTo</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 2</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">JvmMemoryMetrics</span><span style="color: #666666;">().</span><span style="color: #bb4444;">bindTo</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 3</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">JvmGcMetrics</span><span style="color: #666666;">().</span><span style="color: #bb4444;">bindTo</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 4</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">ProcessorMetrics</span><span style="color: #666666;">().</span><span style="color: #bb4444;">bindTo</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 5</span> <span style="color: #aa22ff; font-weight: bold;">new</span> <span style="color: #00a000;">JvmThreadMetrics</span><span style="color: #666666;">().</span><span style="color: #bb4444;">bindTo</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">);</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 6</span> 
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 7</span> <span style="color: #008800; font-style: italic;">//  通过添加OkHttpMetricsEventListener来收集OkHttpClient指标</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 8</span> OkHttpClient client <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">new</span> OkHttpClient<span style="color: #666666;">.</span><span style="color: #bb4444;">Builder</span><span style="color: #666666;">()</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;"> 9</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">eventListener</span><span style="color: #666666;">(</span>OkHttpMetricsEventListener<span style="color: #666666;">.</span><span style="color: #bb4444;">builder</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">,</span> <span style="color: #bb4444;">"okhttp.requests"</span><span style="color: #666666;">)</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">10</span>         <span style="color: #666666;">.</span><span style="color: #bb4444;">tags</span><span style="color: #666666;">(</span>Tags<span style="color: #666666;">.</span><span style="color: #bb4444;">of</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"foo"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"bar"</span><span style="color: #666666;">))</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">11</span>         <span style="color: #666666;">.</span><span style="color: #bb4444;">build</span><span style="color: #666666;">())</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">12</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">build</span><span style="color: #666666;">();</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">13</span> <span style="color: #008800; font-style: italic;">//  为了配置URI mapper，可以用uriMapper()</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">14</span> OkHttpClient client <span style="color: #666666;">=</span> <span style="color: #aa22ff; font-weight: bold;">new</span> OkHttpClient<span style="color: #666666;">.</span><span style="color: #bb4444;">Builder</span><span style="color: #666666;">()</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">15</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">eventListener</span><span style="color: #666666;">(</span>OkHttpMetricsEventListener<span style="color: #666666;">.</span><span style="color: #bb4444;">builder</span><span style="color: #666666;">(</span>registry<span style="color: #666666;">,</span> <span style="color: #bb4444;">"okhttp.requests"</span><span style="color: #666666;">)</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">16</span>         <span style="color: #666666;">.</span><span style="color: #bb4444;">uriMapper</span><span style="color: #666666;">(</span>req <span style="color: #666666;">-&gt;</span> req<span style="color: #666666;">.</span><span style="color: #bb4444;">url</span><span style="color: #666666;">().</span><span style="color: #bb4444;">encodedPath</span><span style="color: #666666;">())</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">17</span>         <span style="color: #666666;">.</span><span style="color: #bb4444;">tags</span><span style="color: #666666;">(</span>Tags<span style="color: #666666;">.</span><span style="color: #bb4444;">of</span><span style="color: #666666;">(</span><span style="color: #bb4444;">"foo"</span><span style="color: #666666;">,</span> <span style="color: #bb4444;">"bar"</span><span style="color: #666666;">))</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">18</span>         <span style="color: #666666;">.</span><span style="color: #bb4444;">build</span><span style="color: #666666;">())</span>
<span style="background-color: #f8f8f8; padding: 0 5px 0 5px;">19</span>     <span style="color: #666666;">.</span><span style="color: #bb4444;">build</span><span style="color: #666666;">();</span>&nbsp;</span></code></pre>

<p><span style="font-size: 15px;">还有很多内置的<span style="color: #d64e8a;">Binder</span>，看图：</span></p>
<p><img src="./images/Micrometer 快速入门5.png" alt="" width="538" height="697" />&nbsp;</p>
<p><span style="font-size: 16px;">最后，切记<span style="color: #c3453b;"><strong>文档是用来查的</strong></span>，此处只是一个引子，有个大概印象，等需要用的时候再细查文档即可。</span></p>
<p>&nbsp;</p>
<p><span style="color: #c3453b; font-size: 18pt;">6.&nbsp; 文档</span></p>
<p><span style="font-size: 15px;"><a href="http://micrometer.io" target="_blank">http://micrometer.io</a></span></p>
<p><span style="font-size: 15px;"><a href="http://micrometer.io/docs" target="_blank">http://micrometer.io/docs</a>&nbsp;</span></p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>