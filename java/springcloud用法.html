<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修springcloud用法' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>springcloud用法</center></div><div class='banquan'>原文出处:本文由博客园博主爱华顿g提供。<br/>
原文连接:https://www.cnblogs.com/aihuadung/p/11593303.html</div><br>
    <p>&nbsp;</p>
<p>springcloud用法</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>使用springcloud搭建微服务肯定要在父工程下面编写子工程</p>
<p>&nbsp;</p>
<h2>一.搭建eureka注册中心</h2>
<p>&nbsp;</p>
<h3>1.&nbsp;&nbsp;&nbsp; 创建maven项目(在springboot项目下建立子工程eureka-server)</h3>
<p>&nbsp;</p>
<h3>2.&nbsp;&nbsp;&nbsp; 导入坐标</h3>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<p align="left">&lt;<strong>dependencies</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-eureka-server&lt;/<strong>artifactId</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  &lt;/<strong>dependencies</strong>&gt;</p>




  </td>




 </tr>




</tbody>



</table>
<p>&nbsp;</p>
<h3>3.&nbsp;&nbsp;&nbsp;
创建引导类</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code>@SpringBootApplication<br />
  <strong>@EnableEurekaServer&nbsp; <em>//</em></strong><strong><em>添加注解 表名服务,声明这个应用时EurekaServer</em></strong><em><br />
  </em><strong>public class </strong>EurekaManager {<br />
&nbsp;&nbsp;&nbsp; <strong>public static void </strong>main(String[] args) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringApplication.<em>run</em>(EurekaManager.<strong>class</strong>,args);<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>4.&nbsp;&nbsp;&nbsp; 编写配置文件</h3>
<p>编写application.yml文件</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>server:<br />
&nbsp; port: </strong>10086<br />
  <strong>spring:<br />
&nbsp; application:<br />
&nbsp;&nbsp;&nbsp; name: </strong>eureka-server&nbsp; <em>#</em><em>自己注册的serviceId,即注册名称</em></code></pre>
<pre><code><br />
  <strong>eureka:<br />
&nbsp; client:<br />
&nbsp;&nbsp;&nbsp; service-url:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; defaultZone: </strong><strong>http://127.0.0.1:10086/eureka</strong></code></pre>
<pre><code><br />
&nbsp;&nbsp;&nbsp; <strong>register-with-eureka: true&nbsp;&nbsp; </strong><em>#</em><em>注册自己,默认为true<br />
&nbsp;&nbsp;&nbsp; </em><strong>fetch-registry: true&nbsp; </strong><em>#</em><em>拉取服务,默认为true</em></code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>5.&nbsp;&nbsp;&nbsp; 效果截图</h3>
<p>&nbsp;<img src="./images/springcloud用法0.png" alt="" /></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>二.搭建提供者,user-service</h2>
<p>提供者user-service对于注册中心而言还是客户端</p>
<h3>1.&nbsp;&nbsp;&nbsp; 创建maven工程user-service</h3>
<h3>2.&nbsp;&nbsp;&nbsp; 导入坐标</h3>
<p>&nbsp;</p>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><em>&lt;!--</em><em>添加坐标--&gt;<br />
  </em>&lt;<strong>dependencies</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.boot&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-boot-starter-web&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;mysql&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;mysql-connector-java&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;tk.mybatis&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;mapper-spring-boot-starter&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
  &nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-eureka-client&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
  &lt;/<strong>dependencies</strong>&gt;</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>3.&nbsp;&nbsp;&nbsp; 编写启动类</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.ahd;<br />
  <br />
  <strong>import </strong>org.springframework.boot.SpringApplication;<br />
  <strong>import </strong>org.springframework.boot.autoconfigure.SpringBootApplication;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br />
  <strong>import </strong>org.springframework.context.annotation.Bean;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <strong>import </strong>tk.mybatis.spring.annotation.MapperScan;<br />
  <br />
  <strong>@SpringBootApplication<br />
@EnableDiscoveryClient&nbsp; <em>//</em></strong><strong><em>使用这个注解 针对所有注册中心,<br />
//@EnableEurekaClient&nbsp; 这个注解只针对eureka的注册中心</em></strong><em><br />
  </em>@MapperScan(<strong>"com.ahd.mapper"</strong>)<br />
  <strong>public class </strong>UserServiceApplication {<br />
&nbsp;&nbsp;&nbsp; <strong>public static void </strong>main(String[] args) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringApplication.<em>run</em>(UserServiceApplication.<strong>class</strong>,args);<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>4. 编写配置文件</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>server:<br />
&nbsp; port: </strong>8181<br />
  <strong>spring:<br />
&nbsp; datasource:<br />
&nbsp;&nbsp;&nbsp; driver-class-name: </strong>com.mysql.jdbc.Driver<br />
&nbsp;&nbsp;&nbsp; <strong>url: </strong>jdbc:mysql://127.0.0.1:3306/cloud_test<br />
&nbsp;&nbsp;&nbsp; <strong>username: </strong>root<br />
&nbsp;&nbsp;&nbsp; <strong>password: </strong>123456<br />
&nbsp; <strong>application:<br />
&nbsp;&nbsp;&nbsp; name: </strong>user-service<br />
  <strong>eureka:<br />
&nbsp; client:<br />
&nbsp;&nbsp;&nbsp; service-url:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; defaultZone: </strong>http://127.0.0.1:10086/eureka<br />
&nbsp;&nbsp;&nbsp; <strong>register-with-eureka: true&nbsp; </strong><em>#</em><em>默认的<br />
&nbsp;&nbsp;&nbsp; </em><strong>fetch-registry: true&nbsp; </strong><em>#</em><em>默认的</em></code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>5. 编写具体业务逻辑</h3>
<p>略</p>
<p>&nbsp;</p>
<h3>6.&nbsp;&nbsp;&nbsp; 编写controller层代码</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.ahd.controller;<br />
  <br />
  <strong>import </strong>com.ahd.pojo.User;<br />
  <strong>import </strong>com.ahd.service.UserService;<br />
  <strong>import </strong>org.springframework.beans.factory.annotation.Autowired;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.GetMapping;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.PathVariable;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.RestController;<br />
  <br />
  @RestController<br />
  <strong>public class </strong>UserController {<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>UserService <strong>userService</strong>;<br />
  <br />
&nbsp;&nbsp;&nbsp; @GetMapping(<strong>"/user/{id}"</strong>)<br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>User findById(@PathVariable(<strong>"id"</strong>) Long id){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return </strong><strong>userService</strong>.findById(id);<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>三.负载均衡Ribbon</h2>
<p>当消费方 向 提供方发送请求,可能有多个提供方,这时候就需要考虑向那个提供方发送请求了</p>
<p>&nbsp;</p>
<h3>1.&nbsp;&nbsp;&nbsp; 创建消费者maven工程</h3>
<p>consumer</p>
<h3>2.&nbsp;&nbsp;&nbsp; 导入坐标</h3>
<p>eureka中已经继承了ribbon的坐标,不需要导入,展示一下所有坐标</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code>&lt;<strong>dependencies</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-eureka-client&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.boot&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-boot-starter-web&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  &lt;/<strong>dependencies</strong>&gt;</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>3.&nbsp;&nbsp;&nbsp; 编写引导类</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and;<br />
  <br />
  <strong>import </strong>org.springframework.boot.SpringApplication;<br />
  <strong>import </strong>org.springframework.boot.autoconfigure.SpringBootApplication;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br />
  <strong>import </strong>org.springframework.cloud.client.loadbalancer.LoadBalanced;<br />
  <strong>import </strong>org.springframework.context.annotation.Bean;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <br />
  @SpringBootApplication<br />
@EnableDiscoveryClient&nbsp; <em>//</em><em>使用这个注解 针对所有注册中心,<br />
//@EnableEurekaClient&nbsp; 这个注解只针对eureka的注册中心<br />
  </em><strong>public class </strong>ConsumerApplication {<br />
&nbsp;&nbsp;&nbsp; <strong>public static void </strong>main(String[] args) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringApplication.<em>run</em>(ConsumerApplication.<strong>class</strong>,args);<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
&nbsp;&nbsp;&nbsp; @Bean<br />
&nbsp;<strong>&nbsp;&nbsp; @LoadBalanced</strong><br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>RestTemplate getTemplate(){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return new </strong>RestTemplate();<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>4.&nbsp;&nbsp;&nbsp; 编写配置文件application.yml文件</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>server:<br />
&nbsp; port: </strong>8180<br />
  <strong>spring:<br />
&nbsp; application:<br />
&nbsp;&nbsp;&nbsp; name: </strong>consumer<br />
  <strong>eureka:<br />
&nbsp; client:<br />
&nbsp;&nbsp;&nbsp; fetch-registry: true&nbsp; </strong><em>#</em><em>默认的,可以不写<br />
&nbsp;&nbsp;&nbsp; </em><strong>service-url:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; defaultZone: </strong>http://127.0.0.1:10086/eureka<br />
&nbsp;&nbsp;&nbsp; <strong>register-with-eureka: true </strong><em>#</em><em>默认的,可以不写<br />
  </em><strong>ribbon:<br />
&nbsp; eager-load:<br />
&nbsp;&nbsp;&nbsp; enabled: true&nbsp; </strong><em>#</em><em>开启饥饿加载,默认是不开启,采用懒加载<br />
&nbsp;&nbsp;&nbsp; </em><strong>clients: </strong>user-service&nbsp; <em>#</em><em>需要指定是哪个提供方<br />
  </em><strong>user-service:<br />
&nbsp; ribbon:<br />
&nbsp;&nbsp;&nbsp; NFLoadBalancerRuleClassName: </strong>com.netflix.loadbalancer.RandomRule&nbsp; <em>#</em><em>配置负载均衡的策略,默认是轮训,这里是随机</em></code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>5.&nbsp;&nbsp;&nbsp; 编写controller层(发送请求的类)</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and.controller;<br />
  <br />
  <strong>import </strong>com.and.pojo.User;<br />
  <strong>import </strong>org.springframework.beans.factory.annotation.Autowired;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.DiscoveryClient;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.GetMapping;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.PathVariable;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.RestController;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <br />
  <br />
  @RestController<br />
  <strong>public class </strong>ConsumerController {<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>RestTemplate <strong>restTemplate</strong>;<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>DiscoveryClient <strong>discoveryClient</strong>;<br />
&nbsp;&nbsp;&nbsp; @GetMapping(<strong>"/user/{id}"</strong>)<br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>User getUserFromService(@PathVariable(<strong>"id"</strong>) Long id){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <em>/*</em><em>不使用负载均衡时使用的方法,使用ribbon负载均衡不需要自己选择哪个提供者<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances("USER-SERVICE");<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ServiceInstance serviceInstance = instances.get(0);<br />
  <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String host = serviceInstance.getHost();<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int port = serviceInstance.getPort();<br />
  <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String url = String.format("http://%s:%d/user/%d", host, port, id);*/<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </em><strong><em>&nbsp;</em></strong><strong>String url="http://user-service/user/"+id;</strong><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return </strong><strong>restTemplate</strong>.getForObject(url,User.<strong>class</strong>);<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>四.Hystrix-服务降级</h2>
<p>&nbsp;</p>
<p>两大主要作用:</p>
<p>线程隔离,服务降级</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 服务熔断</p>
<p>一般作用于消费者</p>
<p>&nbsp;</p>
<h3>1.&nbsp;&nbsp;&nbsp; 引入坐标</h3>
<p>在源consumer基础上添加一下坐标即可</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<p>&lt;dependency&gt;</p>
<p>&nbsp;&nbsp;&nbsp; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</p>
<p>&nbsp;&nbsp;&nbsp; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</p>
<p>&lt;/dependency&gt;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>完整坐标:</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code>&lt;<strong>dependencies</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-eureka-client&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.boot&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-boot-starter-web&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-hystrix&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
  <br />
  &lt;/<strong>dependencies</strong>&gt;</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>2.&nbsp;&nbsp;&nbsp; 配置引导类</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and;<br />
  <br />
  <strong>import </strong>org.springframework.boot.SpringApplication;<br />
  <strong>import </strong>org.springframework.boot.autoconfigure.SpringBootApplication;<br />
  <strong>import </strong>org.springframework.cloud.client.SpringCloudApplication;<br />
  <strong>import </strong>org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br />
  <strong>import </strong>org.springframework.cloud.client.loadbalancer.LoadBalanced;<br />
  <strong>import </strong>org.springframework.cloud.netflix.hystrix.EnableHystrix;<br />
  <strong>import </strong>org.springframework.context.annotation.Bean;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <br />
  <em>/*@SpringBootApplication<br />
@EnableDiscoveryClient&nbsp; //</em><em>使用这个注解 针对所有注册中心,<br />
//@EnableEurekaClient&nbsp; 这个注解只针对eureka的注册中心<br />
@EnableCircuitBreaker&nbsp; 这个是hystrix的注解*/<br />
  </em><strong>@SpringCloudApplication&nbsp; <em>//</em></strong><strong><em>代表上面的三个注解</em></strong><em><br />
  </em><strong>public class </strong>ConsumerApplication {<br />
&nbsp;&nbsp;&nbsp; <strong>public static void </strong>main(String[] args) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringApplication.<em>run</em>(ConsumerApplication.<strong>class</strong>,args);<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
&nbsp;&nbsp;&nbsp; @Bean<br />
&nbsp;&nbsp;&nbsp; @LoadBalanced<br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>RestTemplate getTemplate(){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return new </strong>RestTemplate();<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>3.&nbsp;&nbsp;&nbsp; 改写Controller类</h3>
<p><strong>方式一:</strong><strong>针对方法服务降级</strong></p>
<p><strong>&nbsp;</strong></p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and.controller;<br />
  <br />
  <strong>import </strong>com.and.pojo.User;<br />
  <strong>import </strong>com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;<br />
  <strong>import </strong>org.springframework.beans.factory.annotation.Autowired;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.DiscoveryClient;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.GetMapping;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.PathVariable;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.RestController;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <br />
  <br />
  @RestController<br />
  <strong>public class </strong>ConsumerController {<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>RestTemplate <strong>restTemplate</strong>;<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>DiscoveryClient <strong>discoveryClient</strong>;<br />
&nbsp;&nbsp;&nbsp; @GetMapping(<strong>"/user/{id}"</strong>)<br />
&nbsp;&nbsp;&nbsp; <strong>@HystrixCommand(fallbackMethod = "fallBack")</strong><br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>String getUserFromService(@PathVariable(<strong>"id"</strong>) Long id){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String url=<strong>"http://user-service/user/"</strong>+id;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return </strong><strong>restTemplate</strong>.getForObject(url,User.<strong>class</strong>).toString();<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
  <br />
  <strong>&nbsp;&nbsp;&nbsp; public String fallBack(Long id){<em>//</em></strong><strong><em>返回值和参数必须和对应方法保持一致<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </em></strong><strong>return "</strong><strong>网络开了一个小差"</strong><strong>;<br />
&nbsp;&nbsp;&nbsp; }</strong><br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><strong>方式二:</strong><strong>针对类进行服务降级</strong></p>
<p><strong>&nbsp;</strong></p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and.controller;<br />
  <br />
  <strong>import </strong>com.and.pojo.User;<br />
  <strong>import </strong>com.netflix.hystrix.contrib.javanica.annotation.DefaultProperties;<br />
  <strong>import </strong>com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;<br />
  <strong>import </strong>org.springframework.beans.factory.annotation.Autowired;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.DiscoveryClient;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.GetMapping;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.PathVariable;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.RestController;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <br />
  <br />
  @RestController<br />
  <strong>@DefaultProperties(defaultFallback = "quanjuFallBack")</strong><br />
  <strong>public class </strong>ConsumerController {<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>RestTemplate <strong>restTemplate</strong>;<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>DiscoveryClient <strong>discoveryClient</strong>;<br />
&nbsp;&nbsp;&nbsp; @GetMapping(<strong>"/user/{id}"</strong>)<br />
&nbsp;&nbsp; <strong>&nbsp;@HystrixCommand</strong><br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>String getUserFromService(@PathVariable(<strong>"id"</strong>) Long id){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String url=<strong>"http://user-service/user/"</strong>+id;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return </strong><strong>restTemplate</strong>.getForObject(url,User.<strong>class</strong>).toString();<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
  <br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>String fallBack(Long id){<em>//</em><em>返回值和参数必须和对应方法保持一致<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </em><strong>return </strong><strong>"</strong><strong>网络开了一个小差"</strong>;<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>String quanjuFallBack(){ <em>//</em><em>针对多个方法,不需要配置参数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </em><strong>return </strong><strong>"</strong><strong>全局配置:网络开了一个小差"</strong>;<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p><strong>&nbsp;</strong></p>
</td>
</tr>
</tbody>
</table>
<p><strong>&nbsp;</strong></p>
<h3>4.&nbsp;&nbsp;&nbsp; 修改配置文件application.yml</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>server:<br />
&nbsp; port: </strong>8180<br />
  <strong>spring:<br />
&nbsp; application:<br />
&nbsp;&nbsp;&nbsp; name: </strong>consumer<br />
  <strong>eureka:<br />
&nbsp; client:<br />
&nbsp;&nbsp;&nbsp; fetch-registry: true&nbsp; </strong><em>#</em><em>默认的,可以不写<br />
&nbsp;&nbsp;&nbsp; </em><strong>service-url:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; defaultZone: </strong>http://127.0.0.1:10086/eureka<br />
&nbsp;&nbsp;&nbsp; <strong>register-with-eureka: true </strong><em>#</em><em>默认的,可以不写<br />
  </em><strong>ribbon:<br />
&nbsp; eager-load:<br />
&nbsp;&nbsp;&nbsp; enabled: true&nbsp; </strong><em>#</em><em>开启饥饿加载,默认是不开启,采用懒加载<br />
&nbsp;&nbsp;&nbsp; </em><strong>clients: </strong>user-service&nbsp; <em>#</em><em>需要指定是哪个提供方<br />
  </em><strong>user-service:<br />
&nbsp; ribbon:<br />
&nbsp;&nbsp;&nbsp; NFLoadBalancerRuleClassName: </strong>com.netflix.loadbalancer.RandomRule&nbsp; <em>#</em><em>配置负载均衡的策略,默认是轮训,这里是随机<br />
  </em><strong>hystrix:<br />
&nbsp; command:<br />
&nbsp;&nbsp;&nbsp; default:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; execution:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; isolation:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; thread:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; timeoutInMilliseconds: </strong><strong>2000&nbsp; <em>#</em></strong><strong><em>超时时间配置,超过这个时间请求还没有响应,服务降级</em></strong></code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p><strong>&nbsp;</strong></p>
<p><strong>配置文件响应时间修改为两秒也是为了测试</strong></p>
<h3>5.&nbsp;&nbsp;&nbsp; 运行结果</h3>
<p>为了获取测试结果,在提供方进行了两秒的睡眠</p>
<p>&nbsp;<img src="./images/springcloud用法1.png" alt="" /></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>最终结果效果图:</p>
<p>&nbsp;<img src="./images/springcloud用法2.png" alt="" /></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>五.Hystrix-服务熔断</h2>
<p>这个东西好搞,和服务降级配置相同</p>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code>@GetMapping(<strong>"/user/{id}"</strong>)<br />
  @HystrixCommand<br />
  <strong>public </strong>String getUserFromService(@PathVariable(<strong>"id"</strong>) Long id){<br />
  <strong>&nbsp;&nbsp;&nbsp; if(id==1){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new RuntimeException();<br />
&nbsp;&nbsp;&nbsp; }</strong>//方便进行测试<br />
  <br />
&nbsp;&nbsp; String url=<strong>"http://user-service/user/"</strong>+id;<br />
&nbsp;&nbsp;&nbsp; <strong>return </strong><strong>restTemplate</strong>.getForObject(url,User.<strong>class</strong>).toString();<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p align="left">熔断器的默认触发阈值是20次请求，不好触发。休眠时间时5秒，时间太短，不易观察，为了测试方便，我们可以通过配置修改熔断策略：</p>
<src>
<p align="left"><br />
circuitBreaker.requestVolumeThreshold=10<br />
circuitBreaker.sleepWindowInMilliseconds=10000<br />
circuitBreaker.errorThresholdPercentage=50</p>






<p align="left">解读：</p>
<ul>
<li>requestVolumeThreshold：触发熔断的最小请求次数，默认20</li>
<li>sleepWindowInMilliseconds：休眠时长，默认是5000毫秒</li>
<li>errorThresholdPercentage：触发熔断的失败请求最小占比，默认50%</li>



</ul>
<p><strong>在类中进行配置</strong><strong>,</strong><strong>配置方式</strong></p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code>@HystrixCommand(commandProperties={@HystrixProperty(name=<strong>"circuitBreaker.requestVolumeThreshold"</strong>,value=<strong>"10"</strong>),<br />
&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@HystrixProperty(name=<strong>"circuitBreaker.sleepWindowInMilliseconds"</strong>,value=<strong>"10000"</strong>),<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @HystrixProperty(name=<strong>"circuitBreaker.errorThresholdPercentage"</strong>,value=<strong>"50"</strong>)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })</code></pre>
<p><strong>&nbsp;</strong></p>
</td>
</tr>
</tbody>
</table>
<p><strong>&nbsp;</strong></p>
<h2>六.feign</h2>
<p>&nbsp;</p>
<p>feign :伪装</p>
<p>&nbsp;</p>
<p>减少重复代码</p>
<p>&nbsp;</p>
<h3>1.&nbsp;&nbsp;&nbsp; 导入坐标</h3>
<p>添加坐标:</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code>&lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-openfeign&lt;/<strong>artifactId</strong>&gt;<br />
  &lt;/<strong>dependency</strong>&gt;</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>完整坐标:</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code>&lt;<strong>dependencies</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-eureka-client&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.boot&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-boot-starter-web&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-hystrix&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
&nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&lt;<strong>artifactId</strong>&gt;spring-cloud-starter-openfeign&lt;/<strong>artifactId</strong>&gt;<br />
&nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  <br />
  <br />
  &lt;/<strong>dependencies</strong>&gt;</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>2.&nbsp;&nbsp;&nbsp; 修改引导类(添加feign的注解)</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and;<br />
  <br />
  <strong>import </strong>org.springframework.boot.SpringApplication;<br />
  <strong>import </strong>org.springframework.boot.autoconfigure.SpringBootApplication;<br />
  <strong>import </strong>org.springframework.cloud.client.SpringCloudApplication;<br />
  <strong>import </strong>org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br />
  <strong>import </strong>org.springframework.cloud.client.loadbalancer.LoadBalanced;<br />
  <strong>import </strong>org.springframework.cloud.netflix.hystrix.EnableHystrix;<br />
  <strong>import </strong>org.springframework.cloud.openfeign.EnableFeignClients;<br />
  <strong>import </strong>org.springframework.context.annotation.Bean;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <br />
  <em>/*@SpringBootApplication<br />
@EnableDiscoveryClient&nbsp; //</em><em>使用这个注解 针对所有注册中心,<br />
//@EnableEurekaClient&nbsp; 这个注解只针对eureka的注册中心<br />
@EnableCircuitBreaker&nbsp; 这个是hystrix的注解*/<br />
  </em>@SpringCloudApplication&nbsp; <em>//</em><em>代表上面的三个注解<br />
  </em><strong>@EnableFeignClients&nbsp; <em>//</em></strong><strong><em>开启feign功能</em></strong><em><br />
  </em><strong>public class </strong>ConsumerApplication {<br />
&nbsp;&nbsp;&nbsp; <strong>public static void </strong>main(String[] args) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringApplication.<em>run</em>(ConsumerApplication.<strong>class</strong>,args);<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
&nbsp;&nbsp;&nbsp; @Bean<br />
&nbsp;&nbsp;&nbsp; @LoadBalanced<br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>RestTemplate getTemplate(){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return new </strong>RestTemplate();<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>3.&nbsp;&nbsp;&nbsp; 编写feign的接口</h3>
<p>feign支持springmvc所有的注解</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and.feign;<br />
  <br />
  <strong>import </strong>com.and.pojo.User;<br />
  <strong>import </strong>org.springframework.cloud.openfeign.FeignClient;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.GetMapping;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.PathVariable;<br />
  <br />
  @FeignClient(<strong>"user-service"</strong>)<br />
  <strong>public interface </strong>UserClient {<br />
&nbsp;&nbsp;&nbsp; @GetMapping(<strong>"/user/{id}"</strong>) <em>//</em><em>这里的返回结果和 url地址一定要和提供方保持一致<br />
&nbsp;&nbsp;&nbsp; </em>User getUserFromService(@PathVariable(<strong>"id"</strong>) Long id);<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>4.&nbsp;&nbsp;&nbsp; 修改controller层代码</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.and.controller;<br />
  <br />
  <strong>import </strong>com.and.feign.UserClient;<br />
  <strong>import </strong>com.and.pojo.User;<br />
  <strong>import </strong>com.netflix.hystrix.contrib.javanica.annotation.DefaultProperties;<br />
  <strong>import </strong>com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;<br />
  <strong>import </strong>com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;<br />
  <strong>import </strong>org.springframework.beans.factory.annotation.Autowired;<br />
  <strong>import </strong>org.springframework.cloud.client.discovery.DiscoveryClient;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.GetMapping;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.PathVariable;<br />
  <strong>import </strong>org.springframework.web.bind.annotation.RestController;<br />
  <strong>import </strong>org.springframework.web.client.RestTemplate;<br />
  <br />
  <br />
  @RestController<br />
@DefaultProperties(defaultFallback = <strong>"quanjuFallBack"</strong>)<br />
  <strong>public class </strong>ConsumerController {<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>RestTemplate <strong>restTemplate</strong>;<br />
&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; <strong>private </strong>DiscoveryClient <strong>discoveryClient</strong>;<br />
  <strong>&nbsp;&nbsp;&nbsp; @Autowired<br />
&nbsp;&nbsp;&nbsp; private UserClient userClient;</strong><br />
&nbsp;&nbsp;&nbsp; @GetMapping(<strong>"/user/{id}"</strong>)<br />
&nbsp;&nbsp;&nbsp; @HystrixCommand<br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>String getUserFromService(@PathVariable(<strong>"id"</strong>) Long id){<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>return userClient</strong><strong>.getUserFromService(id).toString();</strong><br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
  <br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>String fallBack(Long id){<em>//</em><em>返回值和参数必须和对应方法保持一致<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </em><strong>return </strong><strong>"</strong><strong>网络开了一个小差"</strong>;<br />
&nbsp;&nbsp;&nbsp; }<br />
  <br />
&nbsp;&nbsp;&nbsp; <strong>public </strong>String quanjuFallBack(){ <em>//</em><em>针对多个方法,不需要配置参数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </em><strong>return </strong><strong>"</strong><strong>全局配置:网络开了一个小差"</strong>;<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<h3>5.&nbsp;&nbsp;&nbsp; feign其他拓展</h3>
<p>feign继承了ribbon,不需要再单独配置,也不需要再配置RestTemplate,</p>
<p>&nbsp;</p>
<p align="left">Fegin内置的ribbon默认设置了请求超时时长，默认是1000ms，我们可以通过手动配置来修改这个超时时长：</p>
<src>
<p align="left"><br />
ribbon:<br />
&nbsp; ReadTimeout: 2000 # 读取超时时长<br />
&nbsp; ConnectTimeout: 1000 # 建立链接的超时时长</p>






<p align="left">，因为ribbon内部有重试机制，一旦超时，会自动重新发起请求。如果不希望重试，可以添加配置：</p>
<src>
<p align="left"><br />
ribbon:<br />
&nbsp; ReadTimeout: 2000 # 数据通信超时时长<br />
&nbsp; ConnectTimeout: 500 # 连接超时时长 &nbsp;<br />
&nbsp; MaxAutoRetries: 0 # 当前服务器的重试次数<br />
&nbsp; MaxAutoRetriesNextServer: 1 # 重试多少次服务<br />
&nbsp; OkToRetryOnAllOperations: false # 是否对所有的请求方式都重试</p>






<p align="left">另外，hystrix的超时时间，应该比重试的总时间要大，比如当前案例中，应该配 大于2500*2 = 5000</p>
<p>&nbsp;</p>
<h3>6.&nbsp;&nbsp;&nbsp;
feign内置hystrix</h3>
<p>&nbsp;</p>
<p class="md-focus-p">只不过，默认情况下是关闭的。我们需要通过下面的参数来开启：</p>
<src>
<pre><code><br />
feign:<br />
&nbsp; hystrix:<br />
&nbsp;&nbsp;&nbsp; enabled: true # 开启Feign的熔断功能</code></pre>

<p>但是，Feign中的Fallback配置不像Ribbon中那样简单了</p>
<p align="left">1）首先，我们要定义一个类，实现刚才编写的UserFeignClient，作为fallback的处理类</p>
<src>
<p align="left"><br />
@Component<br />
public class UserClientFallback implements UserClient {<br />
&nbsp;&nbsp; &nbsp;@Override<br />
&nbsp;&nbsp; &nbsp;public User queryById(Long id) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;User user = new User();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;user.setId(id);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;user.setName("用户查询出现异常！");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;return user;<br />
&nbsp;&nbsp;&nbsp;
}<br />
}</p>






<p align="left">2）然后在UserFeignClient中，指定刚才编写的实现类</p>
<src>
<p align="left"><br />
@FeignClient(value = "user-service", fallback = UserFeignClientFallback.class)<br />
public interface UserClient {<br />
​<br />
&nbsp;&nbsp; &nbsp;@GetMapping("/user/{id}")<br />
&nbsp;&nbsp; &nbsp;User queryById(@PathVariable("id") Long id);<br />
}<br />
​</p>






<p>&nbsp;</p>
<h3>7.&nbsp;&nbsp;&nbsp;
feign请求压缩</h3>
<p>Spring Cloud Feign 支持对请求和响应进行GZIP压缩，以减少通信过程中的性能损耗。通过下面的参数即可开启请求与响应的压缩功能：</p>
<src>
<pre><code><br />
feign:<br />
&nbsp; compression:<br />
&nbsp;&nbsp;&nbsp; request:<br />
&nbsp;&nbsp; &nbsp;&nbsp; enabled: true # 开启请求压缩<br />
&nbsp;&nbsp;&nbsp; response:<br />
&nbsp;&nbsp; &nbsp;&nbsp; enabled: true # 开启响应压缩</code></pre>

<p>同时，我们也可以对请求的数据类型，以及触发压缩的大小下限进行设置：</p>
<src>
<pre><code><br />
feign:<br />
&nbsp; compression:<br />
&nbsp;&nbsp;&nbsp; request:<br />
&nbsp;&nbsp; &nbsp;&nbsp; enabled: true # 开启请求压缩<br />
&nbsp;&nbsp; &nbsp;&nbsp; mime-types: text/html,application/xml,application/json # 设置压缩的数据类型<br />
&nbsp;&nbsp; &nbsp;&nbsp; min-request-size: 2048 # 设置触发压缩的大小下限</code></pre>

<p>注：上面的数据类型、压缩大小下限均为默认值。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>8.&nbsp;&nbsp;&nbsp; feign日志级别</h3>
<p align="left">前面讲过，通过logging.level.xx=debug来设置日志级别。然而这个对Fegin客户端而言不会产生效果。因为@FeignClient注解修改的客户端在被代理时，都会创建一个新的Fegin.Logger实例。我们需要额外指定这个日志的级别才可以。</p>
<p align="left">1）设置cn.itcast包下的日志级别都为debug</p>
<src>
<p align="left"><br />
logging:<br />
&nbsp; level:<br />
&nbsp;&nbsp;&nbsp;
cn.itcast: debug</p>






<p align="left">2）编写配置类，定义日志级别</p>
<src>
<p align="left"><br />
@Configuration<br />
public class FeignConfig {<br />
&nbsp;&nbsp; &nbsp;@Bean<br />
&nbsp;&nbsp; &nbsp;Logger.Level feignLoggerLevel(){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;return Logger.Level.FULL;<br />
&nbsp;&nbsp;&nbsp;
}<br />
}</p>






<p align="left">这里指定的Level级别是FULL，Feign支持4种级别：</p>
<p align="left">&nbsp;</p>
<ul>
<li>NONE：不记录任何日志信息，这是默认值。</li>
<li>BASIC：仅记录请求的方法，URL以及响应状态码和执行时间</li>
<li>HEADERS：在BASIC的基础上，额外记录了请求和响应的头信息</li>
<li>FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据。</li>



</ul>
<p align="left">3）在FeignClient中指定配置类：</p>
<src>
<p align="left"><br />
@FeignClient(value = "user-service", fallback = UserClientFallback.class, configuration = FeignConfig.class)<br />
public interface UserClient {<br />
&nbsp;&nbsp; &nbsp;@GetMapping("/user/{id}")<br />
&nbsp;&nbsp; &nbsp;User queryById(@PathVariable("id") Long id);<br />
}</p>






<p align="left">4）重启项目，即可看到每次访问的日志：</p>
<p align="left">&nbsp;</p>
<p align="left">&nbsp;</p>
<h2>七.Zuul网关</h2>
<p>网关的核心功能是：过滤和路由</p>
<p>&nbsp;</p>
<h3>1.&nbsp;&nbsp;&nbsp;
新建maven工程</h3>
<p>略,zuul-server</p>
<h3>2.&nbsp;&nbsp;&nbsp;
配置依赖坐标</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<p align="left">&lt;<strong>dependencies</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-zuul&lt;/<strong>artifactId</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp; &lt;<strong>dependency</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>groupId</strong>&gt;org.springframework.cloud&lt;/<strong>groupId</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<strong>artifactId</strong>&gt;spring-cloud-starter-netflix-eureka-client&lt;/<strong>artifactId</strong>&gt;<br />
  &nbsp;&nbsp;&nbsp; &lt;/<strong>dependency</strong>&gt;<br />
  &lt;/<strong>dependencies</strong>&gt;</p>
<p>&nbsp;</p>




  </td>




 </tr>




</tbody>



</table>
<p>&nbsp;</p>
<h3>3.&nbsp;&nbsp;&nbsp;
编写启动类</h3>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>package </strong>com.ahd;<br />
  <br />
  <strong>import </strong>org.springframework.boot.SpringApplication;<br />
  <strong>import </strong>org.springframework.boot.autoconfigure.SpringBootApplication;<br />
  <strong>import </strong>org.springframework.cloud.netflix.zuul.EnableZuulProxy;<br />
  <br />
  @SpringBootApplication<br />
  <strong>@EnableZuulProxy <em>//</em></strong><strong><em>开启zuul网关</em></strong><em><br />
  </em><strong>public class </strong>ZuulApplication {<br />
&nbsp;&nbsp;&nbsp; <strong>public static void </strong>main(String[] args) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringApplication.<em>run</em>(ZuulApplication.<strong>class</strong>,args);<br />
&nbsp;&nbsp;&nbsp; }<br />
}</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>4.&nbsp;&nbsp;&nbsp; 编写配置</h3>
<p>application.yml</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<pre><code><strong>server:<br />
&nbsp; port: </strong>10010<br />
  <strong>spring:<br />
&nbsp; application:<br />
&nbsp;&nbsp;&nbsp; name: </strong>zuul-server<br />
  <em>#</em><em>编写路由规则<br />
#user-service:<br />
#&nbsp; routes:<br />
#&nbsp;&nbsp;&nbsp; path: /user-service/**&nbsp; #这里是映射路径<br />
#&nbsp;&nbsp;&nbsp; url: http://127.0.0.1:8181 #映射路径对应的实际url地址<br />
#如果配置了eureka,上面的代码可以写成<br />
#user-service:<br />
#&nbsp; routes:<br />
#&nbsp;&nbsp;&nbsp; path: /user-service/**&nbsp; #这里是映射路径<br />
#&nbsp;&nbsp;&nbsp; serviceId: user-service #映射路径对应的实际url地址<br />
  <br />
  </em><strong>user-service: </strong>/user-service/**&nbsp; <em>#</em><em>如果配置了eureka,上面代码可以简写成这行,这行也可以不写<br />
  </em><strong>eureka:<br />
&nbsp; client:<br />
&nbsp;&nbsp;&nbsp; service-url:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; defaul&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tZone: </strong>http://127.0.0.1:10086/eureka</code></pre>
<p>&nbsp;</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>5.&nbsp;&nbsp;&nbsp; 禁用路由规则</h3>
<p class="md-focus-p">默认情况下，一切服务的映射路径就是服务名本身。</p>
<p>a)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 例如服务名为：<code>user-service</code>，则默认的映射路径就是：<code>/user-service/**</code></p>
<p>也就是说，刚才的映射规则我们完全不配置也是OK的，不信就试试看。</p>
<p>如果想要禁用某个路由规则，可以这样：</p>
<src>
<pre><code><br />
zuul:<br />
&nbsp; ignored-services:<br />
&nbsp;&nbsp;&nbsp; - user-service<br />
&nbsp;&nbsp;&nbsp; - consumer</code></pre>

<p>&nbsp;</p>
<h3>6.&nbsp;&nbsp;&nbsp; 路由前缀</h3>
<p>&nbsp;</p>
<p align="left">配置示例：</p>
<src>
<p align="left"><br />
zuul:<br />
&nbsp; prefix: /api # 添加路由前缀<br />
&nbsp; routes:<br />
&nbsp;&nbsp;&nbsp;
user-service: /user-service/** # 这里是映射路径</p>






<p align="left">我们通过zuul.prefix=/api来指定了路由的前缀，这样在发起请求时，路径就要以/api开头。</p>
<p align="left">路径/api/user-service/user/1将会被代理到/user-service/user/1</p>
<p align="left">忽略路由前缀：</p>
<src>
<p align="left"><br />
zuul:<br />
&nbsp; prefix: /api<br />
&nbsp; routes:<br />
&nbsp;&nbsp;&nbsp;
user-service:<br />
&nbsp;&nbsp; &nbsp;&nbsp;
path: /user/**<br />
&nbsp;&nbsp; &nbsp;&nbsp;
serviceId: user-service<br />
&nbsp;&nbsp; &nbsp;&nbsp;
strip-prefix: false # 是否在转发时，去除路由前缀，这里不去除，映射路径中的user就会继续转发</p>






<p align="left">此时，只需要访问：<a href="http://localhost:10010/api/user/1">http://localhost:10010/api/user/1</a></p>
<h3>7.&nbsp;&nbsp;&nbsp;
过滤器</h3>
<p class="md-focus-p">Zuul作为网关的其中一个重要功能，就是实现请求的鉴权。而这个动作我们往往是通过Zuul提供的过滤器来实现的。</p>
<p>ZuulFilter是过滤器的顶级父类。在这里我们看一下其中定义的4个最重要的方法：</p>
<src>
<pre><code><br />
public abstract ZuulFilter implements IZuulFilter{<br />
​<br />
&nbsp;&nbsp; &nbsp;abstract public String filterType();<br />
​<br />
&nbsp;&nbsp; &nbsp;abstract public int filterOrder();<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;boolean shouldFilter();// 来自IZuulFilter<br />
​<br />
&nbsp;&nbsp; &nbsp;Object run() throws ZuulException;// IZuulFilter<br />
}</code></pre>

<ul>
<li><code>filterType</code>：返回字符串，代表过滤器的类型。包含以下4种：</li>
</ul>
<p><code>pre</code>：请求在被路由之前执行</p>
<p><code>route</code>：在路由请求时调用</p>
<p><code>post</code>：在routing和errror过滤器之后调用</p>
<p><code>error</code>：处理请求时发生错误调用</p>
<ul>
<li><code>filterOrder</code>：通过返回的int值来定义过滤器的执行顺序，数字越小优先级越高。</li>
<li><code>shouldFilter</code>：返回一个Boolean值，判断该过滤器run方法是否需要执行。返回true执行，返回false不执行。</li>
<li><code>run</code>：过滤器的具体业务逻辑</li>
</ul>
<p>&nbsp;</p>
<h3>8.&nbsp;&nbsp;&nbsp; 自定义过滤器</h3>
<p><strong>自定义过滤器只需要继承ZuulFilter</strong><strong>抽象类,</strong><strong>实现四个方法,</strong><strong>交给spring</strong><strong>管理</strong></p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="568">
<p>@Component</p>
<p>public class LoginFilter extends ZuulFilter {</p>
<p>&nbsp;&nbsp;&nbsp; @Override</p>
<p>&nbsp;&nbsp;&nbsp; public String filterType() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return FilterConstants.PRE_TYPE;</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp; @Override</p>
<p>&nbsp;&nbsp;&nbsp; public int filterOrder() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return FilterConstants.PRE_DECORATION_FILTER_ORDER - 1;</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp; @Override</p>
<p>&nbsp;&nbsp;&nbsp; public boolean shouldFilter() {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp; @Override</p>
<p>&nbsp;&nbsp;&nbsp; public Object run() throws ZuulException {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 获取请求上下文</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RequestContext ctx = RequestContext.getCurrentContext();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 获取request对象</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpServletRequest request = ctx.getRequest();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 获取请求参数</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String token = request.getParameter("access-token");</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 判断是否存在</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(StringUtils.isBlank(token)){</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 不存在，未登录，拦截</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctx.setSendZuulResponse(false);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 设置返回状态码</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctx.setResponseStatusCode(HttpStatus.UNAUTHORIZED.value());</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>}</p>
</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<h3>9.&nbsp;&nbsp;&nbsp; 负载均衡和熔断</h3>
<p>Zuul中默认就已经集成了Ribbon负载均衡和hystrix熔断机制。但是所有的超时策略都是走的默认值，比如熔断超时时间只有1S，很容易就触发了。因此建议我们手动进行配置：</p>
<src>
<pre><code><br />
hystrix:<br />
&nbsp; command:<br />
&nbsp;&nbsp;&nbsp; default:<br />
&nbsp;&nbsp; &nbsp;&nbsp; execution:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; isolation:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; thread:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; timeoutInMilliseconds: 6000<br />
ribbon:<br />
&nbsp; ConnectTimeout: 1000<br />
&nbsp; ReadTimeout: 2000<br />
&nbsp; MaxAutoRetries: 0<br />
&nbsp; MaxAutoRetriesNextServer: 1</code></pre>

<h3>10.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zuul的高可用</h3>
<p>启动多个Zuul服务，自动注册到Eureka，形成集群。如果是服务内部访问，你访问Zuul，自动负载均衡，没问题。</p>
<p>但是，Zuul更多是外部访问，PC端、移动端等。他们无法通过Eureka进行负载均衡，那么该怎么办？</p>
<p>此时，我们会使用其它的服务网关，来对Zuul进行代理。比如：Nginx</p>
<p>Eureka、Ribbon、hystrix、Feign、Zuul</p>
<p>spring-cloud-config：统一配置中心，自动去Git拉取最新的配置，缓存。使用Git的Webhook钩子，去通知配置中心，说配置发生了变化，配置中心会通过消息总线去通知所有的微服务，更新配置。</p>
<p>spring-cloud-bus：消息总线</p>
<p>Spring-cloud-stream：消息通信</p>
<p>spring-cloud-hystrix-dashboard：容错统计，形成图形化界面</p>
<p>spring-cloud-sleuth：链路追踪 结合Zipkin</p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>