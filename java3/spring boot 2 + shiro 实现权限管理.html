<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修spring boot 2 + shiro 实现权限管理' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>spring boot 2 + shiro 实现权限管理</center></div><div class='banquan'>原文出处:本文由博客园博主gdjlc提供。<br/>
原文连接:https://www.cnblogs.com/gdjlc/p/12057612.html</div><br>
    <p>Shiro是一个功能强大且易于使用的Java安全框架，主要功能有身份验证、授权、加密和会话管理。<br />看了网上一些文章，下面2篇文章写得不错。<br /><a href="https://www.cnblogs.com/asker009/p/9471712.html" target="_blank">Springboot2.0 集成shiro权限管理</a>&nbsp;<br /><a href="https://www.cnblogs.com/xifengxiaoma/p/11061142.html" target="_blank">Spring Boot：整合Shiro权限框架</a>&nbsp;</p>
<p>自己动手敲了下代码，在第一篇文章上加入了第二篇文章的Swagger测试，另外自己加入lombok简化实体类代码，一些地方代码也稍微修改了下，过程中也碰到一些问题，最终代码成功运行。</p>
<p><span style="color: #888888;">开发版本：</span><br /><span style="color: #888888;">IntelliJ IDEA 2019.2.2</span><br /><span style="color: #888888;">jdk1.8</span><br /><span style="color: #888888;">Spring Boot 2.1.11</span><br /><span style="color: #888888;">MySQL8.0</span></p>
<p><span style="font-size: 15px;"><strong>一、创建SpringBoot项目，添加依赖包和配置application.yml</strong></span></p>
<p>在IDEA中创建一个新的SpringBoot项目</p>
<p>1、pom.xml引用的依赖包如下：</p>
<src class="cnblogs_code">
<pre><code>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-web<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>

        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.apache.shiro<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>shiro-spring<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.4.2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>

        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.springframework.boot<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>spring-boot-starter-data-jpa<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>

        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>mysql<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>mysql-connector-java<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>

        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>org.projectlombok<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>lombok<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>1.18.10<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">scope</span><span style="color: #0000ff;">&gt;</span>provided<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">scope</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>

        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>io.springfox<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>springfox-swagger2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>2.9.2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>io.springfox<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">groupId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>springfox-swagger-ui<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">artifactId</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>2.9.2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">version</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">dependency</span><span style="color: #0000ff;">&gt;</span></code></pre>

<p>2、application.yml</p>
<src class="cnblogs_code">
<pre><code>spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/testdb?useSSL=false&amp;serverTimezone=UTC
    username: root
    password: 123456
  jpa:
    hibernate:
      ddl-auto: update #指定为update，每次启动项目检测表结构有变化的时候会新增字段，表不存在时会新建，如果指定create，则每次启动项目都会清空数据并删除表，再新建
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl #按字段名字建表
        #implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyJpaImpl #驼峰自动映射为下划线格式
    show-sql: true # 默认false，在日志里显示执行的sql语句
    database: mysql
    database-platform: org.hibernate.dialect.MySQL5InnoDBDialect</code></pre>

<p><strong style="font-size: 15px;">二、创建实体类</strong></p>
<p>创建User、Role、Permission三个实体类，根据规则会自动生成两个中间表，最终数据库有5个表。<br />另外添加一个model处理登录结果。</p>
<p>1、User</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.entity;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> lombok.Getter;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> lombok.Setter;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.format.annotation.DateTimeFormat;
</span><span style="color: #0000ff;">import</span> javax.persistence.*<span style="color: #000000;">;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.time.LocalDate;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.time.LocalDateTime;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;

@Entity
@Getter
@Setter
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> User {
    @Id
    @GeneratedValue(strategy </span>=<span style="color: #000000;"> GenerationType.AUTO)
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Long userId;

    @Column(nullable </span>= <span style="color: #0000ff;">false</span>, unique = <span style="color: #0000ff;">true</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span> String userName; <span style="color: #008000;">//</span><span style="color: #008000;">登录用户名</span>
<span style="color: #000000;">
    @Column(nullable </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span> String name;<span style="color: #008000;">//</span><span style="color: #008000;">名称（昵称或者真实姓名，根据实际情况定义）</span>
<span style="color: #000000;">
    @Column(nullable </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String password;

    </span><span style="color: #0000ff;">private</span> String salt;<span style="color: #008000;">//</span><span style="color: #008000;">加密密码的盐</span>

    <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">byte</span> state;<span style="color: #008000;">//</span><span style="color: #008000;">用户状态,0:创建未认证（比如没有激活，没有输入验证码等等）--等待验证的用户 , 1:正常状态,2：用户被锁定.</span>
<span style="color: #000000;">
    @ManyToMany(fetch</span>= FetchType.EAGER)<span style="color: #008000;">//</span><span style="color: #008000;">立即从数据库中进行加载数据;</span>
    @JoinTable(name = "UserRole", joinColumns = { @JoinColumn(name = "userId") }, inverseJoinColumns ={@JoinColumn(name = "roleId"<span style="color: #000000;">) })
    </span><span style="color: #0000ff;">private</span> List&lt;Role&gt; roleList;<span style="color: #008000;">//</span><span style="color: #008000;"> 一个用户具有多个角色</span>
<span style="color: #000000;">
    @DateTimeFormat(pattern </span>= "yyyy-MM-dd HH:mm"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span> LocalDateTime createTime;<span style="color: #008000;">//</span><span style="color: #008000;">创建时间</span>
<span style="color: #000000;">
    @DateTimeFormat(pattern </span>= "yyyy-MM-dd"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span> LocalDate expiredDate;<span style="color: #008000;">//</span><span style="color: #008000;">过期日期</span>

    <span style="color: #0000ff;">private</span><span style="color: #000000;"> String email;

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">密码盐. 重新对盐重新进行了定义，用户名+salt，这样就不容易被破解 </span><span style="color: #008000;">*/</span>
    <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getCredentialsSalt(){
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span>.userName+<span style="color: #0000ff;">this</span><span style="color: #000000;">.salt;
    }
}</span></code></pre>

<p><span style="color: #ff0000;">说明：</span><br /><span style="color: #ff0000;">这里使用@Getter,@Setter注解，不能使用@Data注解，因为实体使用了jpa的@oneToMany ，加载方式为lazy，在主表查询时关联表未加载，而主表使用@Data后会实现带关联表属性的hashCode和equals等方法。</span><span style="color: #ff0000;">在运行过程中调用关联表数据时会显示异常 java.lang.stackoverflowerror。</span></p>
<p>2、Role</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.entity;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> lombok.Getter;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> lombok.Setter;

</span><span style="color: #0000ff;">import</span> javax.persistence.*<span style="color: #000000;">;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;

@Entity
@Getter
@Setter
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Role {
    @Id
    @GeneratedValue(strategy </span>=<span style="color: #000000;"> GenerationType.AUTO)
    </span><span style="color: #0000ff;">private</span> Long roleId; <span style="color: #008000;">//</span><span style="color: #008000;"> 编号</span>
<span style="color: #000000;">
    @Column(nullable </span>= <span style="color: #0000ff;">false</span>, unique = <span style="color: #0000ff;">true</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span> String role; <span style="color: #008000;">//</span><span style="color: #008000;"> 角色标识程序中判断使用,如"admin",这个是唯一的:</span>

    <span style="color: #0000ff;">private</span> String description; <span style="color: #008000;">//</span><span style="color: #008000;"> 角色描述,UI界面显示使用</span>

    <span style="color: #0000ff;">private</span> Boolean available = Boolean.TRUE; <span style="color: #008000;">//</span><span style="color: #008000;"> 是否可用,如果不可用将不会添加给用户

    </span><span style="color: #008000;">//</span><span style="color: #008000;">角色 -- 权限关系：多对多关系;</span>
    @ManyToMany(fetch=<span style="color: #000000;"> FetchType.EAGER)
    @JoinTable(name</span>="RolePermission",joinColumns={@JoinColumn(name="roleId")},inverseJoinColumns={@JoinColumn(name="permissionId"<span style="color: #000000;">)})
    </span><span style="color: #0000ff;">private</span> List&lt;Permission&gt;<span style="color: #000000;"> permissions;

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 用户 - 角色关系定义;</span>
<span style="color: #000000;">    @ManyToMany
    @JoinTable(name</span>="UserRole",joinColumns={@JoinColumn(name="roleId")},inverseJoinColumns={@JoinColumn(name="userId"<span style="color: #000000;">)})
    </span><span style="color: #0000ff;">private</span> List&lt;User&gt; users;<span style="color: #008000;">//</span><span style="color: #008000;"> 一个角色对应多个用户</span>
}</code></pre>

<p>3、Permission</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.entity;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> lombok.Getter;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> lombok.Setter;

</span><span style="color: #0000ff;">import</span> javax.persistence.*<span style="color: #000000;">;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;

@Entity
@Getter
@Setter
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Permission {
    @Id
    @GeneratedValue(strategy </span>=<span style="color: #000000;"> GenerationType.AUTO)
    </span><span style="color: #0000ff;">private</span> Long permissionId;<span style="color: #008000;">//</span><span style="color: #008000;">主键.</span>
<span style="color: #000000;">
    @Column(nullable </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span> String permissionName;<span style="color: #008000;">//</span><span style="color: #008000;">名称.</span>
<span style="color: #000000;">
    @Column(columnDefinition</span>="enum('menu','button')"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">private</span> String resourceType;<span style="color: #008000;">//</span><span style="color: #008000;">资源类型，[menu|button]</span>

    <span style="color: #0000ff;">private</span> String url;<span style="color: #008000;">//</span><span style="color: #008000;">资源路径.</span>

    <span style="color: #0000ff;">private</span> String permission; <span style="color: #008000;">//</span><span style="color: #008000;">权限字符串,menu例子：role:*，button例子：role:create,role:update,role:delete,role:view</span>

    <span style="color: #0000ff;">private</span> Long parentId; <span style="color: #008000;">//</span><span style="color: #008000;">父编号</span>

    <span style="color: #0000ff;">private</span> String parentIds; <span style="color: #008000;">//</span><span style="color: #008000;">父编号列表</span>

    <span style="color: #0000ff;">private</span> Boolean available =<span style="color: #000000;"> Boolean.TRUE;

    </span><span style="color: #008000;">//</span><span style="color: #008000;">角色 -- 权限关系：多对多关系;</span>
    @ManyToMany(fetch=<span style="color: #000000;"> FetchType.EAGER)
    @JoinTable(name</span>="RolePermission",joinColumns={@JoinColumn(name="permissionId")},inverseJoinColumns={@JoinColumn(name="roleId"<span style="color: #000000;">)})
    </span><span style="color: #0000ff;">private</span> List&lt;Role&gt;<span style="color: #000000;"> roles;
}</span></code></pre>

<p>4、LoginResult</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.model;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> lombok.Data;

@Data
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> LoginResult {
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isLogin = <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String result;
}</span></code></pre>

<p><strong style="font-size: 15px;">三、DAO</strong></p>
<p>1、添加一个DAO基础接口：BaseRepository</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.repository;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.data.jpa.repository.JpaSpecificationExecutor;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.data.repository.NoRepositoryBean;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.data.repository.PagingAndSortingRepository;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.Serializable;

@NoRepositoryBean
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span> BaseRepository&lt;T, I <span style="color: #0000ff;">extends</span> Serializable&gt; <span style="color: #0000ff;">extends</span> PagingAndSortingRepository&lt;T, I&gt;, JpaSpecificationExecutor&lt;T&gt;<span style="color: #000000;"> {
}</span></code></pre>

<p>2、UserRepository</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.repository;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.entity.User;

</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span> UserRepository <span style="color: #0000ff;">extends</span> BaseRepository&lt;User,Long&gt;<span style="color: #000000;"> {
    User findByUserName(String userName);
}</span></code></pre>

<p><strong style="font-size: 15px;">四、Service</strong></p>
<p>1、LoginService</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.service;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.model.LoginResult;

</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> LoginService {

    LoginResult login(String userName, String password);

    </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> logout();
}</span></code></pre>

<p>2、UserService</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.service;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.entity.User;

</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> UserService {
    User findByUserName(String userName);
}</span></code></pre>

<p><strong style="font-size: 15px;">五、Service.impl</strong></p>
<p>1、LoginServiceImpl</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.service.impl;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.model.LoginResult;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.repository.UserRepository;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.service.LoginService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.SecurityUtils;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authc.AuthenticationException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authc.IncorrectCredentialsException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authc.UnknownAccountException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authc.UsernamePasswordToken;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.session.Session;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.subject.Subject;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.stereotype.Service;

@Service
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> LoginServiceImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> LoginService {

    @Override
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> LoginResult login(String userName, String password) {
        LoginResult loginResult </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> LoginResult();
        </span><span style="color: #0000ff;">if</span> (userName == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> userName.isEmpty()) {
            loginResult.setLogin(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
            loginResult.setResult(</span>"用户名为空"<span style="color: #000000;">);
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> loginResult;
        }
        String msg </span>= ""<span style="color: #000000;">;
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 1、获取Subject实例对象</span>
        Subject currentUser =<span style="color: #000000;"> SecurityUtils.getSubject();

</span><span style="color: #008000;">//</span>        <span style="color: #008000;">//</span><span style="color: #008000;"> 2、判断当前用户是否登录
</span><span style="color: #008000;">//</span><span style="color: #008000;">        if (currentUser.isAuthenticated() == false) {
</span><span style="color: #008000;">//</span>
<span style="color: #008000;">//</span><span style="color: #008000;">        }

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 3、将用户名和密码封装到UsernamePasswordToken</span>
        UsernamePasswordToken token = <span style="color: #0000ff;">new</span><span style="color: #000000;"> UsernamePasswordToken(userName, password);

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 4、认证</span>
        <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            currentUser.login(token);</span><span style="color: #008000;">//</span><span style="color: #008000;"> 传到MyAuthorizingRealm类中的方法进行认证</span>
            Session session =<span style="color: #000000;"> currentUser.getSession();
            session.setAttribute(</span>"userName"<span style="color: #000000;">, userName);
            loginResult.setLogin(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> loginResult;
            </span><span style="color: #008000;">//</span><span style="color: #008000;">return "/index";</span>
        } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (UnknownAccountException e) {
            e.printStackTrace();
            msg </span>= "UnknownAccountException -- &gt; 账号不存在："<span style="color: #000000;">;
        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IncorrectCredentialsException e) {
            msg </span>= "IncorrectCredentialsException -- &gt; 密码不正确："<span style="color: #000000;">;
        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (AuthenticationException e) {
            e.printStackTrace();
            msg </span>= "用户验证失败"<span style="color: #000000;">;
        }

        loginResult.setLogin(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
        loginResult.setResult(msg);

        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> loginResult;
    }

    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> logout() {
        Subject subject </span>=<span style="color: #000000;"> SecurityUtils.getSubject();
        subject.logout();
    }
}</span></code></pre>

<p>2、UserServiceImpl</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.service.impl;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.entity.User;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.repository.UserRepository;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.service.UserService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.stereotype.Service;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.annotation.Resource;

@Service
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> UserServiceImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> UserService {
    @Resource
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> UserRepository userRepository;
    @Override
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> User findByUserName(String userName) {
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> userRepository.findByUserName(userName);
    }
}</span></code></pre>

<p><strong style="font-size: 15px;">六、config配置类</strong></p>
<p>1、创建Realm</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.config;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.entity.Permission;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.entity.Role;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.entity.User;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.service.UserService;
</span><span style="color: #0000ff;">import</span> org.apache.shiro.authc.*<span style="color: #000000;">;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authz.AuthorizationInfo;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authz.SimpleAuthorizationInfo;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.realm.AuthorizingRealm;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.subject.PrincipalCollection;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.util.ByteSource;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.annotation.Resource;

</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MyShiroRealm <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AuthorizingRealm {
    @Resource
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> UserService userService;

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 身份认证:验证用户输入的账号和密码是否正确。
     * </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">protected</span> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> AuthenticationException {
        </span><span style="color: #008000;">//</span><span style="color: #008000;">获取用户输入的账号</span>
        String userName =<span style="color: #000000;"> (String) token.getPrincipal();
        </span><span style="color: #008000;">//</span><span style="color: #008000;">通过username从数据库中查找 User对象.
        </span><span style="color: #008000;">//</span><span style="color: #008000;">实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span>
        User user =<span style="color: #000000;"> userService.findByUserName(userName);
        </span><span style="color: #0000ff;">if</span> (user == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;
        }
        SimpleAuthenticationInfo authenticationInfo </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> SimpleAuthenticationInfo(
                user,</span><span style="color: #008000;">//</span><span style="color: #008000;">这里传入的是user对象，比对的是用户名，直接传入用户名也没错，但是在授权部分就需要自己重新从数据库里取权限</span>
                user.getPassword(),<span style="color: #008000;">//</span><span style="color: #008000;">密码</span>
                ByteSource.Util.bytes(user.getCredentialsSalt()),<span style="color: #008000;">//</span><span style="color: #008000;">salt=username+salt</span>
                getName()<span style="color: #008000;">//</span><span style="color: #008000;">realm name</span>
<span style="color: #000000;">        );
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> authenticationInfo;
    }

    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 权限信息
     * </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    @Override
    </span><span style="color: #0000ff;">protected</span><span style="color: #000000;"> AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {
        SimpleAuthorizationInfo authorizationInfo </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> SimpleAuthorizationInfo();
        </span><span style="color: #008000;">//</span><span style="color: #008000;">如果身份认证的时候没有传入User对象，这里只能取到userName
        </span><span style="color: #008000;">//</span><span style="color: #008000;">也就是SimpleAuthenticationInfo构造的时候第一个参数传递需要User对象</span>
        User user  =<span style="color: #000000;"> (User)principals.getPrimaryPrincipal();
        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(Role role : user.getRoleList()){
            </span><span style="color: #008000;">//</span><span style="color: #008000;">添加角色</span>
<span style="color: #000000;">            authorizationInfo.addRole(role.getRole());
            </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(Permission p:role.getPermissions()){
                </span><span style="color: #008000;">//</span><span style="color: #008000;">添加权限</span>
<span style="color: #000000;">                authorizationInfo.addStringPermission(p.getPermission());
            }
        }
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> authorizationInfo;
    }

}</span></code></pre>

<p>2、配置Shiro</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.config;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authc.credential.HashedCredentialsMatcher;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.spring.web.ShiroFilterFactoryBean;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.web.mgt.DefaultWebSecurityManager;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.context.annotation.Bean;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.context.annotation.Configuration;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.servlet.handler.SimpleMappingExceptionResolver;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Properties;

@Configuration
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ShiroConfig {
    </span><span style="color: #008000;">//</span><span style="color: #008000;">将自己的验证方式加入容器</span>
<span style="color: #000000;">    @Bean
    MyShiroRealm myShiroRealm() {
        MyShiroRealm myShiroRealm </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> MyShiroRealm();
        myShiroRealm.setCredentialsMatcher(hashedCredentialsMatcher());
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> myShiroRealm;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;">权限管理，配置主要是Realm的管理认证</span>
<span style="color: #000000;">    @Bean
    DefaultWebSecurityManager securityManager() {
        DefaultWebSecurityManager manager </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultWebSecurityManager();
        manager.setRealm(myShiroRealm());
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> manager;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;">凭证匹配器（密码校验交给Shiro的SimpleAuthenticationInfo进行处理)</span>
<span style="color: #000000;">    @Bean
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> HashedCredentialsMatcher hashedCredentialsMatcher(){
        HashedCredentialsMatcher hashedCredentialsMatcher </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> HashedCredentialsMatcher();
        hashedCredentialsMatcher.setHashAlgorithmName(</span>"md5");<span style="color: #008000;">//</span><span style="color: #008000;">散列算法:这里使用MD5算法;</span>
        hashedCredentialsMatcher.setHashIterations(2);<span style="color: #008000;">//</span><span style="color: #008000;">散列的次数，比如散列两次，相当于 md5(md5(""));</span>
        <span style="color: #0000ff;">return</span><span style="color: #000000;"> hashedCredentialsMatcher;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Filter工厂，设置对应的过滤条件和跳转条件</span>
<span style="color: #000000;">    @Bean
    ShiroFilterFactoryBean shiroFilterFactoryBean() {
        ShiroFilterFactoryBean bean </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> ShiroFilterFactoryBean();
        bean.setSecurityManager(securityManager());
        Map</span>&lt;String, String&gt; filterMap = <span style="color: #0000ff;">new</span> HashMap&lt;String, String&gt;<span style="color: #000000;">();
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 登出</span>
        filterMap.put("/logout", "logout"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> swagger</span>
        filterMap.put("/swagger**/**", "anon"<span style="color: #000000;">);
        filterMap.put(</span>"/webjars/**", "anon"<span style="color: #000000;">);
        filterMap.put(</span>"/v2/**", "anon"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 对所有用户认证</span>
        filterMap.put("/**", "authc"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 登录</span>
        bean.setLoginUrl("/login"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 首页</span>
        bean.setSuccessUrl("/index"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 未授权页面，认证不通过跳转</span>
        bean.setUnauthorizedUrl("/403"<span style="color: #000000;">);
        bean.setFilterChainDefinitionMap(filterMap);      
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> bean;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;">开启shiro aop注解支持.</span>
<span style="color: #000000;">    @Bean
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(){
        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> AuthorizationAttributeSourceAdvisor();
        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager());
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> authorizationAttributeSourceAdvisor;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;">shiro注解模式下，登录失败或者是没有权限都是抛出异常，并且默认的没有对异常做处理，配置一个异常处理</span>
    @Bean(name="simpleMappingExceptionResolver"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> SimpleMappingExceptionResolver
    createSimpleMappingExceptionResolver() {
        SimpleMappingExceptionResolver r </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> SimpleMappingExceptionResolver();
        Properties mappings </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Properties();
        mappings.setProperty(</span>"DatabaseException", "databaseError");<span style="color: #008000;">//</span><span style="color: #008000;">数据库异常处理</span>
        mappings.setProperty("UnauthorizedException","/403"<span style="color: #000000;">);
        r.setExceptionMappings(mappings);  </span><span style="color: #008000;">//</span><span style="color: #008000;"> None by default</span>
        r.setDefaultErrorView("error");    <span style="color: #008000;">//</span><span style="color: #008000;"> No default</span>
        r.setExceptionAttribute("exception");     <span style="color: #008000;">//</span><span style="color: #008000;"> Default is "exception"</span>
        <span style="color: #0000ff;">return</span><span style="color: #000000;"> r;
    }
}</span></code></pre>

<p>3、配置swagger</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.config;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> io.swagger.annotations.ApiOperation;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.context.annotation.Bean;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.context.annotation.Configuration;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.builders.ApiInfoBuilder;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.builders.PathSelectors;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.builders.RequestHandlerSelectors;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.service.ApiInfo;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.service.Contact;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.spi.DocumentationType;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.spring.web.plugins.Docket;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> springfox.documentation.swagger2.annotations.EnableSwagger2;

@Configuration
@EnableSwagger2
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> SwaggerConfig {
    @Bean
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Docket api() {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Docket(DocumentationType.SWAGGER_2)
                .apiInfo(apiInfo())
                .select()
                .apis(RequestHandlerSelectors.any())
                .paths(PathSelectors.any()).build();
    }
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> ApiInfo apiInfo() {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ApiInfoBuilder()
                .title(</span>"API文档"<span style="color: #000000;">)
                .description(</span>"Swagger API 文档"<span style="color: #000000;">)
                .version(</span>"1.0"<span style="color: #000000;">)
                .contact(</span><span style="color: #0000ff;">new</span> Contact("name..", "url..", "email.."<span style="color: #000000;">))
                .build();
    }
}</span></code></pre>

<p><strong style="font-size: 15px;">七、controller</strong></p>
<p>1、LoginController用来处理登录</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.controller;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.entity.User;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.model.LoginResult;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.example.shiro.service.LoginService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.GetMapping;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.PostMapping;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.RequestBody;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.RestController;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.annotation.Resource;

@RestController
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> LoginController {
    @Resource
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> LoginService loginService;

    @GetMapping(value </span>= "/login"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String login() {
        </span><span style="color: #0000ff;">return</span> "登录页"<span style="color: #000000;">;
    }

    @PostMapping(value </span>= "/login"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String login(@RequestBody User user) {
        System.out.println(</span>"login()"<span style="color: #000000;">);
        String userName </span>=<span style="color: #000000;"> user.getUserName();
        String password </span>=<span style="color: #000000;"> user.getPassword();
        LoginResult loginResult </span>=<span style="color: #000000;"> loginService.login(userName,password);
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;">(loginResult.isLogin()){
            </span><span style="color: #0000ff;">return</span> "登录成功"<span style="color: #000000;">;
        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
            </span><span style="color: #0000ff;">return</span> "登录失败：" +<span style="color: #000000;"> loginResult.getResult();
        }
    }

    @GetMapping(value </span>= "/index"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String index() {
        </span><span style="color: #0000ff;">return</span> "主页"<span style="color: #000000;">;
    }

    @GetMapping(value </span>= "/logout"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String logout() {
        </span><span style="color: #0000ff;">return</span> "退出"<span style="color: #000000;">;
    }

    @GetMapping(</span>"/403"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String unauthorizedRole(){
        </span><span style="color: #0000ff;">return</span> "没有权限"<span style="color: #000000;">;
    }
}</span></code></pre>

<p>2、UserController用来测试访问，权限全部采用注解的方式。</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.example.shiro.controller;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.shiro.authz.annotation.RequiresPermissions;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.GetMapping;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.RequestMapping;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping(</span>"/user"<span style="color: #000000;">)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> UserController {
    </span><span style="color: #008000;">//</span><span style="color: #008000;">用户查询</span>
    @GetMapping("/userList"<span style="color: #000000;">)
    @RequiresPermissions(</span>"user:view")<span style="color: #008000;">//</span><span style="color: #008000;">权限管理;</span>
    <span style="color: #0000ff;">public</span><span style="color: #000000;"> String userInfo(){
        </span><span style="color: #0000ff;">return</span> "userList"<span style="color: #000000;">;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;">用户添加</span>
    @GetMapping("/userAdd"<span style="color: #000000;">)
    @RequiresPermissions(</span>"user:add")<span style="color: #008000;">//</span><span style="color: #008000;">权限管理;</span>
    <span style="color: #0000ff;">public</span><span style="color: #000000;"> String userInfoAdd(){
        </span><span style="color: #0000ff;">return</span> "userAdd"<span style="color: #000000;">;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;">用户删除</span>
    @GetMapping("/userDel"<span style="color: #000000;">)
    @RequiresPermissions(</span>"user:del")<span style="color: #008000;">//</span><span style="color: #008000;">权限管理;</span>
    <span style="color: #0000ff;">public</span><span style="color: #000000;"> String userDel(){
        </span><span style="color: #0000ff;">return</span> "userDel"<span style="color: #000000;">;
    }
}</span></code></pre>

<p><strong style="font-size: 15px;">八、数据库预设一些数据</strong></p>
<p>先运行一遍程序，JPA生成数据库表后，手工执行sql脚本插入样本数据。<br />用户admin的原始密码是123456。</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span> `<span style="color: #ff00ff;">user</span><span style="color: #000000;">` (`userId`,`username`,`name`,`password`,`salt`,`state`)
</span><span style="color: #0000ff;">VALUES</span> (<span style="color: #ff0000;">'</span><span style="color: #ff0000;">1</span><span style="color: #ff0000;">'</span>, <span style="color: #ff0000;">'</span><span style="color: #ff0000;">admin</span><span style="color: #ff0000;">'</span>, <span style="color: #ff0000;">'</span><span style="color: #ff0000;">管理员</span><span style="color: #ff0000;">'</span>, <span style="color: #ff0000;">'</span><span style="color: #ff0000;">d3c59d25033dbf980d29554025c23a75</span><span style="color: #ff0000;">'</span>, <span style="color: #ff0000;">'</span><span style="color: #ff0000;">8d78869f470951332959580424d4bf4f</span><span style="color: #ff0000;">'</span>, <span style="color: #800000; font-weight: bold;">1</span><span style="color: #000000;">);

</span><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span><span style="color: #000000;"> `permission` (`permissionId`,`available`,`permissionname`,`parentid`,`parentids`,`permission`,`resourcetype`,`url`)
</span><span style="color: #0000ff;">VALUES</span> (<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">用户管理</span><span style="color: #ff0000;">'</span>,<span style="color: #800000; font-weight: bold;">0</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">0/</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">user:view</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">menu</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">user/userList</span><span style="color: #ff0000;">'</span><span style="color: #000000;">);
</span><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span><span style="color: #000000;"> `permission` (`permissionId`,`available`,`permissionname`,`parentid`,`parentids`,`permission`,`resourcetype`,`url`)
</span><span style="color: #0000ff;">VALUES</span> (<span style="color: #800000; font-weight: bold;">2</span>,<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">用户添加</span><span style="color: #ff0000;">'</span>,<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">0/1</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">user:add</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">button</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">user/userAdd</span><span style="color: #ff0000;">'</span><span style="color: #000000;">);
</span><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span><span style="color: #000000;"> `permission` (`permissionId`,`available`,`permissionname`,`parentid`,`parentids`,`permission`,`resourcetype`,`url`)
</span><span style="color: #0000ff;">VALUES</span> (<span style="color: #800000; font-weight: bold;">3</span>,<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">用户删除</span><span style="color: #ff0000;">'</span>,<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">0/1</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">user:del</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">button</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">user/userDel</span><span style="color: #ff0000;">'</span><span style="color: #000000;">);

</span><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span> `role` (`roleid`,`available`,`description`,`role`) <span style="color: #0000ff;">VALUES</span> (<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">管理员</span><span style="color: #ff0000;">'</span>,<span style="color: #ff0000;">'</span><span style="color: #ff0000;">admin</span><span style="color: #ff0000;">'</span><span style="color: #000000;">);

</span><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span> `rolepermission` (`permissionid`,`roleid`) <span style="color: #0000ff;">VALUES</span> (<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #800000; font-weight: bold;">1</span><span style="color: #000000;">);
</span><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span> `rolepermission` (`permissionid`,`roleid`) <span style="color: #0000ff;">VALUES</span> (<span style="color: #800000; font-weight: bold;">2</span>,<span style="color: #800000; font-weight: bold;">1</span><span style="color: #000000;">);

</span><span style="color: #0000ff;">INSERT</span> <span style="color: #0000ff;">INTO</span> `userrole` (`roleid`,`userId`) <span style="color: #0000ff;">VALUES</span> (<span style="color: #800000; font-weight: bold;">1</span>,<span style="color: #800000; font-weight: bold;">1</span>);</code></pre>

<p><strong style="font-size: 15px;">九、swagger测试</strong></p>
<p>&nbsp;1、启动项目，访问http://localhost:8080/swagger-ui.html</p>
<p><img src="./images/spring boot 2 + shiro 实现权限管理0.png" alt="" width="780" height="414" /></p>
<p>&nbsp;&nbsp;2、访问/user/userAdd，&nbsp;Response body显示登录页</p>
<p><img src="./images/spring boot 2 + shiro 实现权限管理1.png" alt="" width="787" height="399" /></p>
<p>&nbsp;3、访问POST的/login，请求参数输入：</p>
<src class="cnblogs_code">
<pre><code>{
"userName": "admin",
"password": "123456"
}</code></pre>

<p><img src="./images/spring boot 2 + shiro 实现权限管理2.png" alt="" width="811" height="276" /></p>
<p>&nbsp;Response body显示登录成功。</p>
<p><img src="./images/spring boot 2 + shiro 实现权限管理3.png" alt="" width="811" height="463" /></p>
<p>&nbsp;4、再次访问/user/userAdd，因为登录成功了并且有权限，这次Response body显示userAdd</p>
<p>&nbsp;<img src="./images/spring boot 2 + shiro 实现权限管理4.png" alt="" width="832" height="200" /></p>
<p>&nbsp;5、访问/user/userDel，因为数据库没有配置权限，所以Response body显示没有权限</p>
<p><img src="./images/spring boot 2 + shiro 实现权限管理5.png" alt="" width="838" height="221" /></p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>